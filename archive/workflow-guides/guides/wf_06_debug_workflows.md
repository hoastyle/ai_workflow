---
title: "wf_06_debug 工作流指南"
description: "系统化调试流程的详细执行指南、决策树和标准输出模板"
type: "技术设计"
status: "完成"
priority: "高"
created_date: "2025-12-12"
last_updated: "2025-12-12"
related_documents:
  - "../../wf_06_debug.md"
  - "../command_consistency_strategy.md"
  - "wf_04_ask_workflows.md"
related_code: []
---

# wf_06_debug 工作流指南

本文档提供 `/wf_06_debug` 命令的详细执行流程和标准化输出模板，确保AI调试过程的一致性和成功率。

---

## 🤖 AI执行协议（强制）

**本节为AI执行的强制规范，必须严格遵循，不得跳过或自行解释**

### 核心原则

1. **强制读取**: AI必须首先读取本文档的关键章节
2. **严格遵循**: 所有步骤按顺序执行，不得合并或跳过
3. **标准输出**: 必须使用本文档提供的输出模板
4. **检查验证**: 完成前必须通过所有检查清单项
5. **避免盲目修复**: 必须理解根本原因，而非仅修复症状

### 执行流程概览

```
Step 0: Confidence Check（信心评估）
  ↓
Step 1: 模式选择（根据决策树）
  ├─ Quick Fix Mode (--quick) → 快速修复流程
  ├─ Standard Debugging (默认) → 标准调试流程
  └─ Deep Analysis (--think --deep) → 深度分析流程
  ↓
Step 2-7: 按选定模式执行（详见下文）
  ↓
Final: 输出调试报告（使用标准模板）
```

---

## 🎯 模式选择决策树（强制使用）

**AI必须根据以下决策树选择唯一的调试模式**：

```
检查用户是否提供了明确的模式标志？
│
├─ YES (用户提供了标志)
│  ├─ --quick → 使用 Quick Fix Mode
│  ├─ --think → 使用 Standard + Sequential-thinking MCP
│  ├─ --deep → 使用 Standard + Serena MCP
│  └─ --think --deep → 使用 Deep Analysis Mode (组合)
│
└─ NO (用户未提供标志，AI需要基于 Confidence Check 判断)
   │
   ├─ Confidence ≥ 90%?
   │  └─ YES → Quick Fix Mode（错误清晰且常见）
   │
   ├─ 70% ≤ Confidence < 90%?
   │  └─ YES → Standard Debugging（需要系统化分析）
   │
   └─ Confidence < 70%?
      └─ YES → Deep Analysis Mode（复杂问题，需要深度诊断）
```

**模式特征**:

| 模式 | 适用场景 | MCP 增强 | 预期时间 | 成功率 |
|------|---------|---------|---------|--------|
| **Quick Fix** | 简单错误（依赖、语法、配置） | 无 | 5-10分钟 | >95% |
| **Standard** | 一般错误（逻辑、运行时、网络） | 可选 --think | 20-40分钟 | >85% |
| **Deep Analysis** | 复杂错误（偶发、系统级、性能） | --think + --deep | 40-90分钟 | >70% |

---

## 📋 Quick Fix Mode 执行流程

**适用条件**:
- ✅ 错误信息明确（如 ImportError, SyntaxError, FileNotFoundError）
- ✅ 属于常见错误类型
- ✅ 修复范围有限（单文件、单配置）
- ✅ Confidence ≥ 90%

### Step 1: 快速识别错误类型

**常见错误分类**:
```
1. 依赖问题
   - ImportError: No module named 'xxx' → pip install xxx
   - ModuleNotFoundError → 检查 requirements.txt 或 package.json

2. 语法错误
   - SyntaxError → 检查代码格式和拼写
   - IndentationError → 修复缩进

3. 配置错误
   - FileNotFoundError → 检查文件路径和权限
   - PermissionError → chmod 或 sudo

4. 环境变量
   - KeyError/EnvironmentError → 检查 .env 文件
```

### Step 2: 应用快速修复

**执行方式**:
1. 直接修复明确的问题（安装依赖、修复语法、更新配置）
2. 验证修复（重新运行原始命令）
3. 如果成功 → 输出简化报告
4. 如果失败 → 升级到 Standard Mode

### 输出模板：Quick Fix 成功

```markdown
## 🔧 调试报告（Quick Fix）

**错误类型**: [依赖/语法/配置/...]
**根本原因**: [一句话说明原因]

**应用的修复**:
```bash
[实际执行的命令]
```

**验证结果**: ✅ 问题已解决

**预防措施**: [如何避免类似问题]
```

---

## 📋 Standard Debugging 执行流程

**适用条件**:
- ✅ 错误需要系统化分析
- ✅ 70% ≤ Confidence < 90%
- ✅ Quick Fix 升级而来

### Step 1: 错误深度分析

**执行方式**:
```bash
# 1. 读取完整的错误输出
[完整的terminal输出，包括堆栈跟踪]

# 2. 查阅已知问题
检查 KNOWLEDGE.md § 常见问题
检查 TASK.md § 相关任务的问题记录
```

**分析维度**:
- 错误类型和严重程度
- 文件位置和行号
- 堆栈跟踪的关键路径
- 触发条件和环境

### Step 2: 研究和调查

**使用 MCP 工具**（可选）:
```python
# 如果启用 --think
# 使用 Sequential-thinking MCP 进行结构化推理
```

**调查清单**:
- [ ] 查阅官方文档（使用 context7 MCP 或 WebSearch）
- [ ] 检查 PLANNING.md 相关架构设计
- [ ] 查看相关代码文件（使用 Serena MCP 定位）
- [ ] 搜索类似问题的解决方案

### Step 3: 系统化分析

**四步分析法**:
1. **Analyzer**: 在系统架构中定位错误
2. **Inspector**: 追踪代码执行路径
3. **Checker**: 验证配置和规范一致性
4. **Strategist**: 设计修复方案

### Step 4: 解决方案实施

**修复原则**:
- ✅ 解决根本原因，而非症状
- ✅ 最小化修改范围
- ✅ 遵循项目编码标准
- ✅ 保留原始状态备份

### Step 5: 验证和迭代

**验证流程**:
```bash
# 1. 重新运行原始命令
[原始触发错误的命令]

# 2. 检查新错误（如果有）
If 新错误出现:
  → 重复 Step 1-4 (使用新错误信息)

# 3. 验证功能完整性
[相关功能的测试命令]
```

### Step 6: 文档化

**更新文档**:
- TASK.md: 记录修复详情和根本原因
- KNOWLEDGE.md: 如果是新模式，添加到已知问题
- PLANNING.md: 如果是系统性问题，更新架构说明

### 输出模板：Standard Debugging 成功

```markdown
## 🔧 调试报告（Standard）

### 错误分析
**错误类型**: [分类]
**文件位置**: [文件:行号]
**根本原因**: [详细分析]

**堆栈跟踪关键路径**:
```
[简化的堆栈跟踪]
```

### 解决方案
**修复方案**: [说明]
**修改文件**: [列出修改的文件]
**关键修改**:
```diff
[关键代码变更的 diff]
```

### 验证结果
- ✅ 原始错误已解决
- ✅ 无新错误引入
- ✅ 相关功能正常

### 文档更新
- [x] TASK.md 已更新
- [x] KNOWLEDGE.md 已记录（如适用）

### 预防措施
[具体的预防建议]
```

---

## 📋 Deep Analysis Mode 执行流程

**适用条件**:
- ✅ Confidence < 70%
- ✅ 偶发性错误或难以复现
- ✅ 系统级别或性能问题
- ✅ 用户明确请求 --think --deep

### Step 1: 信息收集（扩展）

**收集清单**:
- [ ] 完整的系统日志和堆栈跟踪
- [ ] 环境状态（内存、CPU、磁盘、网络）
- [ ] 复现步骤和触发条件
- [ ] 相关的系统事件记录
- [ ] 历史数据和趋势

### Step 2: 深度代码分析

**使用 Serena MCP** (--deep):
```python
# 获取符号级别的代码理解
get_symbols_overview(file_path)

# 定位错误相关的函数和类
find_symbol(name_path_pattern)

# 分析代码依赖关系
[代码关系分析]
```

### Step 3: 结构化推理

**使用 Sequential-thinking MCP** (--think):
```
启动多步推理过程：
1. 问题假设生成
2. 证据收集和验证
3. 假设排除
4. 根本原因定位
5. 解决方案设计
```

### Step 4: 多方案评估

**方案对比**:
| 方案 | 优势 | 劣势 | 风险 | 推荐度 |
|------|------|------|------|--------|
| 方案A | ... | ... | ... | ⭐⭐⭐ |
| 方案B | ... | ... | ... | ⭐⭐ |

### Step 5: 实施和监控

**实施步骤**:
1. 应用选定方案
2. 部署监控（日志、指标）
3. 验证修复效果
4. 观察一段时间（如果是偶发问题）

### 输出模板：Deep Analysis 成功

```markdown
## 🔬 调试报告（Deep Analysis）

### 问题复杂度分析
**问题类型**: [偶发/系统级/性能/...]
**影响范围**: [描述]
**复现难度**: [容易/中等/困难]

### 深度分析过程

#### 1. 信息收集
- 收集的数据：[列出]
- 关键发现：[列出]

#### 2. 假设和验证
**假设1**: [描述]
- 证据: [支持/反驳]
- 结论: [...]

**假设2**: [描述]
- 证据: [支持/反驳]
- 结论: [...]

#### 3. 根本原因
**确定的根因**: [详细说明]
**支持证据**: [列出]

### 解决方案评估

#### 推荐方案（⭐⭐⭐）
**说明**: [...]
**优势**: [...]
**实施步骤**: [...]

#### 备选方案（⭐⭐）
**说明**: [...]
**适用场景**: [如果推荐方案失败]

### 实施结果
- ✅ 方案已应用
- ✅ 监控已部署
- ⏳ 观察期：[X天/周]

### 长期改进建议
[架构改进、流程优化、工具引入等]
```

---

## ✅ 执行检查清单（AI必须验证）

在输出调试报告前，AI必须确认以下所有项目：

### 通用检查项
- [ ] ✅ 已读取本工作流指南的"AI执行协议"部分
- [ ] ✅ 已根据决策树选择正确的调试模式
- [ ] ✅ 已执行 Confidence Check 并记录信心水平
- [ ] ✅ 已完整阅读错误输出和堆栈跟踪
- [ ] ✅ 输出格式符合对应模式的标准模板
- [ ] ✅ 遵循CLAUDE.md语言规范

### 模式特定检查项

**Quick Fix Mode**:
- [ ] ✅ 确认错误属于常见类型
- [ ] ✅ 已验证修复成功（重新运行原始命令）
- [ ] ✅ 提供预防措施

**Standard Debugging**:
- [ ] ✅ 已进行系统化分析（四步分析法）
- [ ] ✅ 理解根本原因（而非仅修复症状）
- [ ] ✅ 已验证无新错误引入
- [ ] ✅ 已更新相关文档

**Deep Analysis**:
- [ ] ✅ 已收集完整的诊断信息
- [ ] ✅ 已使用结构化推理（如果启用 --think）
- [ ] ✅ 已评估多个解决方案
- [ ] ✅ 已部署监控（如果适用）

**如果任何检查项未通过，必须重新执行对应步骤**

---

## 🔄 后续工作流路径

完成调试后，根据情况选择下一步：

| 场景 | 推荐命令 | 说明 |
|------|---------|------|
| 快速修复成功 | `/wf_11_commit` | 提交修复，更新 CONTEXT.md |
| 标准调试成功 | `/wf_07_test` → `/wf_11_commit` | 添加回归测试，然后提交 |
| 深度分析完成 | `/wf_08_review` → `/wf_07_test` → `/wf_11_commit` | 审查修复，测试，提交 |
| 修复失败 | `/wf_04_ask "调试问题..."` | 寻求架构咨询 |
| 需要重构 | `/wf_09_refactor` | 如果根因是架构问题 |

---

## ⚠️ 常见问题和故障排除

### 问题1: 修复后出现新错误

**症状**: 原始错误解决，但触发了新的错误
**原因**: 可能是级联问题或依赖关系复杂
**解决方案**:
1. 不要惊慌，这是正常的调试过程
2. 将新错误作为独立问题处理
3. 检查新错误是否与原始修复相关
4. 如果相关，考虑调整修复策略

### 问题2: 无法复现错误

**症状**: 按照描述无法触发错误
**原因**: 偶发性问题、环境差异、状态依赖
**解决方案**:
1. 收集更多触发条件信息
2. 检查环境变量和配置差异
3. 添加日志和监控
4. 使用 Deep Analysis Mode (--think --deep)

### 问题3: 修复范围过大

**症状**: 发现需要修改大量代码
**原因**: 可能是设计问题，而非简单bug
**解决方案**:
1. 暂停修复
2. 运行 `/wf_04_ask "架构问题..."` 咨询
3. 考虑是否需要重构（`/wf_09_refactor`）
4. 评估技术债务和优先级

---

## 📊 MCP 增强使用建议

### Sequential-thinking (--think)

**何时使用**:
- ✅ 复杂的逻辑错误
- ✅ 需要多步推理
- ✅ 错误原因不明确

**效果**:
- 结构化思考过程
- 减少遗漏关键因素
- 更清晰的根因分析

### Serena (--deep)

**何时使用**:
- ✅ 大型代码库
- ✅ 需要理解代码关系
- ✅ 精确定位错误位置

**效果**:
- 符号级代码理解
- 准确的定位 (95% 准确率)
- 减少探索时间 50-70%

### 组合使用 (--think --deep)

**最佳实践**:
1. 使用 Serena 定位代码位置
2. 使用 Sequential-thinking 分析根因
3. 结合两者设计最佳修复方案

**性能提升**:
- 调试时间减少 40-60%
- 成功率提升 15-25%

---

**相关文档**:
- 主命令文件: [wf_06_debug.md](../../wf_06_debug.md)
- 一致性策略: [command_consistency_strategy.md](command_consistency_strategy.md)
- 架构咨询: [wf_04_ask_workflows.md](wf_04_ask_workflows.md)
- MCP 集成: [../integration/MCP_INTEGRATION_STRATEGY.md](../integration/MCP_INTEGRATION_STRATEGY.md)
