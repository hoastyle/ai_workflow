---
title: "wf_07_test 工作流指南"
description: "测试开发和覆盖率分析的详细执行指南、决策树和标准输出模板"
type: "技术设计"
status: "完成"
priority: "高"
created_date: "2025-12-12"
last_updated: "2025-12-12"
related_documents:
  - "../../wf_07_test.md"
  - "../command_consistency_strategy.md"
  - "wf_05_code_workflows.md"
  - "wf_08_review_workflows.md"
related_code: []
---

# wf_07_test 工作流指南

本文档提供 `/wf_07_test` 命令的详细执行流程和标准化输出模板，确保AI测试开发过程的一致性和质量。

---

## 🤖 AI执行协议（强制）

**本节为AI执行的强制规范，必须严格遵循，不得跳过或自行解释**

### 核心原则

1. **强制读取**: AI必须首先读取本文档的关键章节
2. **严格遵循**: 所有步骤按顺序执行，不得合并或跳过
3. **标准输出**: 必须使用本文档提供的输出模板
4. **检查验证**: 完成前必须通过所有检查清单项
5. **覆盖率优先**: 测试必须有明确的覆盖率目标和验证

### 执行流程概览

```
Step 0: Confidence Check（信心评估）
  ↓
Step 1: 模式选择（根据决策树）
  ├─ Standard Testing (默认) → 标准测试开发流程
  ├─ Coverage Analysis (--coverage) → 覆盖率分析和改进流程
  └─ Strategic Planning (--think) → 结构化测试策略流程
  ↓
Step 2-6: 按选定模式执行（详见下文）
  ↓
Final: 输出测试报告（使用标准模板）
```

---

## 🎯 模式选择决策树（强制使用）

**AI必须根据以下决策树选择唯一的测试模式**：

```
检查用户是否提供了明确的模式标志？
│
├─ YES (用户提供了标志)
│  ├─ --coverage → 使用 Coverage Analysis Mode
│  ├─ --think → 使用 Strategic Planning Mode
│  └─ --think --coverage → 使用组合模式（策略 + 覆盖率）
│
└─ NO (用户未提供标志，AI需要基于上下文判断)
   │
   ├─ 已有部分测试，需要分析覆盖率？
   │  └─ YES → 推荐 Coverage Analysis Mode
   │
   ├─ 全新组件或复杂功能？
   │  └─ YES → 推荐 Strategic Planning Mode (--think)
   │
   └─ 简单功能或BUG修复？
      └─ YES → Standard Testing Mode（直接编写测试）
```

**模式特征**:

| 模式 | 适用场景 | MCP 增强 | 预期时间 | 输出 |
|------|---------|---------|---------|------|
| **Standard** | 简单功能、BUG修复测试 | Serena (自动) | 15-30分钟 | 测试代码 + 基础覆盖率 |
| **Coverage** | 已有测试，需要提升覆盖率 | Serena (自动) | 20-40分钟 | 覆盖率分析 + 改进计划 |
| **Strategic** | 复杂功能、全新组件 | --think + Serena | 30-60分钟 | 测试策略 + 完整测试套件 |

---

## 📋 Standard Testing Mode 执行流程

**适用条件**:
- ✅ 简单功能或BUG修复
- ✅ 测试需求明确
- ✅ 可以直接编写测试
- ✅ 不需要复杂的策略规划

### Step 1: 测试需求分析

**分析内容**:
```
1. 理解被测代码
   - 读取目标函数/类的代码（优先使用 Serena MCP）
   - 识别输入参数和输出结果
   - 理解业务逻辑和边界条件

2. 确定测试范围
   - 正常路径（Happy Path）
   - 异常路径（Error Cases）
   - 边界条件（Boundary Cases）
   - 特殊场景（Edge Cases）

3. 查阅测试策略
   - 读取 PLANNING.md 中的测试策略
   - 了解项目的测试框架和模式
   - 确认覆盖率要求
```

### Step 2: 测试设计

**设计测试用例**:
```python
# 示例：测试用例设计模板
测试用例 1: 正常输入
  输入: [正常范围内的参数]
  预期: [正确的返回值]

测试用例 2: 边界条件
  输入: [最小值/最大值/空值]
  预期: [边界处理结果]

测试用例 3: 异常处理
  输入: [无效参数]
  预期: [抛出预期异常或返回错误]

测试用例 4: 特殊场景
  输入: [特殊业务逻辑触发条件]
  预期: [特殊逻辑的正确处理]
```

### Step 3: 实现测试代码

**遵循项目模式**:
1. 使用项目指定的测试框架（pytest, unittest, jest等）
2. 遵循项目的测试文件命名规范
3. 使用项目的测试工具和Mock模式
4. 添加清晰的测试描述和断言消息

**代码质量要求**:
- ✅ 每个测试用例独立（不依赖其他测试）
- ✅ 使用有意义的测试函数名
- ✅ 包含必要的setup和teardown
- ✅ 使用Mock隔离外部依赖

### Step 4: 运行测试验证

**验证步骤**:
```bash
# 1. 运行新编写的测试
[测试命令] [测试文件]

# 2. 检查测试结果
- 所有测试是否通过？
- 测试输出是否符合预期？
- 是否有意外的警告或错误？

# 3. 生成基础覆盖率报告（如有工具）
[覆盖率命令] [目标代码]
```

### Step 5: 更新文档和任务

**必须更新**:
1. TASK.md - 标记测试任务为完成
2. 如有需要，在 KNOWLEDGE.md 中添加测试模式或最佳实践

### 输出模板：Standard Testing 成功

```markdown
## 🧪 测试开发报告

**测试目标**: [被测试的组件/功能]
**测试类型**: 单元测试/集成测试/端到端测试

### 测试用例概览
- 正常路径测试: [数量]个
- 异常处理测试: [数量]个
- 边界条件测试: [数量]个
- 特殊场景测试: [数量]个
**总计**: [总数]个测试用例

### 测试实现

**测试文件**: `[测试文件路径]`

```[语言]
[关键测试代码片段或示例]
```

### 执行结果

```
[测试运行输出]
✅ [通过数] passed
❌ [失败数] failed (如有)
```

**基础覆盖率**: [行覆盖率]% (如有)

### 下一步建议

- ✅ 所有测试通过 → 可以执行 `/wf_08_review`
- ⚠️ 覆盖率不达标 → 建议执行 `/wf_07_test "[功能]" --coverage`
- ❌ 有测试失败 → 需要修复代码后重新测试
```

---

## 📋 Coverage Analysis Mode 执行流程

**适用条件**:
- ✅ 已有部分测试
- ✅ 需要提升覆盖率
- ✅ 使用 `--coverage` 标志
- ✅ 项目有覆盖率要求

### Step 1: 生成覆盖率报告

**执行覆盖率分析**:
```bash
# Python 示例
pytest --cov=[模块名] --cov-report=term-missing

# JavaScript 示例
npm test -- --coverage

# 其他语言根据项目配置
```

### Step 2: 识别覆盖率缺口

**分析未覆盖的代码**:
```
1. 完全未测试的文件
   - 列出没有任何测试的源文件
   - 优先级：核心业务逻辑 > 工具函数 > 配置代码

2. 部分覆盖的函数
   - 识别有测试但覆盖率<80%的函数
   - 分析哪些分支/路径未测试

3. 关键逻辑缺口
   - 错误处理代码是否被测试？
   - 边界条件是否被覆盖？
   - 特殊业务逻辑是否验证？
```

### Step 3: 优先级排序

**覆盖率改进优先级**:
```
优先级 1（高）:
- 核心业务逻辑函数
- 用户直接交互的接口
- 已知BUG修复的相关代码
- 复杂度高的函数

优先级 2（中）:
- 工具函数和辅助类
- 配置和初始化代码
- 中等复杂度的逻辑

优先级 3（低）:
- 简单的getter/setter
- 第三方库的封装
- 不常执行的代码路径
```

### Step 4: 制定改进计划

**生成改进任务清单**:
```markdown
### 覆盖率改进计划

**目标**: 从 [当前覆盖率]% 提升到 [目标覆盖率]%

#### 高优先级（必须添加）
- [ ] 测试 `[函数名]` 的错误处理路径
- [ ] 测试 `[函数名]` 的边界条件
- [ ] ...

#### 中优先级（建议添加）
- [ ] 测试 `[函数名]` 的所有分支
- [ ] ...

#### 低优先级（可选）
- [ ] 测试 `[函数名]` 的特殊场景
- [ ] ...
```

### Step 5: 实施改进（可选）

如果用户希望立即改进覆盖率：
1. 按优先级顺序添加测试
2. 每添加一组测试后重新运行覆盖率分析
3. 验证覆盖率是否达到目标

### 输出模板：Coverage Analysis 成功

```markdown
## 📊 覆盖率分析报告

**分析目标**: [被分析的组件/模块]
**当前覆盖率**: [X]%
**项目目标**: [Y]%
**状态**: ✅ 达标 / ⚠️ 接近 / ❌ 不达标

### 覆盖率详情

| 文件 | 行覆盖率 | 分支覆盖率 | 未覆盖行 |
|------|---------|-----------|---------|
| [文件1] | [%] | [%] | [行号列表] |
| [文件2] | [%] | [%] | [行号列表] |
| ... | ... | ... | ... |

### 覆盖率缺口分析

#### 🔴 高优先级缺口（必须解决）
1. **[函数名]** ([文件:行号])
   - 未覆盖原因: [错误处理/边界条件/...]
   - 影响: [业务逻辑关键性说明]
   - 建议测试: [测试用例描述]

2. ...

#### 🟡 中优先级缺口（建议解决）
1. **[函数名]** ([文件:行号])
   - 未覆盖原因: [...]
   - 建议测试: [...]

### 改进计划

**预计新增测试**: [数量]个
**预计覆盖率提升**: +[X]% → [目标]%
**预计工作量**: [时间估计]

#### 立即行动项
- [ ] 添加 `[函数]` 的错误处理测试
- [ ] 添加 `[函数]` 的边界条件测试
- [ ] ...

### 下一步建议

- 如需立即改进 → 按计划添加测试
- 如已满足要求 → 执行 `/wf_08_review`
- 如需讨论策略 → 执行 `/wf_04_ask "测试覆盖率策略..."`
```

---

## 📋 Strategic Planning Mode 执行流程

**适用条件**:
- ✅ 复杂功能或全新组件
- ✅ 需要系统化的测试策略
- ✅ 使用 `--think` 标志
- ✅ MCP Sequential-thinking 可用

### Step 1: 结构化需求分析

**使用 Sequential-thinking MCP**:
```
Thought 1: 分析被测组件的职责和边界
  - 组件的核心功能是什么？
  - 有哪些外部依赖？
  - 输入输出接口定义？

Thought 2: 识别测试维度
  - 功能正确性测试
  - 错误处理测试
  - 性能测试（如有需要）
  - 安全性测试（如有需要）

Thought 3: 设计测试金字塔
  - 单元测试层（70%）
  - 集成测试层（20%）
  - 端到端测试层（10%）
```

### Step 2: 测试用例设计

**分层设计测试**:
```
单元测试层:
  - 每个公开函数/方法至少1个正常路径测试
  - 每个错误处理分支至少1个测试
  - 所有边界条件测试

集成测试层:
  - 组件间交互测试
  - 数据库/API集成测试
  - 第三方服务Mock测试

端到端测试层（可选）:
  - 关键用户流程测试
  - 完整业务场景测试
```

### Step 3: 实施测试套件

遵循 Standard Testing Mode 的 Step 3 和 Step 4

### Step 4: 覆盖率验证

遵循 Coverage Analysis Mode 的 Step 1 和 Step 2

### 输出模板：Strategic Planning 成功

```markdown
## 🎯 测试策略报告

**测试目标**: [被测试的组件/功能]
**复杂度评估**: 高/中/低
**测试策略**: 分层测试（单元 + 集成 + E2E）

### 测试金字塔设计

```
       /\
      /E2E\     [X]个端到端测试
     /------\
    /集成测试\   [Y]个集成测试
   /----------\
  /  单元测试  \  [Z]个单元测试
 /--------------\
```

**总计**: [总数]个测试用例

### 测试用例分布

#### 单元测试 ([数量]个)
- 正常路径: [数量]个
- 错误处理: [数量]个
- 边界条件: [数量]个
- 特殊场景: [数量]个

#### 集成测试 ([数量]个)
- 组件交互: [数量]个
- 外部依赖: [数量]个

#### 端到端测试 ([数量]个，可选)
- 用户流程: [数量]个

### 实现概览

**已实现测试文件**:
- `[测试文件1]` - 单元测试
- `[测试文件2]` - 集成测试
- ...

**执行结果**:
```
✅ [通过数] passed
❌ [失败数] failed (如有)
覆盖率: [行覆盖率]%
```

### 测试策略思考过程

[使用 Sequential-thinking MCP 的思考步骤输出]

### 下一步建议

- ✅ 测试通过且覆盖率达标 → `/wf_08_review`
- ⚠️ 需要改进 → 按优先级完善测试
- 📋 复杂度高 → 考虑分阶段实施测试
```

---

## ✅ 执行检查清单（AI必须验证）

**在输出最终报告前，AI必须确认以下所有项目**：

### 基础检查（所有模式）
- [ ] ✅ 已读取 `docs/guides/wf_07_test_workflows.md` 的关键章节
- [ ] ✅ 已根据决策树选择了唯一的测试模式并说明理由
- [ ] ✅ 已读取 PLANNING.md 中的测试策略
- [ ] ✅ 测试代码遵循项目的测试框架和模式

### Standard Testing Mode 检查
- [ ] ✅ 至少包含正常路径、异常处理、边界条件测试
- [ ] ✅ 所有测试用例独立且可重复运行
- [ ] ✅ 测试代码有清晰的描述和断言消息
- [ ] ✅ 已运行测试并验证通过

### Coverage Analysis Mode 检查
- [ ] ✅ 已生成覆盖率报告（实际运行或使用项目现有报告）
- [ ] ✅ 已识别并分类覆盖率缺口（高/中/低优先级）
- [ ] ✅ 改进计划包含具体的测试用例描述
- [ ] ✅ 预估了覆盖率提升幅度

### Strategic Planning Mode 检查
- [ ] ✅ 使用 Sequential-thinking MCP 进行了系统化分析
- [ ] ✅ 测试金字塔设计合理（单元 > 集成 > E2E）
- [ ] ✅ 测试用例覆盖了所有关键维度（功能、错误、边界）
- [ ] ✅ 策略思考过程完整且逻辑清晰

### 输出格式检查
- [ ] ✅ 使用了本文档提供的标准输出模板
- [ ] ✅ 报告包含明确的测试结果和覆盖率数据
- [ ] ✅ 提供了清晰的下一步建议
- [ ] ✅ 已更新 TASK.md（如适用）

### MCP 使用检查（如适用）
- [ ] ✅ Serena MCP 用于精确定位被测代码（如可用）
- [ ] ✅ Sequential-thinking MCP 用于策略分析（如使用 --think）
- [ ] ✅ 如 MCP 不可用，已使用标准工具（Grep/Read）替代

---

## 🔧 常见问题和最佳实践

### Q1: 如何确定测试范围？

**答案**:
1. 优先测试公开API和用户直接交互的功能
2. 核心业务逻辑必须有完整测试
3. 内部实现细节可以适当跳过
4. 参考 PLANNING.md 中的测试策略和覆盖率要求

### Q2: 测试用例应该多详细？

**答案**:
- **太少**: 只测试正常路径 → ❌ 不充分
- **适中**: 正常路径 + 主要异常 + 关键边界 → ✅ 推荐
- **太多**: 穷举所有可能组合 → ⚠️ 成本高，收益低

### Q3: 何时使用 Mock？

**答案**:
- ✅ 外部服务（API、数据库、文件系统）
- ✅ 复杂依赖或慢速操作
- ✅ 需要模拟特定错误场景
- ❌ 简单的纯函数
- ❌ 项目内部简单依赖

### Q4: 覆盖率目标应该是多少？

**答案**:
- 核心业务逻辑：**90-100%**
- 一般功能代码：**80-90%**
- 工具函数：**70-80%**
- 配置和初始化：**50-70%**
- 不要盲目追求100%，关注关键路径

### Q5: 如何处理测试失败？

**答案**:
1. 分析失败原因（代码BUG vs 测试错误）
2. 如果是代码BUG → 修复代码后重新测试
3. 如果是测试错误 → 修正测试用例
4. 如果不确定 → 使用 `/wf_06_debug` 系统分析

---

## 📚 相关文档

- **命令定义**: wf_07_test.md
- **一致性策略**: command_consistency_strategy.md
- **代码实现指南**: wf_05_code_workflows.md
- **代码审查指南**: wf_08_review_workflows.md
- **架构咨询**: wf_04_ask_workflows.md
