---
title: "wf_03_prime 工作流导航指南"
description: "后续工作路径选择、决策矩阵和工作流示例"
type: "技术设计"
status: "完成"
priority: "高"
created_date: "2025-11-27"
last_updated: "2025-11-27"
related_documents:
  - "../../wf_03_prime.md"
  - "doc_maintenance_workflows.md"
  - "../../KNOWLEDGE.md"
related_code: []
---

# wf_03_prime 工作流导航指南

本文档说明 `/wf_03_prime` 的执行协议、模式选择决策树、工作流路径选择和实现规范。

---

## 🤖 AI执行协议（强制）

**本节为AI执行的强制规范，必须严格遵循，不得跳过或自行解释**

### 核心原则

1. **强制读取**: AI必须首先读取本文档的关键章节
2. **严格遵循**: 所有步骤按顺序执行，不得合并或跳过
3. **标准输出**: 必须使用本文档提供的输出模板
4. **检查验证**: 完成前必须通过所有检查清单项

### 执行流程概览

```
Step 0: 读取本执行协议 (当前)
  ↓
Step 1: 模式选择（根据决策树）
  ↓
Step 2: 文档可用性检查
  ↓
Step 3: 按模式加载文档
  ↓
Step 4: 生成标准化输出
  ↓
Step 5: 添加模式切换提示
  ↓
检查清单验证 → 输出结果
```

### 模式选择决策树（强制使用）

**AI必须根据以下决策树选择唯一的加载模式**：

```
检查用户是否提供了明确的模式标志？
│
├─ YES (用户提供了标志)
│  ├─ --quick 或 --index → 使用 Quick Start 模式
│  ├─ --task 或 --focused → 使用 Task Focused 模式
│  └─ --full 或 --complete → 使用 Full Context 模式
│
└─ NO (用户未提供标志，AI需要判断)
   │
   ├─ 检查 CONTEXT.md 是否存在？
   │  ├─ 不存在 → 使用 Full Context 模式（新会话，需要完整上下文）
   │  └─ 存在 → 继续判断
   │
   ├─ 检查 TASK.md 中是否有 status: "进行中" 的任务？
   │  ├─ 有进行中任务 → 使用 Task Focused 模式（恢复工作）
   │  └─ 无进行中任务 → 继续判断
   │
   └─ 默认 → 使用 Quick Start 模式（常规会话开始）
```

**输出要求**: 必须明确说明选择的模式和理由

示例：
```
📍 模式选择: Task Focused
📍 选择理由: TASK.md 中存在进行中的任务 "实现用户认证功能"
```

### 标准输出模板（必须使用）

根据选定的模式，AI必须使用对应的输出模板：

#### Quick Start 模式输出模板

```markdown
# 项目上下文摘要（Quick Start）

## 📋 项目信息
- 项目名称: [从CLAUDE.md提取]
- 开发阶段: [从CONTEXT.md或PROJECT_INDEX.md提取]
- 语言规范: [从CLAUDE.md提取]

## 📝 当前焦点
- 活跃任务: [从CONTEXT.md § 当前工作焦点提取]
- 推荐命令: [从CONTEXT.md § 下次启动时提取]

## 🔗 快速访问
- PLANNING.md: 技术规划和架构
- TASK.md: 任务追踪
- KNOWLEDGE.md: 知识库索引

💡 **提示**: 当前使用Quick Start模式。如需详细上下文，运行 `/wf_03_prime --full`
```

#### Task Focused 模式输出模板

```markdown
# 项目上下文摘要（Task Focused）

## 📋 项目信息
- 项目名称: [从CLAUDE.md提取]
- 开发阶段: [从CONTEXT.md提取]

## 📝 当前任务详情
[从TASK.md提取进行中的任务]
- 任务ID: [...]
- 任务描述: [...]
- 状态: 进行中
- 优先级: [...]
- 相关文件: [...]

## 📐 相关架构信息
[从PLANNING.md提取与当前任务相关的架构/技术栈信息]

## 🎯 推荐下一步
[根据任务状态推荐命令]
- [ ] /wf_05_code - 继续实现
- [ ] /wf_07_test - 编写测试
- [ ] /wf_08_review - 代码审查

💡 **提示**: 当前使用Task Focused模式。如需完整上下文，运行 `/wf_03_prime --full`
```

#### Full Context 模式输出模板

```markdown
# 项目上下文摘要（Full Context）

## 📋 项目概览
[从PLANNING.md § 项目概览提取]
- 项目名称: [...]
- 项目目标: [...]
- 当前版本: [...]
- 开发阶段: [...]

## 📐 架构要点
[从PLANNING.md § 系统架构提取]
- 技术栈: [...]
- 核心模块: [...]
- 关键决策: [...]

## 📝 任务状态
[从TASK.md提取所有任务摘要]
- 总任务数: X
- 已完成: Y
- 进行中: Z
- 待做: W

### 当前进行中任务
[列出所有 status: "进行中" 的任务]

### 高优先级待做任务
[列出前3个高优先级待做任务]

## 🔗 关键决策记录
[从KNOWLEDGE.md § ADR提取最近3个决策]

## 🎯 推荐下一步
[基于任务状态和项目阶段推荐命令]
```

### 执行检查清单（强制验证）

AI在输出结果前必须确认以下所有项：

- [ ] ✅ 已读取本执行协议
- [ ] ✅ 已根据决策树选择模式并明确说明理由
- [ ] ✅ 已检查文档可用性（CLAUDE.md, CONTEXT.md, PLANNING.md, TASK.md, KNOWLEDGE.md）
- [ ] ✅ 已按选定模式使用Doc Guard工具加载文档
- [ ] ✅ 输出格式完全符合对应模式的标准模板
- [ ] ✅ 已添加模式切换提示（见下节）
- [ ] ✅ 遵循CLAUDE.md语言规范

**如果任何检查项未通过，必须重新执行对应步骤**

### 模式切换提示（必须添加）

AI必须在输出末尾添加以下模式切换提示：

```markdown
---
## 🔄 模式切换

当前模式: [Quick Start / Task Focused / Full Context]

如需切换模式，请使用：
- `/wf_03_prime --quick` - 快速启动（~200 tokens）
- `/wf_03_prime --task` - 任务导向（~600 tokens）
- `/wf_03_prime --full` - 完整上下文（~1200 tokens）
```

### 故障排除

| 问题 | 解决方案 |
|------|---------|
| Doc Guard工具不存在 | 降级使用Read工具，但需警告用户token消耗可能较高 |
| CONTEXT.md不存在 | 正常情况（首次会话），使用Full Context模式 |
| PLANNING.md不存在 | 提示用户运行 `/wf_01_planning` 建立规划 |
| TASK.md不存在 | 提示用户运行 `/wf_02_task` 初始化任务 |
| 模式标志冲突 | 使用最保守的模式（Quick Start） |
| 执行协议文档读取失败 | 使用wf_03_prime.md中的快速参考执行，但一致性降低 |

---

## 📌 工作流位置指示

当使用此命令时，你正在执行标准开发流程的以下阶段：

```
[项目启动] → [任务规划] → [加载上下文 ← 当前] → [架构咨询] → [代码实现] → [测试验证] → [代码审查] → [提交保存]
  STEP 0       STEP 0.5        STEP 1                STEP 2       STEP 3       STEP 4       STEP 5      STEP 6
```

### ✅ 已完成的步骤

在执行 `/wf_03_prime` 前，通常已经完成：

1. ✅ **项目启动** (STEP 0) - 项目规划已完成 (`/wf_01_planning`)
2. ✅ **任务规划** (STEP 0.5) - 任务列表已生成 (`/wf_02_task`)
   - 或者：直接从 `/clear` 后恢复工作（重新加载上下文）

### 📝 当前步骤

**正在执行**: `/wf_03_prime` (加载项目上下文)

**这个命令的职责**：
- 读取项目管理文档（PRD.md, PLANNING.md, TASK.md, CONTEXT.md, KNOWLEDGE.md）
- 恢复会话状态和工作上下文
- 智能加载技术文档（基于当前任务相关性）
- 推荐下一步优先任务
- 为后续工作做好准备

### ⏭️ 建议下一步

**任务创建/更新完成后**，根据项目状态选择下一步：

#### 路径 1️⃣：有明确的建筑咨询需求 ✅
```bash
# 当前: 已加载项目上下文
# 下一步: 架构咨询或技术决策

/wf_04_ask "具体的技术问题或架构咨询"

# 后续: 基于咨询结果执行开发
/wf_05_code "开始功能实现"
```
**适用场景**: 需要在编码前进行技术验证、架构决策、或获取设计指导

#### 路径 2️⃣：直接开始编码实现 ✨
```bash
# 当前: 已加载项目上下文
# 下一步: 直接实现功能

/wf_05_code "实现指定的功能或任务"

# 后续: 测试和审查
/wf_07_test "功能测试验证"
/wf_08_review "代码审查"
/wf_11_commit "提交代码"
```
**适用场景**: 任务明确，不需要额外咨询，可以直接开始编码

#### 路径 3️⃣：更新任务状态后继续工作 📋
```bash
# 当前: 已加载项目上下文
# 下一步: 更新当前任务状态

/wf_02_task update "标记当前任务为活跃或更新进度"

# 然后: 根据任务选择路径1或路径2
/wf_04_ask "..." 或 /wf_05_code "..."
```
**适用场景**: 需要明确标记当前工作任务，确保任务追踪的连续性

---

## 📊 工作流进度提示

当你完成上下文加载时，确保输出中包含：

✅ 已完成:
- 项目需求和目标（来自 PRD.md）
- 项目架构和技术栈（来自 PLANNING.md）
- 当前任务列表和优先级（来自 TASK.md）
- 上一个会话的进度（来自 CONTEXT.md）
- 知识库和设计决策（来自 KNOWLEDGE.md）
- 相关的技术文档清单（来自文档索引）

⏭️ 下一步提示:
- 建议执行的命令（基于当前任务和项目状态）
- 推荐的工作流路径（3个选项之一）
- 当前任务的详细说明和验收标准

---

## 💡 决策指南

**我应该执行哪个路径？**

| 情况 | 建议 | 命令 |
|------|------|------|
| 需要技术决策或架构讨论 | 路径 1 | /wf_04_ask → /wf_05_code |
| 任务明确，直接编码 | 路径 2 | /wf_05_code → /wf_07_test → /wf_08_review → /wf_11_commit |
| 需要更新任务状态 | 路径 3 | /wf_02_task update → 路径1或路径2 |
| 发现问题需要调试 | 特殊 | /wf_06_debug → /wf_07_test → /wf_11_commit |
| 不确定下一步 | 推荐 | 先执行 /wf_02_task update，再选择路径 |

---

## 🧠 智能推荐输出规范

### 提取算法

当生成"💡 智能推荐下一步"部分时，应按以下步骤操作：

1. **读取 TASK.md**
   - 定位到"## 🚀 下一步优先任务"部分
   - 检查是否存在"进行中的任务"（marked as `[⏳]` 或 `[进行中]`）

2. **任务选择逻辑**
   ```
   if 有进行中的任务:
       当前任务 = 进行中的任务
       状态 = "进行中"
       显示: 任务名 + 当前步骤进度 + 下一步建议
   else if 有待做任务:
       当前任务 = 优先级最高的待做任务 (第一个)
       状态 = "待开始"
       显示: 任务名 + 完整命令序列 + 验收标准
   else:
       显示: "所有待做任务已完成！" + 项目统计信息
   ```

3. **信息提取**
   - **任务标题**: 从"#### 任务 X️⃣：[名称]"提取
   - **优先级**: 从"[🔴 高优先级]"或"[🟠 中优先级]"提取
   - **预计时间**: 从"预计时间: X分钟"提取
   - **工作流位置**: 从"工作流位置: [...]"提取
   - **为什么优先**: 从"为什么优先:"提取
   - **命令序列**: 从"推荐命令序列"中的 bash 代码块提取
   - **验收标准**: 从"验收标准:"后的列表提取

4. **输出格式**
   - 使用 markdown 格式，清晰的层级结构
   - 使用 emoji 标记（✅、🔴、🟠、⏳、→ 等）
   - 使用代码块显示命令序列
   - 使用复选框 `[ ]` 显示验收标准

### 验证检查表

生成输出前，验证以下内容：

- [ ] 从 TASK.md 正确读取了任务信息
- [ ] 优先级标记准确（🔴 高、🟠 中、🟡 低）
- [ ] 命令序列完整且正确（包含所有步骤）
- [ ] 工作流位置标记清晰
- [ ] 验收标准可验证（不含歧义）
- [ ] 如果有多个待做任务，列出其他任务的简表
- [ ] 输出清晰易读，符合中文文档规范

### 错误处理

- **TASK.md 格式不匹配**: 提示用户"检查 TASK.md 格式是否符合标准"
- **没有待做任务**: 显示"项目任务已全部完成！"并询问用户是否需要进入下一阶段
- **任务信息不完整**: 显示可用信息，并标记缺失的部分

---

## 实现示例

### 场景 1：P1 阶段完成，进入 P2 规划

**项目状态**：
- P1 阶段：100% 完成（所有功能实现测试）
- P2 阶段：规划中（待定义任务）

**改进后的 /wf_03_prime 输出示例**：

```
## 💡 智能推荐下一步

### ✅ **优先推荐**（基于 TASK.md 待做任务）

**任务**: 完善脚本类型注解 🔴 高优先级
- 预计时间: 30分钟
- 工作流位置: [准备阶段] → [代码实现] → [审查] → [提交]
- 为什么优先: 提高 IDE 支持和代码可维护性，为后续单元测试打基础

**推荐立即执行以下命令序列**:
```bash
# 第1步: 确认任务并标记为活跃
/wf_02_task update "完善脚本类型注解"

# 第2步: 代码实现 (主要工作)
/wf_05_code "为 ~/.claude/commands/scripts/frontmatter_utils.py 添加完整类型注解"

# 第3步: 代码审查
/wf_08_review

# 第4步: 提交并保存进度
/wf_11_commit "feat: 完善脚本类型注解"
```

**验收标准** (完成后可验证):
- [ ] 所有函数/方法都有完整的类型注解
- [ ] 修正 `any` → `Any` (大写)
- [ ] 代码审查通过
- [ ] 提交到仓库

**📊 工作流进度**:
- 当前: 项目上下文加载完成
- 下一步: 执行上述命令序列
- 工作流位置: [加载阶段] → [任务执行] → [验收] → [提交]

### 📋 其他待做任务 (优先级顺序)
2. 增强脚本错误处理 (🔴 高优先级, 45分钟)
3. 添加单元测试 (🟠 中优先级, 2小时)
```

### 场景 2：某个任务进行中，显示下一步

**项目状态**：
- 当前任务：完善脚本类型注解 (进行中 ⏳)

**改进后的 /wf_03_prime 输出**：

```
## 💡 智能推荐下一步

### ✅ **当前任务进度**

**任务**: 完善脚本类型注解 🔴 高优先级
- 状态: 进行中 ⏳ (第2步/4步)
- 工作流位置: [准备阶段] → [代码实现 ← 当前] → [审查] → [提交]

**建议继续执行**:
```bash
# 当前完成: /wf_02_task update "..."
# 当前完成: /wf_05_code "..."
# 下一步:
/wf_08_review

# 然后:
/wf_11_commit "feat: 完善脚本类型注解"
```

**📊 工作流进度**:
- 已完成: 任务确认 + 代码实现
- 下一步: 代码审查
- 工作流位置: [加载] → [执行] → [验收 ← 当前] → [提交]
```

---

**See Also**:
- [wf_03_prime.md](../../wf_03_prime.md) - 主命令文档
- [wf_03_prime_mcp_serena.md](wf_03_prime_mcp_serena.md) - MCP Serena 增强指南
- [doc_maintenance_workflows.md](doc_maintenance_workflows.md) - 文档维护工作流
- [KNOWLEDGE.md](../../KNOWLEDGE.md) - 知识库索引
