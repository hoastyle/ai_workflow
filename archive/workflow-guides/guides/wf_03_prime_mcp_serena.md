---
title: "wf_03_prime MCP Serena 增强指南"
description: "Serena 语义代码理解和 LSP 初始化详细说明"
type: "技术设计"
status: "完成"
priority: "高"
created_date: "2025-11-27"
last_updated: "2025-11-27"
related_documents:
  - "../../wf_03_prime.md"
  - "../reference/FRONTMATTER.md"
  - "../../KNOWLEDGE.md"
related_code: []
---

# wf_03_prime MCP Serena 增强指南

本文档详细说明 `/wf_03_prime` 中的 Serena MCP 增强功能和 LSP 初始化过程。

---

## 🔌 Serena MCP 增强能力

本命令支持以下 MCP 服务器的增强，提供更智能的上下文加载：

### Serena (自动激活)

**启用**: 自动激活（无需标志）
**用途**: 语义级别的项目理解和代码索引
**自动激活**: 在 `/wf_03_prime` 执行时自动启用

#### Serena 在上下文加载中的作用

1. **项目结构理解** – 语义层面理解代码组织:
   - 自动构建项目文件的语义索引
   - 识别核心组件和模块边界
   - 理解代码架构模式
   - 映射技术栈到代码实现

2. **知识图谱构建** – 建立项目知识网络:
   - 连接 PLANNING.md 架构与实际代码
   - 映射 KNOWLEDGE.md 决策到代码位置
   - 关联 TASK.md 任务与相关代码文件
   - 建立文档-代码双向索引

3. **智能文档加载** – 基于语义相关性选择文档:
   - 分析当前任务的代码关联
   - 智能选择相关的技术文档
   - 优先加载最相关的代码示例
   - 减少不必要的上下文加载

4. **上下文记忆持久化** – 跨会话的项目记忆:
   - 记住项目的架构模式和决策
   - 积累常用代码路径和关键位置
   - 学习团队的编码风格和偏好
   - 提供基于历史的智能建议

#### Serena 增强的具体效果

```
无 Serena 时:
- 仅读取文本文档内容
- 依赖文件名和目录结构猜测关系
- 需要手动导航到相关代码

有 Serena 时:
- 理解文档描述的架构在代码中的位置
- 自动找到 TASK 相关的代码文件
- 快速定位 KNOWLEDGE.md 提到的模式的实现
- 提供语义级别的代码导航
```

#### 使用示例

```bash
# Serena 自动激活，无需特殊标志
/wf_03_prime

# 输出将包含:
# - 项目语义结构分析
# - 代码-文档映射关系
# - 基于当前任务的智能建议
# - 关键代码位置的快速链接
```

**Note**: Serena 在后台自动工作，提升上下文理解的深度和准确性，无需用户干预。

---

## LSP 初始化输出示例

当 Serena 启动时，LSP 初始化流程会产生以下输出信息：

```
═══════════════════════════════════════════════════════════
🔌 Serena LSP 初始化进度
═══════════════════════════════════════════════════════════

[T+0.0s] 项目激活
└─ 路径: /home/user/my-project
└─ 配置: .serena/project.yml

[T+0.1s] 语言检测
└─ 检测语言: Python
└─ 首选 LSP: Pyright

[T+0.5s] 启动语言服务器 🚀
└─ 启动: Pyright (Python Language Server)
└─ 进程 ID: 12345
└─ 耗时: 2.3s

[T+2.8s] 加载项目配置
└─ 文件: pyproject.toml, setup.cfg
└─ 源目录: src/
└─ 耗时: 1.2s

[T+4.0s] 代码扫描和索引生成 📚
├─ 扫描文件: 246 Python 源文件
├─ 生成 AST: 进行中... [████░░░░░░] 40%
├─ 构建符号表: 已完成
│  ├─ 函数定义: 523
│  ├─ 类定义: 87
│  ├─ 变量定义: 1,245
│  └─ 导入语句: 456
└─ 生成引用关系图: 进行中... [██████░░░░] 60%

[T+14.2s] 缓存完成 ✅
└─ 符号索引缓存: 已保存到内存
└─ 总耗时: 14.2 秒

═══════════════════════════════════════════════════════════
📊 Serena 就绪状态
═══════════════════════════════════════════════════════════

✅ Serena 初始化完成
├─ LSP 服务器: 运行中 (Pyright)
├─ 符号索引: 准备就绪 (1,311 个符号)
├─ 可用工具: 23 个 (find_symbol, rename_symbol, 等)
├─ 缓存策略: 已激活
└─ 预期查询延迟: ~200-500ms

📈 性能基准 (此项目)
├─ 符号查询: ~150ms
├─ 符号概览: ~300ms
├─ 引用查找: ~600ms
└─ 代码导航: 快速
```

### LSP 初始化的影响

初始化完成后，你可以使用所有 Serena 的符号级工具，包括：

- 🔍 **find_symbol()** - 精确定位代码中的函数、类、变量
- 📋 **get_symbols_overview()** - 快速浏览文件的顶层符号
- 🔗 **find_referencing_symbols()** - 找到所有引用某个符号的位置
- ✏️ **replace_symbol_body()** - 原子级别地替换符号定义
- 🔄 **rename_symbol()** - 自动重命名符号及其所有引用

**关键价值**：LSP 初始化后，Serena 能够准确理解代码结构，这使得所有的代码操作都是**语义级别**的，而不仅仅是文本级别的。

---

## 组合说明

`/wf_03_prime` 主要依赖 Serena 提供语义增强。不支持其他 MCP 标志，因为此命令的核心职责是加载项目上下文，而非执行分析或研究任务。

其他 MCP 服务器（Sequential-thinking, Context7, Tavily, Magic）在后续的工作命令中使用：
- `/wf_04_ask` 和 `/wf_04_research` 使用 Context7 和 Tavily
- `/wf_06_debug` 使用 Sequential-thinking 和 Serena
- `/wf_14_doc` 使用 Magic

---

**See Also**:
- [wf_03_prime.md](../../wf_03_prime.md) - 主命令文档
- [doc_maintenance_process.md](doc_maintenance_process.md) - 文档维护流程
- [KNOWLEDGE.md](../../KNOWLEDGE.md) - 知识库索引
