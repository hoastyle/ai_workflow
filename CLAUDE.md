# CLAUDE.md

AI 编程助手的项目指南 - Claude Code 核心执行规则

This file provides essential execution rules for Claude Code when working with this repository's workflow command system.

---

## 📚 文档路由规则

**AI在遇到以下场景时，必须主动使用Read工具读取对应文档**：

| 用户问题类型 | 应读取的文档 | 文档路径 |
|------------|-------------|---------|
| "我应该用哪个命令？"<br/>"有哪些命令？" | 命令完整参考 | [COMMANDS.md](COMMANDS.md) |
| "如何实现XX功能？"<br/>"工作流程是什么？" | 工作流指导 | [WORKFLOWS.md](WORKFLOWS.md) |
| "遇到XX错误"<br/>"为什么失败？" | 故障排查 | [TROUBLESHOOTING.md](TROUBLESHOOTING.md) |
| "这是新项目"<br/>"如何开始？" | 项目介绍和快速开始 | [README.md](README.md) |

**重要**：
- 这些文档不会自动加载到AI上下文
- AI必须根据对话判断并主动使用Read工具读取
- 读取后基于文档内容回答用户问题

---

## 项目规范

### 语言规范

本项目采用分层语言策略：

1. **交互沟通**: 中文
2. **文档**: 中文
3. **代码实现**: 英文（变量、函数、类名）
4. **代码提交**: 参考历史提交风格

### 项目管理文档

所有项目管理文档存储在项目根目录：

| 文件 | 用途 | 维护规则 |
|-----|------|---------|
| **PRD.md** | 项目需求（read-only）| ❌ 绝不自动修改 |
| **PLANNING.md** | 技术规划和架构 | ✅ 重大决策后更新 |
| **TASK.md** | 任务追踪 | ✅ 实时更新状态 |
| **CONTEXT.md** | 会话上下文 | 🤖 仅由/wf_11_commit自动管理 |
| **KNOWLEDGE.md** | 知识库+文档索引 | ✅ 新模式和ADR时添加<br/>📚 维护技术文档索引 |
| **docs/** | 技术层文档 | 📖 按需加载，通过KNOWLEDGE.md索引 |

---

## AI 执行规则

### 文件操作权限矩阵

**严格遵守以下权限规则**：

| 文件 | 读取 | 创建 | 修改 | 删除 | 特殊规则 |
|------|:----:|:----:|:----:|:----:|---------|
| **PRD.md** | ✅ | ❌ | ❌ | ❌ | 只读参考。如用户要求修改，必须明确确认并警告影响 |
| **PLANNING.md** | ✅ | ✅ | ✅ | ❌ | 重大技术决策后必须更新。记录"为什么"和PRD对齐理由 |
| **TASK.md** | ✅ | ✅ | ✅ | ❌ | 完成任务后立即更新状态。每项任务关联PRD需求 |
| **CONTEXT.md** | ✅ | ❌ | ❌ | ❌ | 仅由`/wf_11_commit`自动管理。其他命令不得写入 |
| **KNOWLEDGE.md** | ✅ | ✅ | ✅ | ❌ | 发现架构决策、新模式或问题解决方案时添加ADR |
| **代码文件** | ✅ | ✅ | ✅ | ⚠️ | 遵循PLANNING.md标准。删除需用户确认 |

### 会话生命周期规则

#### 🚀 会话开始时（每次必须检查）

```
1. 检查用户是否运行了 /wf_03_prime
   ├─ 如果是新会话且未运行
   │  └─ 主动提示: "建议先运行 /wf_03_prime 加载项目上下文"
   │
   ├─ 如果是全新项目（管理文档不存在）
   │  └─ 引导: "这是新项目，建议运行 /wf_01_planning 建立规划"
   │
   └─ 如果已加载上下文
       └─ 简要总结: "已加载项目上下文。当前任务: [从TASK.md读取]"
```

#### ⚡ 会话进行中（持续监控）

**决策前检查**：
- 执行任何技术决策前，确认是否符合PRD要求
- 遇到模糊需求，使用`/wf_04_ask`的架构师角色分析
- 不确定时，主动询问用户而不是猜测

**进度追踪**：
- 完成任务后，主动提醒更新TASK.md
- 做重大技术决策后，建议更新PLANNING.md

#### 💾 会话结束前（主动建议）

```
如果用户完成了实际工作（写代码、修复Bug、重构等）:
1. 提醒: "建议运行 /wf_11_commit 保存进度"
2. 说明: "这会自动更新CONTEXT.md，确保下次会话能恢复工作状态"
```

### 主动行为触发规则

**何时主动提醒用户**：

| 场景 | 触发条件 | 提醒内容 |
|------|---------|---------|
| **会话启动** | 新会话且未运行prime | "建议先运行 /wf_03_prime 加载上下文" |
| **任务完成** | 用户说"完成了"、"做好了" | "建议运行 /wf_11_commit 保存进度" |
| **发现问题** | 代码有明显bug | "发现潜在问题，建议使用 /wf_06_debug 系统分析" |
| **需求不清** | 用户需求模糊 | "建议使用 /wf_04_ask 进行架构咨询" |
| **PRD冲突** | 用户要求与PRD冲突 | 明确指出冲突，询问是否覆盖规则 |
| **测试缺失** | 实现功能但无测试 | "建议运行 /wf_07_test 添加测试" |

### 冲突处理决策树

```
用户请求与规则冲突
│
├─ 第1步: 识别冲突类型
│  ├─ PRD冲突: 用户要求与需求文档不符
│  ├─ 标准冲突: 违反PLANNING.md中的开发标准
│  └─ 权限冲突: 要求修改只读文件（如PRD.md）
│
├─ 第2步: 暂停执行，向用户解释
│  └─ 说明: "这个操作会 [具体影响]，因为 [规则原因]"
│
├─ 第3步: 询问确认
│  ├─ 用户明确确认 → 执行 + 记录到KNOWLEDGE.md
│  ├─ 用户取消 → 建议符合规则的替代方案
│  └─ 用户不确定 → 使用 /wf_04_ask 深入分析
```

### 异常处理规则

#### 文件不存在时的处理

| 文件 | 处理方式 |
|------|---------|
| **PRD.md, PLANNING.md** | 提示新项目，建议: "/wf_01_planning 建立项目规划" |
| **TASK.md** | 创建空白模板，添加初始任务: "开始第一个功能开发" |
| **CONTEXT.md** | 正常情况，首次运行不存在。忽略 |
| **KNOWLEDGE.md** | 创建空白文件，说明: "将在工作中积累知识和决策" |

#### 命令执行失败时的处理

```
1. 使用 /wf_06_debug 的调试协调员角色分析错误
2. 尝试自动修复（如格式问题、依赖缺失）
3. 如果无法自动修复:
   ├─ 向用户清晰解释问题和原因
   ├─ 提供具体的解决步骤
   └─ 建议是否需要手动处理
4. 将问题和解决方案记录到KNOWLEDGE.md
```

### 文档管理规则 (NEW)

> 📚 基于四层文档架构的智能加载和维护策略（详见 [DOC_ARCHITECTURE.md](DOC_ARCHITECTURE.md)）

#### 文档架构层次

使用workflow的项目应遵循四层文档架构：

| 层级 | 位置 | 职责 | AI加载策略 |
|------|------|------|-----------|
| **管理层** | 项目根目录 | PRD, PLANNING, TASK, CONTEXT, KNOWLEDGE | ✅ prime自动加载（5个文件） |
| **技术层** | docs/ | 技术细节文档 | 🔍 按需加载（通过KNOWLEDGE.md索引） |
| **工作层** | docs/research/ | 临时探索 | ❌ 不加载（用户可指定） |
| **归档层** | docs/archive/ | 历史文档 | ❌ 不加载 |

#### 文档读取原则

**AI在不同场景的文档加载策略**：

| 场景 | 加载策略 | 说明 |
|------|---------|------|
| **会话开始（/wf_03_prime）** | 自动加载5个管理层文档 | 成本可控，~100KB以内 |
| **解析文档索引** | 从KNOWLEDGE.md提取"📚 文档索引"章节 | 理解可用技术文档 |
| **任务相关技术实现** | 根据TASK.md当前任务判断相关性 | 优先级=高 且 相关 → 加载 |
| **架构咨询（/wf_04_ask）** | 优先读取PLANNING.md，必要时读取docs/architecture/ | 深度分析才加载详细文档 |
| **调试问题（/wf_06_debug）** | 查阅KNOWLEDGE.md已知问题，按需读取技术文档 | 避免盲目加载 |
| **工作层/归档层** | 不主动加载，除非用户明确指示 | 控制上下文成本 |

**加载决策逻辑**：
```
文档优先级 = 高 AND 任务相关 → 立即加载
文档优先级 = 中 AND 任务相关 → 询问或按需加载
文档优先级 = 低 OR 任务无关 → 仅记录存在，不加载
```

#### 文档维护规则

**创建技术文档时**：
- ✅ 必须在KNOWLEDGE.md中添加索引条目
  ```markdown
  | 主题 | 文档路径 | 说明 | 优先级 | 最后更新 |
  | 用户认证 | docs/api/authentication.md | JWT实现 | 高 | 2024-10-31 |
  ```
- ✅ 在KNOWLEDGE.md中建立任务-文档关联
  ```markdown
  | 任务类型 | 相关文档 |
  | 实现登录功能 | architecture/system-design.md, api/authentication.md |
  ```

**维护KNOWLEDGE.md文档索引**：
- ✅ 新技术文档 → 添加索引条目
- ✅ 文档更新 → 更新last_updated字段
- ✅ 文档废弃 → 移动到archive/，从索引移除
- ✅ 定期运行 `/wf_13_doc_maintain` 检查一致性

**定期文档整理**：
- 📅 每10次提交后提示运行 `/wf_13_doc_maintain`
- 📅 季度末（Q1/Q2/Q3/Q4）执行文档维护
- 🔍 识别过期、重复、孤立文档
- 📦 归档到docs/archive/YYYY-QX/

#### 文档分层放置规则

**何时放在管理层（根目录）**：
- ✅ 核心架构概述（不超过500行）
- ✅ 关键决策记录（ADR摘要）
- ❌ 详细技术实现（应放docs/）

**何时放在技术层（docs/）**：
- ✅ API详细文档
- ✅ 数据库设计细节
- ✅ 部署流程和配置
- ✅ 架构深度分析

**何时放在工作层（docs/research/）**：
- ✅ 技术探索Spike（前缀日期：2024-10-XX-name.md）
- ✅ 原型验证文档
- ✅ 临时研究笔记
- ⏰ 超过3个月未使用 → 考虑归档或转正

**何时归档（docs/archive/）**：
- ✅ 超过6个月未更新且无引用
- ✅ 功能已废弃
- ✅ 被新文档完全取代

#### 上下文成本优化

**成功指标**：
- 管理层文档总大小 < 100KB ✓
- 80%的任务只需加载0-2个技术文档 ✓
- 文档索引准确率 > 90% ✓

**AI主动提醒**：
- 管理层文档 > 100KB → 建议精简或外放到技术层
- 发现未索引的技术文档 → 提醒更新KNOWLEDGE.md
- 提交次数达到10次 → 提示运行 `/wf_13_doc_maintain`

### 命令调用规则

**工作流命令是Slash Commands**：
- 格式: `/wf_XX_name`（不是文件路径）
- 按需调用，详细步骤在命令文件中
- AI负责判断"何时调用哪个命令"

**示例**：
```
❌ 错误: "运行 wf_03_prime.md"
✅ 正确: "运行 /wf_03_prime"
```

---

## 命令索引（简化版）

**完整参考**: 查询详细说明时，主动读取 [COMMANDS.md](COMMANDS.md)

### 基础设施（1-3）
- `/wf_01_planning` - 创建/更新项目规划
- `/wf_02_task` - 管理任务追踪
- `/wf_03_prime` ⭐ - **加载项目上下文**（每次会话开始必须）

### 开发实现（4-6）
- `/wf_04_ask` - 架构咨询（支持`--review-codebase`）
- `/wf_05_code` - 功能实现（自动格式化）
- `/wf_06_debug` - 调试修复（支持`--quick`）

### 质量保证（7-10）
- `/wf_07_test` - 测试开发（支持`--coverage`）
- `/wf_08_review` - 代码审查
- `/wf_09_refactor` - 代码重构
- `/wf_10_optimize` - 性能优化

### 运维部署（11-12）
- `/wf_11_commit` - 提交代码（自动更新CONTEXT.md）
- `/wf_12_deploy_check` - 部署检查

### 文档维护（13）NEW
- `/wf_13_doc_maintain` - 文档结构维护和优化

### 支持命令（99）
- `/wf_99_help` - 帮助系统

**命令详细说明**: 当用户询问具体命令时，读取 [COMMANDS.md](COMMANDS.md)

---

## 核心文件权限速查

| 文件 | 权限 | 关键规则 |
|------|------|---------|
| **PRD.md** | 只读 | ❌ 绝不修改 |
| **PLANNING.md** | 读写 | ✅ 重大决策更新 |
| **TASK.md** | 读写 | ✅ 实时状态更新 |
| **CONTEXT.md** | 只读 | 🤖 仅/wf_11_commit写入 |
| **KNOWLEDGE.md** | 读写 | ✅ 新模式/ADR添加<br/>📚 文档索引中心 |
| **docs/** | 读写 | 📖 技术层文档，按需加载 |

---

## 开发标准

### 代码质量

- 📚 遵循PLANNING.md的代码模式
- ✅ 维护测试覆盖率要求
- 🎨 自动格式化（通过`/wf_11_commit`）
- 🚫 零容忍尾部空格
- 📝 统一Unix行结尾（LF）

### Git提交工作流

**提交信息格式**：
```
[type] subject

body
```

**类型标签**：
- `[feat]` - 新功能
- `[fix]` - Bug修复
- `[docs]` - 文档更新
- `[refactor]` - 代码重构
- `[test]` - 测试添加

**最佳实践**：
- 使用`/wf_11_commit`（自动处理格式化和CONTEXT.md更新）
- 提交前运行`/wf_08_review`

### 时间点管理规范

**核心原则**：绝不手动输入日期，总是使用命令动态获取

```bash
# 标准时间获取
TODAY=$(date +%Y-%m-%d)              # 今天
TIMESTAMP=$(date +%Y-%m-%d\ %H:%M:%S) # 完整时间戳
```

**日期类型规则**：
1. **历史日期**（创建时间、发布日期）- 一旦确定，永不修改
2. **维护日期**（最后更新）- 每次修改时自动更新为当前日期
3. **ADR决策日期** - 决策当天的日期

---

## 快速参考

### 记住这5件事

1. 🔄 会话开始时运行 `/wf_03_prime`
2. 💻 使用 `/wf_05_code` 实现功能
3. ✅ 提交前使用 `/wf_08_review`
4. 💾 完成后用 `/wf_11_commit` 保存
5. ❓ 不确定时：
   - 查看命令 → 读取 [COMMANDS.md](COMMANDS.md)
   - 查看流程 → 读取 [WORKFLOWS.md](WORKFLOWS.md)
   - 解决问题 → 读取 [TROUBLESHOOTING.md](TROUBLESHOOTING.md)

### 典型工作流

```
项目启动:
/wf_01_planning → /wf_02_task → /wf_03_prime

功能开发:
/wf_03_prime → /wf_05_code → /wf_07_test → /wf_08_review → /wf_11_commit

Bug修复:
/wf_06_debug → /wf_07_test → /wf_11_commit

会话管理:
/wf_03_prime (开始) → 工作 → /wf_11_commit (保存) → /clear → /wf_03_prime (恢复)
```

**详细工作流**: 用户询问具体场景时，读取 [WORKFLOWS.md](WORKFLOWS.md)

---

**最后更新**: 2025-10-31
**版本**: v3.1 (增加文档管理规则)

该系统确保开发连续性、质量维护和高效的进度追踪，同时通过文档路由机制和四层架构减少AI上下文消耗。

**新增功能**：
- 📚 四层文档架构（管理层/技术层/工作层/归档层）
- 🔍 智能按需加载（基于任务相关性和文档优先级）
- 📑 KNOWLEDGE.md作为文档索引中心
- 🔄 `/wf_13_doc_maintain` 定期文档维护命令
