---
title: "wf_05_code 工作流和决策路径指南"
description: "代码实现后的完整工作流导航、决策矩阵和后续步骤选择指南"
type: "技术设计"
status: "完成"
priority: "高"
created_date: "2025-11-27"
last_updated: "2025-12-12"
related_documents:
  - "../../wf_05_code.md"
  - "../../KNOWLEDGE.md"
  - "../../WORKFLOWS.md"
  - "../../docs/management/TASK.md"
  - "../../docs/management/PLANNING.md"
related_code: []
---

# wf_05_code 工作流和决策路径指南

本文档详细说明 `/wf_05_code` 在完整开发流程中的执行协议、位置指示、决策矩阵和后续工作流路径选择。

---

## 🤖 AI执行协议（强制）

**本节为AI执行的强制规范，必须严格遵循，不得跳过或自行解释**

### 核心原则

1. **强制读取**: AI必须首先读取本文档的关键章节
2. **严格遵循**: 所有步骤按顺序执行，不得合并或跳过
3. **标准输出**: 必须使用本文档提供的输出模板
4. **检查验证**: 完成前必须通过所有检查清单项

### 执行流程概览

```
Step 0: 读取本执行协议 (当前)
  ↓
Step 1: 理解功能需求和范围
  ↓
Step 2: 选择实现模式（标准/多代理/MCP增强）
  ↓
Step 3: 代码实现（遵循PLANNING.md标准）
  ↓
Step 4: 文档决策（完成Step 8.1-8.5检查清单）
  ↓
Step 5: 生成标准化输出
  ↓
Step 6: 添加后续路径提示
  ↓
检查清单验证 → 输出结果
```

### 实现模式决策树（强制使用）

**AI必须根据以下决策树选择唯一的实现模式**：

```
检查功能复杂度和需求类型？
│
├─ 新增复杂功能（>3个文件，多模块交互）
│  └─ 使用多代理协调模式
│     ├─ Implementation Engineer（核心功能）
│     ├─ Integration Specialist（系统集成）
│     └─ Code Reviewer（质量验证）
│
├─ 需要深度代码理解（修改现有复杂模块）
│  └─ 使用 MCP 增强模式
│     └─ --serena 标志（语义代码理解）
│
├─ 前端UI组件开发
│  └─ 使用 MCP 增强模式
│     └─ --ui 标志（Magic UI生成）
│
└─ 简单功能实现（单文件，清晰逻辑）
   └─ 使用标准实现模式
```

**输出要求**: 必须明确说明选择的模式和理由

示例：
```
📍 实现模式: 多代理协调模式
📍 选择理由: 功能涉及3个模块（auth, user, session），需要专业角色协调
```

### 文档决策树（强制使用 - Step 8）

**AI必须完成以下文档决策检查清单**：

```
Q1: 改动了公开 API/函数/类?
├─ YES → 需要文档（Type C 或 B）
└─ NO → Q2

Q2: 改变了现有功能的行为?
├─ YES → 需要文档（Type A 或 D）
└─ NO → Q3

Q3: 使用了新的库/框架/技术?
├─ YES → 需要文档（Type B - ADR）
└─ NO → Q4

Q4: 改变了系统架构或设计?
├─ YES → 需要文档（Type A - PLANNING.md）
└─ NO → Q5

Q5: 引入了新的配置或部署流程?
├─ YES → 需要文档（Type C）
└─ NO → Type E（无需文档）
```

**文档类型说明**:
- **Type A**: 更新 PLANNING.md（架构变化）
- **Type B**: 创建 ADR（技术决策）
- **Type C**: 创建功能文档（API/部署）
- **Type D**: 更新 KNOWLEDGE.md（最佳实践）
- **Type E**: 无需文档（代码优化）

### 后续路径决策树（强制使用）

**AI必须根据以下决策树选择后续工作流路径**：

```
代码实现完成
  ↓
功能复杂且新增？
├─ YES → 选项 A: 先测试再审查
│   命令序列: /wf_07_test → /wf_08_review → /wf_11_commit
│
└─ NO → 修改已有代码且需要验证设计？
    ├─ YES → 选项 B: 先审查再测试
    │   命令序列: /wf_08_review → /wf_07_test → /wf_11_commit
    │
    └─ NO → 简单功能且不需要测试？
        ├─ YES → 选项 C: 直接审查
        │   命令序列: /wf_08_review → /wf_11_commit
        │
        └─ NO → 默认选项 A
```

### 标准输出模板（必须使用）

根据实现场景，AI必须使用对应的输出模板：

#### 新功能实现输出模板

```markdown
# 代码实现完成

## ✅ 实现摘要
- 功能描述: [简要说明]
- 实现模式: [标准/多代理/MCP增强]
- 修改文件: [列出所有修改的文件]
- 代码行数: [新增/修改/删除]

## 📋 功能验证
- [验证点1]: ✅ 已测试
- [验证点2]: ✅ 已测试
- [验证点3]: ✅ 已测试

## 📚 文档决策
- Step 8.1-8.5 检查结果: [Q1-Q5答案]
- 文档类型: [Type A/B/C/D/E]
- 文档操作: [已创建/已更新/无需文档]

## ⏭️ 建议下一步
- 推荐路径: 选项 A - 先测试再审查
- 理由: 功能包含复杂逻辑，需要完整测试覆盖
- 下一命令: `/wf_07_test "为 [功能] 添加单元测试"`

## 🔄 替代选项
- 选项 B: 如果需要快速验证设计
- 选项 C: 如果功能非常简单（不推荐）
```

#### Bug修复输出模板

```markdown
# Bug修复完成

## 🐛 问题描述
- 问题类型: [bug类型]
- 影响范围: [模块/组件]
- 根本原因: [简要说明]

## ✅ 修复摘要
- 修复方案: [简要说明]
- 修改文件: [列出文件]
- 测试验证: [如何验证修复]

## ⏭️ 建议下一步
- 推荐路径: 选项 B - 先审查再添加回归测试
- 下一命令: `/wf_08_review`
```

#### 重构输出模板

```markdown
# 重构完成

## 🔧 重构摘要
- 重构类型: [结构/性能/可读性]
- 影响范围: [模块/组件]
- 改进点: [列出改进]

## ✅ 验证结果
- 功能无回归: ✅ 已验证
- 性能影响: [无影响/提升X%]
- 代码质量: [改善点]

## ⏭️ 建议下一步
- 推荐路径: 选项 B - 快速审查确认
- 下一命令: `/wf_08_review`
```

### 执行检查清单（强制验证）

AI在输出结果前必须确认以下所有项：

- [ ] ✅ 已读取本执行协议
- [ ] ✅ 已根据决策树选择实现模式并明确说明理由
- [ ] ✅ 已遵循 PLANNING.md 开发标准
- [ ] ✅ 已完成代码实现且功能正常工作
- [ ] ✅ 已完成 Step 8 文档决策（Q1-Q5检查清单）
- [ ] ✅ 已根据决策树选择后续路径（A/B/C）
- [ ] ✅ 输出格式完全符合对应场景的标准模板
- [ ] ✅ 已添加明确的后续命令和替代选项
- [ ] ✅ 遵循CLAUDE.md语言规范

**如果任何检查项未通过，必须重新执行对应步骤**

### 故障排除

| 问题 | 解决方案 |
|------|---------|
| PLANNING.md不存在 | 提示运行 `/wf_01_planning` 建立开发标准 |
| TASK.md中无进行中任务 | 提示运行 `/wf_02_task update` 标记任务 |
| 需求不清晰 | 建议先运行 `/wf_04_ask` 进行架构咨询 |
| MCP工具不可用 | 自动降级到标准实现模式，警告功能可能受限 |
| 文档决策不确定 | 参考 [wf_05_code_doc_sync_guide.md](wf_05_code_doc_sync_guide.md) |
| 不知道选哪个后续路径 | 默认选择选项 A（先测试再审查） |

---

## 📌 工作流位置指示

### 完整开发流程

当使用此命令时，你正在执行标准开发流程的以下阶段：

```
[任务确认] → [架构咨询] → [代码实现 ← 当前] → [测试验证] → [代码审查] → [提交保存]
   STEP 1      STEP 2 (可选)   STEP 3        STEP 4      STEP 5     STEP 6
```

### 阶段详细说明

| 阶段 | 命令 | 职责 | 状态 |
|------|------|------|------|
| **STEP 1** | `/wf_02_task update` | 任务确认和标记 | ✅ 已完成 |
| **STEP 2** | `/wf_04_ask` | 架构咨询（可选） | ✅ 已完成（或跳过） |
| **STEP 3** | `/wf_05_code` | **代码实现** | ⏳ 当前执行 |
| **STEP 4** | `/wf_07_test` | 测试验证 | ⏭️ 下一步选项 |
| **STEP 5** | `/wf_08_review` | 代码审查 | ⏭️ 下一步选项 |
| **STEP 6** | `/wf_11_commit` | 提交保存 | ⏭️ 最终步骤 |

---

## ✅ 已完成的步骤

### 在执行 `/wf_05_code` 前，你应该已经完成：

#### 1. ✅ 任务确认 (`/wf_02_task update`)

- **职责**: 从 TASK.md 选择并标记待做任务
- **检查**:
  - ✅ TASK.md 中的任务已标记为 "进行中"
  - ✅ 任务描述清晰明确
  - ✅ 依赖任务已完成

#### 2. ✅ 架构咨询（可选，`/wf_04_ask`）

- **职责**: 获取设计指导和技术决策
- **检查**:
  - ✅ 如果需要设计指导，已运行咨询
  - ✅ 如果任务明确，可以跳过此步骤

---

## 📝 当前步骤（STEP 3）

### 正在执行: `/wf_05_code "功能描述" [--serena] [--ui]`

### 核心职责

| 职责 | 说明 | 检查清单 |
|------|------|---------|
| **遵循标准** | 符合 PLANNING.md 的开发标准 | ✅ 代码风格一致 |
| **实现功能** | 完整实现用户请求的功能 | ✅ 功能完整可用 |
| **满足需求** | 符合 PRD 要求 | ✅ 需求对齐 |
| **更新进度** | 更新 TASK.md 进度 | ✅ 状态同步 |
| **文档同步** | 完成 Phase 2 Step 8.1-8.5 | ✅ 文档已对齐 |

### 可选增强

- **--serena**: 使用 Serena MCP 进行深度代码理解和精确定位
  - 详见: [wf_05_code_serena_guide.md](wf_05_code_serena_guide.md)

- **--ui**: 使用 Magic MCP 生成交互式 UI 组件
  - 适用场景: 前端组件开发、设计系统集成

---

## ⏭️ 建议下一步

### 代码实现完成后，建议按以下顺序执行

### 选项 A：先测试再审查（推荐）✅

**适用场景**: 功能复杂且新增

```bash
# Step 4: 添加测试（如果功能较复杂）
/wf_07_test "为 [功能] 添加单元测试"

# Step 5: 代码审查
/wf_08_review

# Step 6: 提交保存进度
/wf_11_commit "feat: [功能描述]"
```

**优势**:
- ✅ 测试先行，确保代码正确性
- ✅ 审查时可以验证测试覆盖率
- ✅ 减少审查后的修改成本

---

### 选项 B：先审查再测试

**适用场景**: 功能修改已有代码

```bash
# Step 5: 代码审查
/wf_08_review

# Step 4: 根据审查意见添加测试
/wf_07_test "为 [功能] 添加测试"

# Step 6: 提交
/wf_11_commit "feat: [功能描述]"
```

**优势**:
- ✅ 快速发现设计问题
- ✅ 根据审查意见优化测试策略
- ✅ 适合对现有代码的小幅修改

---

### 选项 C：简单功能跳过测试

**适用场景**: 简单功能/文档修改

```bash
# Step 5: 代码审查
/wf_08_review

# Step 6: 提交
/wf_11_commit "feat: [功能描述]"
```

**警告**:
- ⚠️ 仅适用于非常简单的功能或文档修改
- ⚠️ 跳过测试可能导致未来回归问题
- ⚠️ 需要在 `/wf_08_review` 中充分验证

---

## 📊 工作流进度提示

### 当你完成代码实现时，确保输出中包含：

#### ✅ 已完成检查清单

- ✅ **代码实现完成**
  - 功能正常工作
  - 代码通过基本验证
  - 符合 PLANNING.md 标准

- ✅ **TASK.md 已更新**
  - 任务状态从 "进行中" → "已完成" 或 "待测试"
  - 添加完成时间和简要说明

- ✅ **代码符合 PLANNING.md 标准**
  - 命名规范正确
  - 代码风格一致
  - 注释清晰（如需要）

- ✅ **文档已同步**（Phase 2 Step 8）
  - 完成 Q1-Q5 检查
  - 确定文档类型 (A/B/C/D/E)
  - Frontmatter 验证通过
  - 成本检查通过

#### ⏭️ 下一步提示检查清单

- 📋 **显示推荐的下一个命令**
  - 根据功能复杂度选择 A/B/C 选项
  - 明确下一步的命令和参数

- 💡 **说明选择的原因**
  - 为什么推荐此选项
  - 有什么潜在风险需要注意

- 🔄 **提供替代选项**
  - 列出其他可行的工作流路径
  - 说明适用场景

---

## 💡 决策指南

### 我应该执行哪个选项？

| 情况 | 建议选项 | 命令序列 | 原因 |
|------|---------|---------|------|
| **功能复杂且新增** | 选项 A | `/wf_07_test` → `/wf_08_review` → `/wf_11_commit` | 测试先行，确保质量 |
| **功能修改已有代码** | 选项 B | `/wf_08_review` → `/wf_07_test` → `/wf_11_commit` | 快速发现设计问题 |
| **简单功能/文档修改** | 选项 C | `/wf_08_review` → `/wf_11_commit` | 减少开销 |
| **不确定** | 咨询 | `/wf_04_ask "我应该先测试还是先审查？"` | 获取具体建议 |

### 决策因素

#### 选择选项 A 的条件：

- ✅ 新增功能（非修改已有功能）
- ✅ 功能包含复杂逻辑（条件分支、循环、异步操作）
- ✅ 功能涉及外部依赖（数据库、API、文件系统）
- ✅ 功能是关键业务逻辑

#### 选择选项 B 的条件：

- ✅ 修改已有功能（非新增）
- ✅ 需要快速验证设计是否合理
- ✅ 功能涉及多个组件的集成
- ✅ 不确定测试策略，需要审查意见

#### 选择选项 C 的条件：

- ✅ 功能非常简单（如：简单的getter/setter）
- ✅ 只是文档修改或注释更新
- ✅ 功能已经过人工充分验证
- ⚠️ **注意**: 跳过测试需要在审查时充分验证

---

## 🔄 回到上一步

### 如果需要修改设计或架构

```bash
# 返回架构咨询
/wf_04_ask "需要重新讨论的架构问题..."

# 修改代码后继续当前步骤
/wf_05_code "重新实现功能..."
```

### 常见回退场景

| 场景 | 回退到 | 原因 |
|------|-------|------|
| **发现架构问题** | `/wf_04_ask` | 需要重新设计 |
| **需求不清晰** | `/wf_02_task` | 重新确认任务 |
| **依赖缺失** | `/wf_04_ask` | 咨询技术选型 |

---

## 📚 相关文档

| 文档 | 用途 | 路径 |
|------|------|------|
| **工作流指南** | 完整工作流说明 | [WORKFLOWS.md](../../WORKFLOWS.md) |
| **代码标准** | 开发规范和标准 | PLANNING.md (Development Standards) |
| **任务追踪** | 任务状态和进度 | TASK.md |
| **设计原则** | Ultrathink 设计思维 | [PHILOSOPHY.md](../../PHILOSOPHY.md) |
| **主命令文档** | `/wf_05_code` 完整说明 | [wf_05_code.md](../../wf_05_code.md) |
| **文档同步指南** | Phase 2 Step 8 详细说明 | [wf_05_code_doc_sync_guide.md](wf_05_code_doc_sync_guide.md) |
| **Serena MCP 指南** | --serena 标志使用说明 | [wf_05_code_serena_guide.md](wf_05_code_serena_guide.md) |

---

## 快速参考

### 工作流路径速查

```
代码实现完成
  ↓
┌─────────────────────────────────────┐
│ 功能复杂且新增？                    │
├─────────────────────────────────────┤
│ YES → 选项 A: /wf_07_test 先        │
│ NO  → 继续                          │
└─────────────────────────────────────┘
  ↓
┌─────────────────────────────────────┐
│ 修改已有代码且需要验证设计？        │
├─────────────────────────────────────┤
│ YES → 选项 B: /wf_08_review 先      │
│ NO  → 继续                          │
└─────────────────────────────────────┘
  ↓
┌─────────────────────────────────────┐
│ 简单功能且不需要测试？              │
├─────────────────────────────────────┤
│ YES → 选项 C: 直接审查              │
│ NO  → 默认选项 A                    │
└─────────────────────────────────────┘
```

### 常用命令组合

**完整开发流程**:
```bash
/wf_02_task update "实现用户登录功能"
/wf_04_ask "用户登录应该用 JWT 还是 Session？"  # 可选
/wf_05_code "实现用户登录功能" --serena
/wf_07_test "为用户登录功能添加单元测试"
/wf_08_review
/wf_11_commit "feat: 实现用户登录功能"
```

**快速修复流程**:
```bash
/wf_05_code "修复用户登录的错误提示"
/wf_08_review
/wf_11_commit "fix: 修复用户登录的错误提示"
```

---

## 相关内容

详见:
- [wf_05_code.md](../../wf_05_code.md) - 主命令文档
- [wf_05_code_doc_sync_guide.md](wf_05_code_doc_sync_guide.md) - 文档同步决策树
- [wf_05_code_serena_guide.md](wf_05_code_serena_guide.md) - Serena MCP 使用指南
- [WORKFLOWS.md](../../WORKFLOWS.md) - 完整工作流说明
- [KNOWLEDGE.md](../../KNOWLEDGE.md) - 知识库和决策索引
