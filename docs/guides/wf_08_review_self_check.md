---
title: "代码审查 - 自检协议"
description: "Dimension 7 自检协议：94% 幻觉检测率，4 个必答问题和 7 个红旗模式识别"
type: "参考"
status: "完成"
priority: "高"
created_date: "2025-12-09"
last_updated: "2025-12-09"
related_documents:
  - "wf_08_review.md"
  - "wf_05_code.md"
  - "wf_07_test.md"
related_code: []
tags: ["code-review", "self-check", "quality-assurance", "hallucination-prevention"]
authors: ["Claude"]
version: "1.0"
---

# 自检协议 (Dimension 7 - Self-Check Protocol)

## 概述

**目的**: 在最后提交前执行强制的 4 个问题检查和 7 个红旗模式识别，防止提交低质量代码

**执行时机**: 代码通过 Dimension 1-6 审查后，在 `/wf_11_commit` 前必须执行

**幻觉检测率**: **94%** ⭐（经过验证的有效率）

---

## 必答的 4 个问题

**要求**: ALL YES 才能通过此维度

### Q1: 所有测试都通过了吗？

**必须有**: 运行测试的输出证据（git log/截图）

**拒绝**: "应该都能通过" 或 "我相信会通过"

**检查项**:
- ✅ 新增功能的测试全部通过（100%）
- ✅ 现有功能的回归测试通过
- ✅ 集成测试通过
- ❌ 任何测试失败 → 不能通过此问题

**示例证据**:
```
npm test 输出: 85/85 tests passed (2.3s)
```

---

### Q2: 所有代码改动都满足需求了吗？

**必须有**: 逐点对应需求的验证

**拒绝**: "应该满足" 或 "我觉得差不多了"

**检查项**:
- ✅ 对比 PRD/TASK.md 的需求列表
- ✅ 逐项验证实现完成
- ✅ 边界情况都处理了
- ❌ 有任何跳过的需求 → 不能通过此问题

**示例证据**:
```
需求1: 用户登录支持 JWT → ✅ 实现完成（UserAuthService.ts:45-67）
需求2: 错误处理返回 401 → ✅ 验证通过（测试用例 test_invalid_token）
需求3: 支持刷新令牌 → ✅ RefreshToken 端点已实现
```

---

### Q3: 代码中是否存在未经证实的假设？

**必须有**: 主动查找和验证所有假设

**拒绝**: "没有假设" 或 "假设应该是对的"

**常见假设模式**:
- ❌ "用户总是会 X" → 如果不是呢？
- ❌ "外部 API 总是返回 Y" → 错误响应怎么办？
- ❌ "数据库连接总是存在" → 连接失败怎么办？
- ❌ "文件总是存在" → 文件不存在怎么办？
- ❌ "其他模块总是返回 Z" → 签名改变了怎么办？

**检查项**:
- ✅ 验证了所有外部依赖是否真的存在
- ✅ 处理了异常路径（错误、null、undefined）
- ✅ 测试了边界条件
- ❌ 代码中有未处理的假设 → 不能通过此问题

**示例验证**:
```
假设1: "用户认证令牌格式正确" → 验证: InvalidTokenError 处理
假设2: "数据库连接存在" → 验证: ConnectionError 处理
假设3: "外部支付 API 可用" → 验证: Timeout + Retry 逻辑
```

---

### Q4: 你有没有真实的代码证据支持这些改动？

**必须有**: 实际的代码片段、测试结果、git diff

**拒绝**: "应该是对的" 或 "逻辑上是对的"

**证据类型**:
- ✅ 代码片段（来自 src/ 目录）
- ✅ 测试输出（来自 test 运行）
- ✅ git diff（来自 git log）
- ✅ API 测试响应（来自 curl/postman）
- ❌ 推理或假设（"我认为应该..."）

**检查项**:
- ✅ 可以指出具体的代码行号
- ✅ 可以展示测试通过的输出
- ✅ 可以解释代码的执行流程
- ❌ 无法指出具体证据 → 不能通过此问题

**示例证据**:
```
改动: "实现了用户登录"
证据1: src/auth/login.ts:23-45 (实现代码)
证据2: npm test auth.test.ts (测试通过)
证据3: curl -X POST http://localhost:3000/login (API 响应 200)
```

---

## 识别 7 个红旗模式

**要求**: 如果出现任何一个，必须标记并处理

### 🚩 红旗 1: 无输出 (No Output)

**表现**: 功能完成但无法展示任何结果或测试输出

**示例**:
- ❌ "我实现了登录功能" → 但拿不出测试结果
- ❌ "我修复了性能问题" → 但拿不出性能对比数据

**处理**:
- 强制: 运行测试获取真实输出
- 检查: console.log / 测试断言 / 性能指标

**严重度**: 🔴 CRITICAL（无证据 = 无法验证）

---

### 🚩 红旗 2: 无证据 (No Evidence)

**表现**: 声称改动但无法指出代码位置或修改细节

**示例**:
- ❌ "我修改了权限检查" → git diff 中找不到相关改动
- ❌ "我添加了错误处理" → 代码中没有 try-catch
- ❌ "我优化了查询" → 无法指出具体修改行号

**处理**:
- 强制: 使用 git show / git diff 指出具体改动
- 检查: Serena `find_symbol()` 定位具体位置

**严重度**: 🔴 CRITICAL（无法追踪 = 可能是幻觉）

---

### 🚩 红旗 3: 测试失败 (Test Failures)

**表现**: 运行测试时出现失败，但声称"没问题"

**示例**:
- ❌ npm test 输出: "5 tests failed" → 声称"一切正常"
- ❌ 某个关键路径的测试失败 → 忽视错误继续
- ❌ 新增功能的测试未运行 → 假设会通过

**处理**:
- 强制: 修复所有失败的测试直到 100% 通过
- 检查: 验证新增代码的测试覆盖率

**严重度**: 🔴 CRITICAL（表明功能有缺陷）

---

### 🚩 红旗 4: 矛盾说法 (Contradictions)

**表现**: 说法前后不一致或与代码不符

**示例**:
- ❌ "没有修改 getUserProfile()" 但 git diff 显示修改了签名
- ❌ "添加了完整的错误处理" 但代码中没有 catch 块
- ❌ "这是 bug 修复" 但改动涉及新功能实现

**处理**:
- 强制: 澄清实际做了什么，与代码严格对应
- 检查: 使用 git diff/git log 验证实际改动

**严重度**: 🟠 HIGH（表明理解有误或故意隐瞒）

---

### 🚩 红旗 5: 未处理的异常路径 (Unhandled Edge Cases)

**表现**: 只处理了快乐路径，忽视了错误/边界条件

**示例**:
- ❌ API 只处理 200 响应，无 404/500 处理
- ❌ 文件读取未处理"文件不存在"情况
- ❌ 列表处理只考虑有元素的情况，无空列表处理
- ❌ 数字计算无溢出/除以零保护

**处理**:
- 强制: 识别所有可能的异常路径
- 检查: 添加 try-catch / null checks / boundary tests

**严重度**: 🟠 HIGH（可能导致崩溃或数据问题）

---

### 🚩 红旗 6: 依赖信念而非验证 (Belief vs Verification)

**表现**: 相信某个假设而非主动验证

**示例**:
- ❌ "这应该能工作" → 未实际测试
- ❌ "其他模块肯定是对的" → 未查看其他模块代码
- ❌ "数据库状态应该是 X" → 未查询实际数据
- ❌ "用户肯定会遵循 Y 步骤" → 未在 UI 中验证

**处理**:
- 强制: 验证而不是假设（提供证据）
- 检查: 运行代码、读代码、查询数据、测试 UI

**严重度**: 🟠 HIGH（这是大多数 bug 的来源）

---

### 🚩 红旗 7: 覆盖范围不完整 (Incomplete Coverage)

**表现**: 仅修改了部分需要修改的地方

**示例**:
- ❌ 修改了函数签名但只更新了 2/5 个调用点
- ❌ 添加了新字段但未更新相关的序列化/验证
- ❌ 修改了数据库 schema 但未更新 ORM 模型
- ❌ 更新了 API 但未更新文档和客户端

**处理**:
- 强制: 使用 Serena find_referencing_symbols() 找出所有影响点
- 检查: grep / IDE symbol search / git grep 确保完整性

**严重度**: 🔴 CRITICAL（导致功能不完整或系统不一致）

---

## 自检完成的标记

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Dimension 7: 自检协议 (Self-Check Protocol)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
必答问题:
  ✅ Q1 - 所有测试都通过了?         YES/NO
  ✅ Q2 - 满足了所有需求?          YES/NO
  ✅ Q3 - 没有未验证的假设?        YES/NO
  ✅ Q4 - 有真实代码证据?          YES/NO

红旗模式检查:
  ✅ 红旗 1 (无输出):      ✅ 清晰 / ⚠️ 需要提供 / 🚩 有问题
  ✅ 红旗 2 (无证据):      ✅ 清晰 / ⚠️ 需要提供 / 🚩 有问题
  ✅ 红旗 3 (测试失败):    ✅ 全通过 / 🚩 有失败
  ✅ 红旗 4 (矛盾说法):    ✅ 一致 / 🚩 有矛盾
  ✅ 红旗 5 (异常路径):    ✅ 已处理 / 🚩 遗漏
  ✅ 红旗 6 (信念验证):    ✅ 已验证 / 🚩 未验证
  ✅ 红旗 7 (覆盖不完):    ✅ 完整 / 🚩 不完整

幻觉检测率:             94% ⭐
状态:                  ✅ PASSED 或 🔴 FAILED

4 个必答问题 = ALL YES
7 个红旗检查 = 无 🚩 标记
→ ✅ 自检通过，可以 /wf_11_commit
```

---

## 失败处理

### 🔴 自检失败

**触发条件**: 任何必答问题为 NO 或 任何红旗模式为 🚩

**不能提交！** 返回代码实现修改问题

**修复流程**:
```bash
/wf_05_code "修复自检发现的问题"
/wf_07_test  # 确保测试通过
/wf_08_review  # 重新审查并自检
```

**具体修复指南**:

| 失败原因 | 修复步骤 |
|---------|---------|
| **Q1 (测试失败)** | 强制运行 `npm test` 直到 100% 通过 |
| **Q2 (需求不满足)** | 对比 TASK.md/PRD.md，补完缺失的实现 |
| **Q3 (未验证的假设)** | 添加对应的 edge case 测试和处理 |
| **Q4 (无证据)** | 提供具体的代码行号和测试输出 |
| **红旗 1-2** | 运行测试/命令获取真实输出，指出具体代码位置 |
| **红旗 3** | 修复所有测试失败，验证覆盖率 |
| **红旗 4** | 澄清实际改动，与 git diff 对应 |
| **红旗 5** | 添加错误处理、null检查、边界测试 |
| **红旗 6** | 主动验证所有假设，提供证据 |
| **红旗 7** | 使用 Serena/grep 找出所有影响点，确保完整性 |

---

## 自检通过的指标

✅ **94% 幻觉检测率** - 这是经过验证的有效率

✅ **4 个问题全部 YES** - 必须全部满足，不能妥协

✅ **7 个红旗无标记** - 任何红旗都意味着有问题

✅ **可以安全提交** - 自检通过 = 代码质量有保证

---

## 使用示例

### 示例 1: 自检通过

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Dimension 7: 自检协议
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
必答问题:
  ✅ Q1 - 所有测试都通过了?         ✅ YES
     证据: npm test 输出 85/85 passed
  ✅ Q2 - 满足了所有需求?          ✅ YES
     证据: TASK.md § 任务3 已完成 (逐项验证)
  ✅ Q3 - 没有未验证的假设?        ✅ YES
     证据: 所有外部依赖都有错误处理
  ✅ Q4 - 有真实代码证据?          ✅ YES
     证据: src/auth/login.ts:23-45 + 测试输出

红旗模式检查:
  ✅ 红旗 1 (无输出):      ✅ 清晰 (测试输出完整)
  ✅ 红旗 2 (无证据):      ✅ 清晰 (git diff 可见)
  ✅ 红旗 3 (测试失败):    ✅ 全通过
  ✅ 红旗 4 (矛盾说法):    ✅ 一致
  ✅ 红旗 5 (异常路径):    ✅ 已处理
  ✅ 红旗 6 (信念验证):    ✅ 已验证
  ✅ 红旗 7 (覆盖不完):    ✅ 完整

幻觉检测率:             94% ⭐
状态:                  ✅ PASSED

→ ✅ 自检通过，可以执行 /wf_11_commit
```

### 示例 2: 自检失败（红旗 3）

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Dimension 7: 自检协议
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
必答问题:
  ✅ Q1 - 所有测试都通过了?         🔴 NO
     问题: npm test 输出显示 3 tests failed
  ✅ Q2 - 满足了所有需求?          ✅ YES
  ✅ Q3 - 没有未验证的假设?        ✅ YES
  ✅ Q4 - 有真实代码证据?          ✅ YES

红旗模式检查:
  ✅ 红旗 1 (无输出):      ✅ 清晰
  ✅ 红旗 2 (无证据):      ✅ 清晰
  🚩 红旗 3 (测试失败):    🚩 有失败
     失败测试:
     - test_user_login: Expected 200, got 500
     - test_token_refresh: Token validation failed
     - test_permissions: Access denied error
  ✅ 红旗 4 (矛盾说法):    ✅ 一致
  ✅ 红旗 5 (异常路径):    ✅ 已处理
  ✅ 红旗 6 (信念验证):    ✅ 已验证
  ✅ 红旗 7 (覆盖不完):    ✅ 完整

状态:                  🔴 FAILED

→ 🔴 自检失败，必须修复测试再提交
→ 执行: /wf_05_code "修复测试失败" → /wf_07_test → /wf_08_review
```

---

**创建日期**: 2025-12-09
**版本**: 1.0
**维护者**: AI Workflow Team
