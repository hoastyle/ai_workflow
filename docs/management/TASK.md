# 任务追踪 (Task Management)

**版本**: v3.5-optimized (Phase 7 进行中 - 精简版)
**创建日期**: 2025-12-03
**最后更新**: 2025-12-21
**状态**: ⏳ Phase 7 进行中

**关键背景**:
- 项目目标: 构建/优化 AI Workflow 命令系统 (wf_01 - wf_14)
- 当前状态: Phase 7 架构优化 + Phase 6 遗留问题修复进行中
- 前期成果: Phases 1-6 已完成 (27/33 tasks)

---

## 📊 整体进度统计

| 阶段 | 任务数 | 完成 | 进度 | 状态 |
|------|--------|------|------|------|
| **Phases 1-6** | 27 | 27 | 100% | ✅ 完成 (历史记录见 docs/archive/) |
| **Phase 7** | 9 | 1 | 11% | ⏳ 进行中 (1/9 完成) |
| **总计** | 36 | 28 | 78% | ⏳ **Phase 7 进行中** |

**参考**: 完成的 Phases 1-6 详见 [docs/archive/TASK-archive-2025-Q4-phases-1-6.md](docs/archive/TASK-archive-2025-Q4-phases-1-6.md)

---

## 🚀 Phase 7: 双 CLAUDE 架构实现 + 遗留问题修复 (NEW - 2025-12-21)

**目标**: 实现反转后的双 CLAUDE.md 架构，解决 Phase 6 遗留问题

**优先级**: 🔴 **最高** - 架构优化 + 功能完整性
**工作量**: 16-20 小时 (5-7 个工作日)

### 关键问题

1. **架构**: CLAUDE.md 双文件职责分离需反转
2. **功能**: Agent 激活后无冲突处理、MCP 工具不被调用、协作路由未显示
3. **质量**: Agent 中文分词测试缺失、正则表达式未优化

### Task 7.1: 修复本地改动并提交 ✅

**状态**: ✅ 完成
**优先级**: 🔴 最高
**工作量**: 1 小时
**完成日期**: 2025-12-21
**Git 提交**: 82ed27e ([docs] Massive documentation optimization and cleanup)

**执行步骤**:
1. ✅ /wf_08_review - 审查改动 (总分 63/70, 优秀)
2. ✅ /wf_11_commit - 提交更改 (4 阶段流程完成)

**成果**:
- CLAUDE.md 精简 77% (1400+ → 323 行)
- 创建 CLAUDE_DEPLOY.md (450 行全局规则)
- 更新 install.sh 部署逻辑
- 所有维护日期已更新

### Task 7.2: 反转双 CLAUDE 架构设计 🔴

**状态**: 待开始
**优先级**: 🔴 最高
**工作量**: 3-4 小时

**架构反转方案**:

| 步骤 | 操作 | 说明 |
|------|------|------|
| 1️⃣ | 创建 CLAUDE_DEPLOY.md | 从当前 CLAUDE.md 提取全局规则 (400-500 行) |
| 2️⃣ | 调整 CLAUDE.md | 改为纯源码开发规则 (300-400 行) |
| 3️⃣ | 更新 PLANNING.md § 702-760 | 反转表格和说明 |
| 4️⃣ | 更新 install.sh | cp CLAUDE_DEPLOY.md ~/.claude/CLAUDE.md |

**关键说明**:
- **CLAUDE.md** (源码目录): 源码开发规则、目录关系、部署流程
- **CLAUDE_DEPLOY.md** (部署): 全局规则模板 → ~/.claude/CLAUDE.md
- **理由**: Claude Code 默认读取当前目录 CLAUDE.md

### Task 7.3: 创建 ADR 📋

**状态**: 待开始
**优先级**: 🔴 最高
**工作量**: 1-1.5 小时
**文件**: `docs/adr/2025-12-21-dual-claude-architecture-reversal.md`

记录双 CLAUDE 架构反转的背景、问题、决策和影响

### Task 7.4: 部署和测试 🧪

**状态**: 待开始
**优先级**: 🟠 高
**工作量**: 1 小时

验证两个场景:
1. 源码目录开发: 读取 ./CLAUDE.md (源码规则)
2. 用户项目: 读取 ~/.claude/CLAUDE.md (全局规则)

### Task 7.5: Agent 命令冲突处理 🔴

**状态**: 待开始
**优先级**: 🔴 最高
**工作量**: 2-3 小时

**问题**: Agent 虽激活但建议命令被忽视
**解决**: 实现冲突检测 + 三选项提示

相关文件更新:
- `commands/lib/agent_coordinator.py` (新增 detect_command_conflict())
- 5 个命令文件 (wf_05_code, wf_06_debug, wf_07_test, wf_08_review, wf_09_refactor)

### Task 7.6: MCP 工具强制使用 🟠

**状态**: 待开始
**优先级**: 🟠 高
**工作量**: 2-3 小时

**问题**: Agent 推荐的 MCP 工具从不被调用
**解决**: 按优先级自动启用推荐工具

- 增强 `extract_mcp_recommendations()` 方法
- 命令执行时自动启用 Agent top-2 推荐
- 输出中清晰显示使用的 MCP 工具

### Task 7.7: Agent 协作路由显示 🟡

**状态**: 待开始
**优先级**: 🟡 中
**工作量**: 1-1.5 小时

**问题**: Agent 协作建议未被显示
**解决**: 在命令输出中添加协作路由建议

### Task 7.8: Agent 中文分词单元测试 🧪

**状态**: 待开始
**优先级**: 🔴 最高
**工作量**: 2 小时

**目标**: 覆盖率 ≥80% (agent_registry.py:176-272)

- 中文关键词匹配测试 (40% 阈值)
- 中文场景匹配测试 (60% 阈值)
- 混合语言场景测试
- 空字符串和特殊字符测试

### Task 7.9: 正则表达式预编译优化 ⚡

**状态**: 待开始
**优先级**: 🟠 高
**工作量**: 1.5 小时

**目标**: 性能提升 ≥20%

- 在 agent_registry.py 模块顶部预编译所有正则表达式
- 添加性能基准测试 (benchmark)
- 验证优化效果

---

## 📋 Phase 7 进度追踪

| 任务 | 优先级 | 状态 | 预期工时 | 完成日期 |
|------|--------|------|---------|----------|
| Task 7.1: 修复本地改动 | 🔴 最高 | ✅ 完成 | 1h | 2025-12-21 |
| Task 7.2: 反转双 CLAUDE 架构 | 🔴 最高 | 待开始 | 3-4h | - |
| Task 7.3: 创建 ADR | 🔴 最高 | 待开始 | 1-1.5h | - |
| Task 7.4: 部署和测试 | 🟠 高 | 待开始 | 1h | - |
| Task 7.5: Agent 冲突处理 | 🔴 最高 | 待开始 | 2-3h | - |
| Task 7.6: MCP 强制使用 | 🟠 高 | 待开始 | 2-3h | - |
| Task 7.7: 协作路由显示 | 🟡 中 | 待开始 | 1-1.5h | - |
| Task 7.8: 中文分词测试 | 🔴 最高 | 待开始 | 2h | - |
| Task 7.9: 正则优化 | 🟠 高 | 待开始 | 1.5h | - |

**总计**: 16-20 小时

---

## 🎯 推荐执行路径

### 顺序执行 (推荐)

```
Day 1 (6-7h):
  1. Task 7.1: 修复本地改动 (1h)
  2. Task 7.2: 反转双 CLAUDE (3-4h)
  3. Task 7.3: 创建 ADR (1-1.5h)
  4. Task 7.4: 部署测试 (1h)

Day 2-3 (5-6h):
  5. Task 7.5: Agent 冲突 (2-3h)
  6. Task 7.6: MCP 强制使用 (2-3h)
  7. Task 7.7: 协作路由 (1-1.5h)

Day 4 (3-4h):
  8. Task 7.8: 中文测试 (2h)
  9. Task 7.9: 正则优化 (1.5h)

Day 5 (1-2h):
  最终审查和提交
```

---

## 📈 项目成就总结

### 已完成 (Phases 1-6)
- ✅ 4 个 Phase 1 任务: 智能上下文加载系统
- ✅ 12 个 Phase 2 任务: Workflow 全面优化
- ✅ 3 个 Phase 3 任务: Token 紧急优化 (节省 31K+)
- ✅ 3 个 Phase 4 任务: Agent 架构设计 (10 agents)
- ✅ 2 个 Phase 5 任务: MCP 深度集成 (14/14 命令)
- ✅ 3 个 Phase 6 任务: 问题分析和基础准备

### 进行中 (Phase 7)
- 双 CLAUDE 架构反转
- Agent 系统改进 (3 个功能)
- 代码质量优化 (2 个任务)

---

**维护者**: AI Workflow System
**版本**: v3.5-optimized (精简版本)
**最后更新**: 2025-12-21
