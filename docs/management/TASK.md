# 任务追踪 (Task Management)

**版本**: v3.5-optimized (Phase 7 + Agent 路径 2 进行中 - 精简版)
**创建日期**: 2025-12-03
**最后更新**: 2025-12-23
**状态**: ⏳ Phase 7 + Agent 路径 2 进行中

**关键背景**:
- 项目目标: 构建/优化 AI Workflow 命令系统 (wf_01 - wf_14) + Agent 执行系统
- 当前状态: Phase 7 架构优化进行中 + Agent 路径 2 核心功能实现中 (Phase 2.1 完成)
- 前期成果: Phases 1-6 已完成 (27/33 tasks) + Agent 路径 2 Phase 2.1 完成

---

## 📊 整体进度统计

| 阶段 | 任务数 | 完成 | 进度 | 状态 |
|------|--------|------|------|------|
| **Phases 1-6** | 27 | 27 | 100% | ✅ 完成 (历史记录见 docs/archives/) |
| **Phase 7** | 15 | 1 | 7% | ⏳ 进行中 (1/15 完成) |
| **Agent 路径 2** | 5 | 1 | 20% | ⏳ 进行中 (Phase 2.1 完成) |
| **总计** | 47 | 29 | 62% | ⏳ **Phase 7 + Agent 路径 2 进行中** |

**参考**:
- 完成的 Phases 1-6 详见 [docs/archive/TASK-archive-2025-Q4-phases-1-6.md](docs/archive/TASK-archive-2025-Q4-phases-1-6.md)
- Agent 路径 2 设计详见 [docs/adr/2025-12-23-agent-execution-system-redesign.md](docs/adr/2025-12-23-agent-execution-system-redesign.md)

---

## 🎯 Agent 路径 2: 执行系统重构 (NEW - 2025-12-23)

**目标**: 实现完整的 Agent 执行流程（决策→执行→反馈）

**优先级**: 🔴 **最高** - Agent 激活系统核心功能
**总工作量**: 35-45 小时 (2-3 周)
**进度**: 1/5 阶段完成 (20%)

### Phase 2.1: 决策引擎 ✅ **完成**

**状态**: ✅ 完成
**完成日期**: 2025-12-23
**工作量**: 8-10 小时
**Git 提交**: 59a5311, b07de35

**成果**:
- ✅ agent_decision_engine.py (431 行，7 个核心方法)
- ✅ test_agent_decision_engine.py (450 行，23 个单元测试)
- ✅ agent_coordinator.py 集成 (83 行代码)
- ✅ 43 个相关测试全部通过

**实现的功能**:
- 三层决策模式 (高置信度 auto / 中等置信度 prompt / 低置信度 info)
- 关键词匹配 (40%) + 上下文匹配 (20%) + 置信度 (40%)
- 决策历史记录和错误处理

### Phase 2.2: 执行器 📋 **待实现**

**状态**: 📋 设计完成，待实现
**预计工作量**: 10-12 小时
**优先级**: 🔴 最高

**任务**:
- [ ] 设计执行结果数据结构
- [ ] 实现 AgentCommandExecutor 类
- [ ] 集成 MCP 工具自动加载
- [ ] 实现执行超时和错误处理
- [ ] 编写 8-10 个集成测试

**预期代码量**: ~400 行

### Phase 2.3-2.5: 反馈系统 + 协调 + 集成 📋

**状态**: 📋 设计完成，依次待实现
**总预计工作量**: 22-23 小时

---

## 🚀 Phase 7: 双 CLAUDE 架构实现 + 遗留问题修复 (NEW - 2025-12-21)

**目标**: 实现反转后的双 CLAUDE.md 架构，解决 Phase 6 遗留问题

**优先级**: 🔴 **最高** - 架构优化 + 功能完整性
**工作量**: 16-20 小时 (5-7 个工作日)

### 关键问题

1. **架构**: CLAUDE.md 双文件职责分离需反转
2. **功能**: Agent 激活后无冲突处理、MCP 工具不被调用、协作路由未显示
3. **质量**: Agent 中文分词测试缺失、正则表达式未优化

### Task 7.1: 修复本地改动并提交 ✅

**状态**: ✅ 完成
**优先级**: 🔴 最高
**工作量**: 1 小时
**完成日期**: 2025-12-21
**Git 提交**: 82ed27e ([docs] Massive documentation optimization and cleanup), c93fde6 ([feat] 添加智能文档管理工具脚本)

**执行步骤**:
1. ✅ /wf_08_review - 审查改动 (总分 63/70, 优秀)
2. ✅ /wf_11_commit - 提交更改 (4 阶段流程完成)

**成果**:
- CLAUDE.md 精简 77% (1400+ → 323 行)
- 创建 CLAUDE_DEPLOY.md (450 行全局规则)
- 更新 install.sh 部署逻辑
- 所有维护日期已更新

### Task 7.2: 反转双 CLAUDE 架构设计 🔴

**状态**: 待开始
**优先级**: 🔴 最高
**工作量**: 3-4 小时

**架构反转方案**:

| 步骤 | 操作 | 说明 |
|------|------|------|
| 1️⃣ | 创建 CLAUDE_DEPLOY.md | 从当前 CLAUDE.md 提取全局规则 (400-500 行) |
| 2️⃣ | 调整 CLAUDE.md | 改为纯源码开发规则 (300-400 行) |
| 3️⃣ | 更新 PLANNING.md § 702-760 | 反转表格和说明 |
| 4️⃣ | 更新 install.sh | cp CLAUDE_DEPLOY.md ~/.claude/CLAUDE.md |

**关键说明**:
- **CLAUDE.md** (源码目录): 源码开发规则、目录关系、部署流程
- **CLAUDE_DEPLOY.md** (部署): 全局规则模板 → ~/.claude/CLAUDE.md
- **理由**: Claude Code 默认读取当前目录 CLAUDE.md

### Task 7.3: 创建 ADR 📋

**状态**: 待开始
**优先级**: 🔴 最高
**工作量**: 1-1.5 小时
**文件**: `docs/adr/2025-12-21-dual-claude-architecture-reversal.md`

记录双 CLAUDE 架构反转的背景、问题、决策和影响

### Task 7.4: 部署和测试 🧪

**状态**: 待开始
**优先级**: 🟠 高
**工作量**: 1 小时

验证两个场景:
1. 源码目录开发: 读取 ./CLAUDE.md (源码规则)
2. 用户项目: 读取 ~/.claude/CLAUDE.md (全局规则)

### Task 7.5: Agent 命令冲突处理 🔴

**状态**: 待开始
**优先级**: 🔴 最高
**工作量**: 2-3 小时

**问题**: Agent 虽激活但建议命令被忽视
**解决**: 实现冲突检测 + 三选项提示

相关文件更新:
- `commands/lib/agent_coordinator.py` (新增 detect_command_conflict())
- 5 个命令文件 (wf_05_code, wf_06_debug, wf_07_test, wf_08_review, wf_09_refactor)

### Task 7.6: MCP 工具强制使用 🟠

**状态**: 待开始
**优先级**: 🟠 高
**工作量**: 2-3 小时

**问题**: Agent 推荐的 MCP 工具从不被调用
**解决**: 按优先级自动启用推荐工具

- 增强 `extract_mcp_recommendations()` 方法
- 命令执行时自动启用 Agent top-2 推荐
- 输出中清晰显示使用的 MCP 工具

### Task 7.7: Agent 协作路由显示 🟡

**状态**: 待开始
**优先级**: 🟡 中
**工作量**: 1-1.5 小时

**问题**: Agent 协作建议未被显示
**解决**: 在命令输出中添加协作路由建议

### Task 7.8: Agent 中文分词单元测试 🧪

**状态**: 待开始
**优先级**: 🔴 最高
**工作量**: 2 小时

**目标**: 覆盖率 ≥80% (agent_registry.py:176-272)

- 中文关键词匹配测试 (40% 阈值)
- 中文场景匹配测试 (60% 阈值)
- 混合语言场景测试
- 空字符串和特殊字符测试

### Task 7.9: 正则表达式预编译优化 ⚡

**状态**: 待开始
**优先级**: 🟠 高
**工作量**: 1.5 小时

**目标**: 性能提升 ≥20%

- 在 agent_registry.py 模块顶部预编译所有正则表达式
- 添加性能基准测试 (benchmark)
- 验证优化效果

---

## 📋 Phase 7 进度追踪

| 任务 | 优先级 | 状态 | 预期工时 | 完成日期 |
|------|--------|------|---------|----------|
| Task 7.1: 修复本地改动 | 🔴 最高 | ✅ 完成 | 1h | 2025-12-21 |
| **Task 7.2: 反转双 CLAUDE 架构** | 🔴 最高 | 待开始 | 3-4h | - |
| **Task 7.3: 创建 ADR** | 🔴 最高 | 待开始 | 1-1.5h | - |
| **Task 7.4: 部署和测试** | 🟠 高 | 待开始 | 1h | - |
| **Task 7.5.1: TASK.md 存档** | 🔴 最高 | 待开始 | 1-2h | - |
| **Task 7.5.2: 创建存档索引** | 🔴 最高 | 待开始 | 0.5-1h | - |
| **Task 7.5.3: 更新 KNOWLEDGE.md** | 🟡 中 | 待开始 | 0.5h | - |
| **Task 7.5.4: 创建配置文件** | 🟡 中 | 待开始 | 0.5h | - |
| **Task 7.5.5: 开发检查脚本** | 🟡 中 | 待开始 | 2-3h | - |
| **Task 7.5.6: 创建 ADR 文档** | 🟢 低 | 待开始 | 1-1.5h | - |
| Task 7.6: Agent 冲突处理 | 🔴 最高 | 待开始 | 2-3h | - |
| Task 7.7: MCP 强制使用 | 🟠 高 | 待开始 | 2-3h | - |
| Task 7.8: 协作路由显示 | 🟡 中 | 待开始 | 1-1.5h | - |
| Task 7.9: 中文分词测试 | 🔴 最高 | 待开始 | 2h | - |
| Task 7.10: 正则优化 | 🟠 高 | 待开始 | 1.5h | - |

**总计**: 20-28 小时 (包含 6 个新的文档管理任务)

---

## 🆕 Phase 7.5: 文档大小闭环维护系统 (NEW - 2025-12-22)

**背景**: /wf_04_ask 完成了系统架构设计，确认三个工具（doc_limits.yaml, check_doc_size.sh, archive_smart.py）已实现，需要集成到 wf_xx 命令中形成闭环

**目标**: 实现 doc_limits.yaml + check_doc_size.sh + archive_smart.py + wf_xx 的完整闭环自动化

**优先级**: 🔴 **最高** - 解决当前 TASK.md (428行) 和 PLANNING.md (375行) 超限问题

**工作量**: 9-13 小时 (P0: 4.5-6.5h, P1: 2.5-3.5h, P2: 2-3h)

**关键决策**: 混合式集成 (三触发点 + 自动检查 + 用户控制)

### P0 - Task 7.5.7: 扩展 /wf_13_doc_maintain 命令 ⚙️

**状态**: 待开始
**优先级**: 🔴 最高
**工作量**: 2-3 小时

**执行步骤**:
1. 修改 `commands/wf_13_doc_maintain.md` 添加 check/archive 子命令
2. 实现子命令处理逻辑
3. 集成 archive_smart.py 和 check_doc_size.sh
4. 添加 KNOWLEDGE.md 索引自动更新

**接受标准**:
- [ ] check 子命令正常工作
- [ ] archive <文档> 执行完整流程
- [ ] KNOWLEDGE.md 自动更新
- [ ] 已测试

### P0 - Task 7.5.8: 集成 /wf_11_commit 文档检查 ✅

**状态**: 待开始
**优先级**: 🔴 最高
**工作量**: 1.5-2 小时

**执行步骤**:
1. 在 wf_11_commit 的 git add 之后添加检查步骤
2. 运行 check_doc_size.sh，显示警告但不阻止
3. 提示用户使用 /wf_13_doc_maintain archive

**接受标准**:
- [ ] 提交前自动运行 check_doc_size.sh
- [ ] 显示清晰警告
- [ ] 不阻止提交流程
- [ ] 已测试

### P0 - Task 7.5.9: 增强 /wf_03_prime 启动检查 🎯

**状态**: 待开始
**优先级**: 🔴 最高
**工作量**: 1-1.5 小时

**执行步骤**:
1. 在 wf_03_prime 最后添加健康检查
2. 运行 check_doc_size.sh 显示文档状态
3. 集成到标准输出模板

**接受标准**:
- [ ] 启动时自动显示文档健康状态
- [ ] 清晰的状态输出
- [ ] 已集成到标准模板
- [ ] 已测试

### P1-P2 任务 (7.5.10-7.5.14)

- Task 7.5.10: 完善错误处理 (1.5-2h)
- Task 7.5.11: 添加 dry-run 模式 (1-1.5h)
- Task 7.5.12: Pre-commit Hook (1.5h)
- Task 7.5.13: 批量存档命令 (1.5-2h)
- Task 7.5.14: 存档历史查询 (1.5h)

**P0 合计**: 4.5-6.5 小时
**P1 合计**: 2.5-3.5 小时
**P2 合计**: 2-3 小时

---

**新总计**: 原有 Phase 7 (20-28h) + 闭环维护 (9-13h) = **29-41 小时**

---

## 🎯 推荐执行路径

### 并行执行路径 (推荐，充分利用时间)

#### 路径 A: 架构优化 (Task 7.2-7.4) [3-5.5h]
```
1. Task 7.2: 反转双 CLAUDE 架构 (3-4h)
2. Task 7.3: 创建 ADR (1-1.5h)
3. Task 7.4: 部署和测试 (1h)
```

#### 路径 B: 文档管理优化 (Task 7.5.1-7.5.6) [6-11h] ⭐ 立即优先
```
优先级 P0 (本周 - 立即执行):
  1. Task 7.5.1: TASK.md 存档 (1-2h) - 当前最紧急
  2. Task 7.5.2: 创建存档索引 (0.5-1h)
  3. Task 7.5.3: 更新 KNOWLEDGE.md (0.5h)

优先级 P1 (下周):
  4. Task 7.5.4: 创建配置文件 (0.5h)
  5. Task 7.5.5: 开发检查脚本 (2-3h)
  6. Task 7.5.6: 创建 ADR 文档 (1-1.5h)
```

#### 路径 C: Agent 和性能优化 (Task 7.6-7.10) [11-14.5h]
```
1. Task 7.6: Agent 冲突处理 (2-3h)
2. Task 7.7: MCP 强制使用 (2-3h)
3. Task 7.8: 协作路由显示 (1-1.5h)
4. Task 7.9: 中文分词测试 (2h)
5. Task 7.10: 正则优化 (1.5h)
```

### 推荐执行顺序

**Week 1 (本周)**:
1. ✅ Task 7.1: 修复本地改动 (已完成)
2. 🔴 **Task 7.5.1-7.5.3**: 文档管理紧急优化 (2-4h)
3. Task 7.2: 反转双 CLAUDE (3-4h)
4. Task 7.3: 创建 ADR (1-1.5h)

**Week 2 (下周)**:
5. Task 7.4: 部署测试 (1h)
6. Task 7.5.4-7.5.6: 文档管理规范化 (3-5.5h)
7. Task 7.6-7.7: Agent 功能增强 (4-6h)

**Week 3+ (后续)**:
8. Task 7.8-7.10: 代码质量优化 (5.5-7h)
9. 最终审查和 Phase 7 总结

**总工作量**: 20-28 小时 (2-3 周，每周 8-10 小时)

### Task 7.5: 文档管理优化 📚

**状态**: 待开始
**优先级**: 🔴 最高 (当前 TASK.md 已超限)
**工作量**: 4-5 小时
**背景**: TASK.md 当前 222 行，超过 200 行限制，需要实施分层存档机制

#### Task 7.5.1: TASK.md 存档 (Phase 1-5) 📦

**状态**: 待开始
**优先级**: 🔴 最高 (当前最紧急)
**工作量**: 1-2 小时
**目标**: 将 TASK.md 从 222 行降至 ~150 行

**执行步骤**:
1. 创建 `docs/archives/tasks/` 目录
2. 提取 TASK.md 中的 Phase 1-5 详细内容
3. 保存为 `docs/archives/tasks/2025-q4-phases-1-5.md`
4. 更新 TASK.md 删除详细历史任务
5. 在 TASK.md 中添加存档索引链接

**接受标准**:
- [ ] TASK.md 行数 ≤200
- [ ] 所有 Phase 1-5 历史任务已移至存档
- [ ] 存档文件包含完整的任务详情
- [ ] 主文档包含指向存档的链接

**相关文件**:
- docs/management/TASK.md (修改)
- docs/archives/tasks/2025-q4-phases-1-5.md (新建)

#### Task 7.5.2: 创建存档索引 🔍

**状态**: 待开始
**优先级**: 🔴 最高
**工作量**: 30min - 1h
**目标**: 为存档文件建立索引和导航

**执行步骤**:
1. 创建 `docs/archives/tasks/index.md`
   - 存档文件列表和时间范围
   - 主要内容摘要
   - 快速查找关键词
2. 创建 `docs/archives/planning/index.md`
3. 创建 `docs/archives/context/index.md`

**接受标准**:
- [ ] 三个 index.md 文件已创建
- [ ] 包含清晰的存档列表和导航
- [ ] 支持快速搜索关键信息

**相关文件**:
- docs/archives/*/index.md (新建，3 个)

#### Task 7.5.3: 更新 KNOWLEDGE.md 📖

**状态**: 待开始
**优先级**: 🟡 中
**工作量**: 30min
**目标**: 在 KNOWLEDGE.md 中添加历史档案指针

**执行步骤**:
1. 在 KNOWLEDGE.md 添加 "历史档案" 章节
2. 链接到 docs/archives/*/index.md
3. 提供快速访问说明

**接受标准**:
- [ ] KNOWLEDGE.md 包含 "历史档案" 章节
- [ ] 所有存档索引链接有效
- [ ] 支持快速定位历史信息

**相关文件**:
- KNOWLEDGE.md (修改)

#### Task 7.5.4: 创建配置文件 ⚙️

**状态**: 待开始
**优先级**: 🟡 中 (属于 Phase 3)
**工作量**: 30min
**目标**: 建立文档管理规范配置

**执行步骤**:
1. 创建 `.claude/doc_limits.yaml`
2. 定义各文档的行数限制
3. 定义存档规则和保留策略
4. 定义存档触发条件

**配置内容** (参见 PLANNING.md):
```yaml
document_limits:
  "docs/management/TASK.md": 200
  "docs/management/PLANNING.md": 300
  "docs/management/CONTEXT.md": 50
  "KNOWLEDGE.md": 200

archive_rules:
  TASK.md:
    keep_recent: 2
    archive_path: "docs/archives/tasks"
    archive_by: "phase"
```

**接受标准**:
- [ ] 配置文件创建成功
- [ ] 包含所有管理文档的限制定义
- [ ] 符合 YAML 格式

**相关文件**:
- .claude/doc_limits.yaml (新建)

#### Task 7.5.5: 开发检查脚本 🔧

**状态**: 待开始
**优先级**: 🟡 中 (属于 Phase 3)
**工作量**: 2-3h
**目标**: 实现自动文档大小检查机制

**执行步骤**:
1. 创建 `scripts/check_doc_size.sh`
2. 读取 `.claude/doc_limits.yaml` 配置
3. 检查文档行数
4. 触发警告和建议
5. 完整测试脚本功能

**脚本功能**:
- 读取配置文件
- 检查各文档行数
- 如果超过限制 80%，发出警告
- 提供存档建议
- 错误处理和日志

**接受标准**:
- [ ] 脚本可以成功读取配置
- [ ] 正确检查文档行数
- [ ] 发出清晰的警告信息
- [ ] 提供可行的存档建议
- [ ] 经过完整测试

**相关文件**:
- scripts/check_doc_size.sh (新建)

#### Task 7.5.6: 创建 ADR 文档 📝

**状态**: 待开始
**优先级**: 🟢 低
**工作量**: 1-1.5h
**目标**: 记录文档管理优化的架构决策

**文件**: `docs/adr/2025-12-21-document-size-limits-and-archival.md`

**ADR 内容**:
1. **背景**: 文档持续增长影响可读性和加载性能
2. **问题**: TASK.md 已超过建议行数限制
3. **决策**: 采用分层文档管理架构（活跃 + 存档 + 索引）
4. **理由**:
   - 提高文档可读性（减少滚动和查找时间）
   - 降低 token 消耗
   - 强制保持文档聚焦
5. **权衡**:
   - 优势：可读性、性能、维护聚焦
   - 劣势：维护成本增加、需要额外工具
6. **参考**: ADR 2025-11-15（CONTEXT.md 指针文档模式）

**接受标准**:
- [ ] ADR 文件创建
- [ ] 包含标准 ADR 格式（背景、问题、决策、理由、权衡）
- [ ] 链接到相关文档
- [ ] 符合项目 ADR 规范

**相关文件**:
- docs/adr/2025-12-21-document-size-limits-and-archival.md (新建)

---

## 📈 项目成就总结

### 已完成 (Phases 1-6)
- ✅ 4 个 Phase 1 任务: 智能上下文加载系统
- ✅ 12 个 Phase 2 任务: Workflow 全面优化
- ✅ 3 个 Phase 3 任务: Token 紧急优化 (节省 31K+)
- ✅ 3 个 Phase 4 任务: Agent 架构设计 (10 agents)
- ✅ 2 个 Phase 5 任务: MCP 深度集成 (14/14 命令)
- ✅ 3 个 Phase 6 任务: 问题分析和基础准备

### 进行中 (Phase 7)
- 双 CLAUDE 架构反转
- Agent 系统改进 (3 个功能)
- 代码质量优化 (2 个任务)

---

**维护者**: AI Workflow System
**版本**: v3.7-updated (添加 Phase 7.5 闭环维护系统架构)
**最后更新**: 2025-12-22 (添加 Task 7.5.7-7.5.14, 完整的闭环维护系统设计)
