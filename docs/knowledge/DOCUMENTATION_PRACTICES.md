---
title: "文档生成最佳实践"
description: "约束驱动的文档生成系统和最佳实践指南"
type: "教程"
status: "完成"
priority: "高"
created_date: "2025-11-23"
last_updated: "2025-11-23"
related_documents:
  - ../../docs/reference/FRONTMATTER.md
  - ../../docs/adr/2025-11-18-constraint-driven-documentation-generation.md
tags:
  - documentation
  - best-practices
  - constraints
authors:
  - Claude Code
version: "1.0"
---

## 约束驱动的文档生成

**核心理念**: 在文档生成时就内置约束，而非事后清理

## 三个关键工作流

### 1. /wf_05_code Step 8: 文档同步决策树

在代码完成后**必须**执行的文档决策流程

**步骤顺序**:
1. 文档变更范围确定 (5项检查清单)
2. 按层级路由文档 (5种类型A-E)
3. 自动更新文档索引
4. 成本检查门控 (强制约束)
5. 决策记录到 git commit
6. 工作流连接到测试/审查

**文档分类** (自动路由):
| 类型 | 信号 | 位置 | 约束 |
|------|------|------|------|
| A | 项目级架构改动 | PLANNING.md | < 50行 |
| B | 设计决策 | docs/adr/ | < 200行 |
| C | API/功能文档 | docs/ | < 500行 |
| D | 常见问题 | KNOWLEDGE.md FAQ | < 50行 |
| E | 无需文档 | - | - |

**关键约束** (成本门控):
- KNOWLEDGE.md < 200 行（仅索引）
- 新文档 < 500 行（单文件）
- ADR < 200 行（设计记录）
- docs/ 增长 < 30%
- KNOWLEDGE.md 增长 < 20%

### 2. /wf_08_review Dimension 6: 文档架构合规性

代码审查时的第 6 个维度，强制检查文档质量

**6 项检查** (必须全部通过):
1. 分层正确性 - 文档位置符合四层架构？
2. 成本控制 - 文档大小符合约束？
3. Frontmatter 完整性 - 有完整元数据？
4. 内容重复 - 有重复内容吗？
5. 指针关系 - 跨层链接清晰？
6. 审查合规 - 从代码提取，有示例？

**评分等级**:
- 5/5: 优秀 (所有项通过)
- 4/5: 良好 (关键项通过)
- 3/5: 及格 (有改进空间)
- 2/5: 需改进 (2+项不符)
- 1/5: 拒绝 (严重违反)

### 3. /wf_14_doc: 约束驱动的生成流程

文档生成时的成本估计、分层建议和门控检查

**工作流**:
1. 分析和分层建议 (自动)
2. 成本估计和门控 (自动)
3. 交互式用户确认
4. 生成 + 约束检查
5. 最后确认和提示

## 最佳实践清单

**写代码时**:
- [ ] 新增 API/函数了吗？→ 需要 C 类文档
- [ ] 改变了架构？→ 需要 A 类文档 + B 类 ADR
- [ ] 引入了新技术？→ 需要 B 类 ADR
- [ ] 解决了常见问题？→ 提议 D 类 FAQ

**完成代码后** (Step 8):
- [ ] 执行 Step 8.1-8.5 检查清单
- [ ] 通过成本检查门控
- [ ] 更新 git commit message 记录文档决策

**审查代码时** (Dimension 6):
- [ ] 文档位置是否正确？
- [ ] 文档大小是否符合约束？
- [ ] Frontmatter 是否完整？
- [ ] 有无重复内容？
- [ ] 跨层链接是否清晰？
- [ ] 文档是否准确反映代码？

## 常见错误和解决方案

**❌ 错误 1**: KNOWLEDGE.md 增长超过 20%
- **原因**: 添加了太多 FAQ 或决策记录
- **解决**: 拆分到 docs/knowledge/FAQ.md
- **预防**: 月末批量审查合并，不要频繁更新

**❌ 错误 2**: 新文档超过 500 行
- **原因**: 试图在一个文件中包含所有内容
- **解决**: 分拆成多个 < 500 行的文件
- **预防**: Step 8.4 会自动检查并拒绝

**❌ 错误 3**: 内容重复在多个地方
- **原因**: 同一概念在 KNOWLEDGE.md 和 docs/ 都有说明
- **解决**: 用指针替代复制 (KNOWLEDGE.md → 指针 → docs/)
- **预防**: Dimension 6 的重复检查会识别

**❌ 错误 4**: Frontmatter 不完整
- **原因**: 手工创建文档，忘记添加元数据
- **解决**: 运行 `python scripts/frontmatter_utils.py validate docs/`
- **预防**: Step 8.3 会自动验证

**❌ 错误 5**: 文档与代码不一致
- **原因**: 生成文档后又改了代码，文档未更新
- **解决**: 将文档放在 Frontmatter 的 related_code 字段，审查时一起更新
- **预防**: 在 commit message 中明确关联代码和文档

## 工作流对齐

**当前改进** (2025-11-18):
```
代码实现
  ↓
[内置 Step 8 约束] ← /wf_05_code
  ├─ 范围确定
  ├─ 自动分层
  ├─ 成本检查
  └─ 决策记录
  ↓
[Dimension 6 审查] ← /wf_08_review
  ├─ 分层验证
  ├─ 成本复查
  ├─ 质量检查
  └─ 通过/拒绝
  ↓
[提交保存]
```

**效果**:
- 从 "先生成后清理" → "源头防控"
- 减少月度清理时间 90%
- 文档增长可预测和可控
- 开发者在源头就知道文档方向
