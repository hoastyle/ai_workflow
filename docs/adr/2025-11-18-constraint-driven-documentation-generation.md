---
title: "约束驱动的文档生成系统：从被动清理到主动防控"
status: "Accepted"
date: "2025-11-18"
author: "Claude Code"
category: "Documentation Architecture"
---

# ADR: 约束驱动的文档生成系统

## 问题陈述 (Problem Statement)

### 背景

项目采用四层文档架构，但存在根本的成本管理问题：

- 文档在开发过程中不断增长，没有约束
- 文档清理和整理是"事后"工作，被动且反复
- 每次 `/wf_03_prime` 加载的上下文成本逐渐上升
- 当文档超过预算时，需要 `/clear` compact，工作流中断

**当前流程**:
```
写代码 → 生成文档 → 事后整理 → 上下文膨胀 → 定期清理
  ↓        ↓          ↓          ↓           ↓
优化    随意生成    重复做    困境发生      急救
```

### 核心矛盾

- 系统设计提倡分层管理 (四层架构) ✅
- 但生成文档时没有强制约束 ❌
- 导致分层形同虚设，逐渐混乱和膨胀

**关键数据**:
- 当前管理层文档: ~1,433 行
- 3 个月后预测: 3,000+ 行（膨胀率 > 100%）
- 1 年后: 上下文爆炸，频繁 `/clear` 中断
- Token 成本增长：线性上升，无上限

---

## 解决方案评估 (Options Considered)

### 选项 1: 维持现状 + 定期手工清理
**原理**: 继续生成，定期审查和整理

**优点**:
- 无需改变当前工作流
- 开发者自由度高

**缺点**:
- ❌ 清理成为常态，需要大量人工投入
- ❌ 文档增长不可控，预测困难
- ❌ 工作流反复中断 (`/clear` compact)
- ❌ 长期成本高，问题只是延迟

**成本**: 每个月 1-2 小时清理工作 × 12 个月 = 年 12-24 小时

### 选项 2: 严格的文档审查流程
**原理**: 在 `/wf_08_review` 中强制执行文档约束检查

**优点**:
- ✅ 可以防止某些超限文档
- ✅ 成本控制有看得见的门控

**缺点**:
- ⚠️ 仅在审查时执行，不在生成时执行
- ⚠️ 开发者可能已经生成了 1000 行文档，审查时再拒绝
- ⚠️ 反馈延迟，改进成本高
- ⚠️ 需要手工修复不符合约束的文档

**成本**: 审查时发现问题 → 返工 → 重新审查 (浪费)

### 选项 3: 约束驱动的生成系统 ✅ **推荐**
**原理**: 在文档生成时就植入分层、成本控制、质量检查约束

**核心思想**:
1. `/wf_05_code` Step 8: 生成时自动分类和约束
2. `/wf_08_review` Dimension 6: 审查时再次验证
3. `/wf_14_doc`: 生成流程中的成本门控

**约束点**:
```
代码实现 → [内置检查清单]
         → [自动分层决策]
         → [成本门控检查]
         → [通过/失败]
              ↓
           ✅ 通过 → 进入测试和审查
           ❌ 失败 → 提示修改方案，拒绝提交
```

**优点**:
- ✅ **主动防控**: 在源头就拒绝超限文档，而非事后清理
- ✅ **自动化**: 减少人工判断和返工
- ✅ **可预测**: 文档增长有明确上限，cost 可控
- ✅ **一次做对**: 开发者在生成时就知道约束
- ✅ **分层清晰**: 强制正确的分层，不会混乱
- ✅ **成本稳定**: 即使项目增长 10 倍，管理成本不变

**缺点**:
- ⚠️ 需要修改 3 个核心命令 (/wf_05_code, /wf_08_review, /wf_14_doc)
- ⚠️ 需要明确定义约束阈值
- ⚠️ 开发者需要学习新的文档决策树

**成本**: 一次性实施成本 4-6 小时 + 维护成本极低

---

## 决策 (Decision)

**选择选项 3: 约束驱动的生成系统**

### 理由 (Rationale)

1. **长期收益 > 一次性成本**
   - 一次性成本: 4-6 小时 (实施命令和文档)
   - 年度节省: 12-24 小时 (不需要月度清理)
   - ROI: 200-400%

2. **与设计哲学一致** (Ultrathink)
   - **Think Different**: 不是"如何事后清理"，而是"如何源头防控"
   - **Simplify Ruthlessly**: 约束不是复杂的，而是简单清晰的决策树
   - **Craft, Don't Code**: 约束体现了对文档设计的深思熟虑

3. **可扩展性**
   - 当前文档量: 1,433 行，通常 3 个月增长 100%
   - 没有约束: 1 年后 3,000+ 行，不可管理
   - 有约束: 增长受限，始终 < 1,500 行（管理成本恒定）

4. **开发体验**
   - 清晰的文档决策树 (A/B/C/D/E 类型)
   - 自动的分层指导 ("这个文档应该放哪里？")
   - 早期反馈 (生成时就知道是否符合约束)

---

## 实施计划 (Implementation)

### Phase 1: 工作流集成 ✅ **已完成** (2025-11-18)

**目标**: 在关键工作流命令中植入约束逻辑

**实施内容**:

1. **`/wf_05_code` Step 8: 文档同步决策树** (+250 行)
   - Step 8.1: 文档变更范围确定 (5 项检查)
   - Step 8.2: 按层级路由文档 (A/B/C/D/E 自动分类)
   - Step 8.3: 自动更新索引
   - Step 8.4: 成本检查门控
   - Step 8.5: 决策记录
   - Step 8.6: 工作流连接

2. **`/wf_08_review` Dimension 6: 文档架构合规性** (+200 行)
   - 6 项检查清单 (分层、成本、Frontmatter、重复、指针、审查)
   - 5 级评分系统
   - 失败处理和修复指导

**状态**: ✅ 已完成，已提交 (commit 7de04aa)

### Phase 2: 文档生成优化 ⏳ **待执行**

**目标**: 在 `/wf_14_doc` 中实现完整的约束驱动生成

**计划内容**:
- 成本估计和分层建议 (自动)
- 成本门控检查 (自动)
- 交互式用户确认
- 生成 + 约束检查
- 最后确认和提示

**预计**: 3-4 小时实施

### Phase 3: 知识库规范化 ⏳ **待执行**

**目标**: 记录约束规范和最佳实践

**计划内容**:
- 更新 CLAUDE.md (文档生成约束规范部分)
- 更新 KNOWLEDGE.md (文档生成最佳实践)
- 创建使用指南和常见问题

**预计**: 2-3 小时实施

---

## 约束定义 (Constraints Definition)

### 大小约束 (Size Constraints)

| 文档类型 | 位置 | 限制 | 说明 |
|---------|------|------|------|
| 项目级架构更新 | PLANNING.md | < 50 行 | 仅"为什么"和"架构影响" |
| 设计决策 | docs/adr/ | < 200 行 | 遵循 ADR 模板 |
| API/功能文档 | docs/ | < 500 行/文件 | 复杂 API 分多文件 |
| 常见问题 | KNOWLEDGE.md FAQ | < 50 行/Q | 月末批量审查 |
| KNOWLEDGE.md 索引 | docs/ 根目录 | < 200 行 | 仅索引和摘要 |
| docs/ 增长 | 每个 commit | < 30% | 相对当前大小 |
| KNOWLEDGE.md 增长 | 每个 commit | < 20% | 相对当前大小 |

### 分层规则 (Layering Rules)

```
改动类型 → 对应层级 → 约束 → 更新索引
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
项目级架构   PLANNING.md   < 50行   更新目录
设计决策     docs/adr/     < 200行  更新 ADR 表
API/功能     docs/         < 500行  更新索引
常见问题     KNOWLEDGE.md  < 50行   月末合并
无需文档     -             -        -
```

### 质量约束 (Quality Constraints)

- ✅ 所有文档必须有 Frontmatter (7 个必需字段)
- ✅ 文档内容从代码提取 (不是编造)
- ✅ 无内容重复 (指针而非复制)
- ✅ 有代码示例 (如适用)
- ✅ 链接有效 (Frontmatter related_documents)

---

## 预期影响 (Expected Impact)

### 短期 (1-3 个月)

**定性**:
- 开发者对文档分层的理解更清晰
- 减少事后调整和返工
- 早期反馈，改进成本低

**定量**:
- 文档增长率: 从 100%/3月 → 20%/3月 (-80%)
- 清理时间: 从 1-2 小时/月 → 0
- commit 中的文档返工: 减少 70%

### 中期 (3-6 个月)

**定性**:
- 文档架构保持清晰和分层
- 按需加载机制更有效
- 新成员快速理解文档组织

**定量**:
- 管理层文档: 1,433 → ~1,600 行 (增长 +12%, 可控)
- /wf_03_prime 加载成本: 恒定 5,000-8,000 tokens
- 文档质量评分: 4.8/5 维持

### 长期 (6-12 个月)

**定性**:
- 文档系统成为项目成长的基础设施
- 无需定期的大规模清理
- 团队对文档的信任度提高

**定量**:
- 管理层文档: 保持 < 1,600 行 (增长被控制)
- docs/ 目录: 线性增长而非指数增长
- Token 成本稳定，不需要 `/clear` compact

---

## 权衡分析 (Trade-offs)

### 开发者学习成本 vs 长期收益

**学习成本**:
- 需要理解 5 个检查问题 (Q1-Q5)
- 需要理解 5 种文档类型 (A-B-C-D-E)
- 预计学习时间: 1-2 小时/人

**长期收益**:
- 减少月度清理: 1-2 小时/月
- 减少返工和调整: 30-50%
- 改进工作流连续性: 100%

**ROI**: 学习 1-2 小时，每月节省 1-2 小时，6 个月回本

### 严格约束 vs 开发灵活度

**约束的好处**:
- 防止文档膨胀
- 确保分层清晰
- 成本可控

**约束的风险**:
- 某些复杂功能可能需要 > 500 行文档
- 开发者可能感觉受限

**缓解方案**:
- 允许分多个 < 500 行的文件
- 允许在下个 commit 继续补充 (不是全部要在当前 commit 完成)
- 超限时提示修改方案，而非直接拒绝

---

## 关键决策点 (Key Decision Points)

### 1. 约束的严格度

**决策**: 分级约束
- 🔴 严格限制 (立即失败): KNOWLEDGE.md > 50% 增长, 无 Frontmatter
- 🟠 警告级 (要求改进): KNOWLEDGE.md > 20% 增长, 文档 > 500 行

**理由**: 平衡约束和灵活度

### 2. 何时检查约束

**决策**: 两个检查点
- Step 1: /wf_05_code Step 8 (生成时检查)
- Step 2: /wf_08_review Dimension 6 (审查时再检查)

**理由**: 冗余检查确保万无一失

### 3. 失败时的处理

**决策**: 提示修改方案，允许多种路径
- 修改文档范围 (减少内容)
- 拆分成多个文件
- 先清理旧文档，再添加新文档

**理由**: 给开发者选择权，而不是僵硬拒绝

---

## 相关决策 (Related Decisions)

- **ADR 2025-11-15**: CONTEXT.md 指针文档模式 (按需加载)
- **ADR 2025-11-13**: 优先开源方案 (技术选型规范)
- **ADR 2025-11-11**: 使用项目工具而非重新实现 (Token 效率)

---

## 后续行动 (Next Steps)

### 立即 (本周)
- ✅ Phase 1: 工作流集成 - 已完成
- ⏳ 提交本 ADR 并更新 KNOWLEDGE.md

### 短期 (1-2 周)
- ⏳ Phase 2: `/wf_14_doc` 优化
- ⏳ Phase 3: 规范化和文档

### 验证 (2-4 周)
- 使用约束系统开发 3-5 个特性
- 测量文档增长率和成本
- 根据实际情况调整约束参数

### 调整 (1 个月后)
- 根据实际使用情况微调约束值
- 收集开发者反馈
- 优化 UX (检查清单、错误提示等)

---

## 审查和批准 (Review & Approval)

**创建者**: Claude Code
**创建日期**: 2025-11-18
**状态**: Accepted ✅

**关键里程碑**:
- [x] Architecture pattern identified
- [x] Trade-offs analyzed
- [x] Phase 1 implemented
- [ ] Phase 2 in progress
- [ ] Phase 3 to begin
- [ ] Long-term validation

---

## 参考资料 (References)

- CLAUDE.md § 文档生成约束规范 (待创建)
- wf_05_code.md § Step 8: 文档同步决策树
- wf_08_review.md § Dimension 6: 文档架构合规性
- PHILOSOPHY.md § Ultrathink 设计原则
