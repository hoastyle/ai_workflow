# ADR-001: 智能文档生成系统设计

**日期**: 2025-11-07
**状态**: Accepted
**决策者**: AI + User
**相关命令**: `/wf_14_doc`

---

## 决策

采用"智能提取式文档生成"而非"通用模板批量生成"的方案。

---

## 背景

用户提供了 20 个文档生成 prompts，希望构建一个项目文档生成命令。面临的选择：
- **方案 A**: 直接集成这 20 个 prompts，批量生成文档
- **方案 B**: 设计智能文档助手，从代码库提取信息生成文档

---

## 问题分析

### 方案 A 的问题

**通用模板的局限性**:
- ❌ 缺乏项目特定性（生成的文档是"编造"的，不是真实的）
- ❌ 不支持增量更新（只能全量重新生成）
- ❌ 无法保证文档与代码同步（代码变了，文档不知道）
- ❌ 文档质量依赖人工填充（AI 只是提供框架）

**示例**:
```markdown
# 通用模板生成的文档
## API 端点
TODO: 列出所有 API 端点

## 环境变量
TODO: 添加环境变量说明
```

### 方案 B 的优势

**提取式文档的优势**:
- ✅ 从代码中提取真实信息（API 端点、环境变量、依赖等）
- ✅ 支持增量更新（只更新变化的部分）
- ✅ 自动检测文档缺口（对比代码 vs 现有文档）
- ✅ 项目特定（基于实际的技术栈和架构）

**示例**:
```markdown
# 从代码提取的文档
## API 端点

### POST /auth/refresh
刷新访问令牌

**请求体**:
```json
{
  "refresh_token": "string"
}
```

（从路由定义和类型注解自动提取）
```

---

## Ultrathink 分析

### 1. Think Different - 质疑假设

**假设**: "我们需要生成文档"

**质疑**: 真正的需求是什么？
- 不是"没有文档生成工具"
- 而是"文档与代码不同步"、"文档难以维护"

**重新定义**: 我们需要的是"文档智能助手"，不是"文档生成器"。

---

### 2. Obsess Over Details - 观察细节

**20 个 prompts 的本质**:

分析后发现可以归类为 5 个核心文档类型：
1. 📚 项目概览（README、架构、工作流）
2. 🔌 API 文档（端点、参数、响应）
3. ⚙️ 开发指南（环境、构建、测试）
4. 🚀 部署文档（配置、流程、监控）
5. 🏗️ 架构设计（系统设计、模式、ADR）

**关键洞察**: 这些文档的内容应该从代码中"提取"，而不是"编造"。

---

### 3. Plan Like Da Vinci - 精心规划

**设计分层**:

```
文档生命周期
│
├─ 分析层 (Analyzer)
│  ├─ 项目结构扫描
│  ├─ 技术栈识别
│  ├─ API 提取
│  └─ 配置解析
│
├─ 检测层 (Detector)
│  ├─ 文档缺口检测
│  ├─ 文档过时检测
│  └─ 变化识别
│
├─ 交互层 (Wizard)
│  ├─ 展示分析结果
│  ├─ 推荐生成计划
│  └─ 用户选择
│
├─ 提取层 (Extractor)
│  ├─ 从路由定义提取 API
│  ├─ 从配置文件提取环境变量
│  ├─ 从依赖文件提取技术栈
│  └─ 从测试代码提取使用示例
│
└─ 生成层 (Generator)
   ├─ 应用项目风格
   ├─ 生成文档
   ├─ 质量检查
   └─ 索引更新
```

---

### 4. Craft, Don't Code - 优雅实现

**命名**: `/wf_14_doc`
- 简洁而明确
- 不是 `codedoc` 或 `docgen`，就是 `doc`

**接口设计**:
```bash
/wf_14_doc              # 默认：交互式
/wf_14_doc --update api  # 增量更新
/wf_14_doc --check      # 只检查不生成
/wf_14_doc --auto       # 自动模式
```

**原则**:
- 自然而清晰
- 支持常见用例
- 不过度设计

---

### 5. Simplify Ruthlessly - 简化到本质

**20 个文档类型 → 5 个核心**:

不单独生成的文档（应融入现有文档）：
- 错误处理 → 代码注释 + PLANNING.md
- 性能优化 → KNOWLEDGE.md + docs/adr/
- 测试方法 → PLANNING.md "测试策略"
- 安全实践 → PLANNING.md "安全指南"
- 国际化 → PLANNING.md + API 文档
- 版本管理 → PLANNING.md "开发工作流"

**理由**: 减少文档碎片化，集中在核心文档。

---

### 6. Iterate Relentlessly - 支持迭代

**文档不是一次性的**:
- 支持增量更新 (`--update api`)
- 支持检查模式 (`--check`)
- 自动检测变化并提醒

---

## 决策

选择**方案 B: 智能提取式文档生成**

**核心命令**: `/wf_14_doc`

**核心能力**:
1. 🔍 代码库分析（技术栈、架构、API）
2. 🎯 缺口检测（对比现有文档 vs 代码实际）
3. 🤝 交互式生成（用户选择要生成的文档）
4. 📦 智能提取（从代码、配置、注释中提取信息）
5. 🔄 增量维护（支持更新现有文档）
6. 📚 索引管理（自动更新 KNOWLEDGE.md）

**支持的文档类型**（简化到 5 个核心）:
1. 📚 项目概览
2. 🔌 API 文档
3. ⚙️ 开发指南
4. 🚀 部署文档
5. 🏗️ 架构设计

---

## 权衡与成本

### 收益
- ✅ 文档质量高（真实信息，不是模板）
- ✅ 维护成本低（自动检测变化，增量更新）
- ✅ 开发体验好（交互式，不是批量）
- ✅ 项目特定（基于实际技术栈和架构）

### 成本
- ⚠️ 开发复杂度更高（需要实现代码分析器）
- ⚠️ 语言支持有限（需要逐步添加新语言支持）
- ⚠️ 依赖代码质量（注释、类型注解）

### 风险
- 🔴 代码分析可能不准确（动态生成的端点可能遗漏）
- 🟡 需要持续维护（新框架需要添加支持）

**评估**: 收益远大于成本，风险可控。

---

## 替代方案（已拒绝）

### 方案 A: 集成通用 prompts
- **优点**: 实现简单，快速上线
- **缺点**: 文档质量低，维护成本高，不支持增量更新
- **拒绝理由**: 不符合 Ultrathink "提取而非编造" 的理念

### 方案 C: 增强现有命令
- **优点**: 不增加新命令
- **缺点**: 职责混乱（`/wf_05_code` 是实现代码，不是生成文档）
- **拒绝理由**: 违反单一职责原则

---

## 后续计划

### 短期（v1.0）
- [x] 创建 `/wf_14_doc` 命令文件
- [x] 更新 KNOWLEDGE.md 和 CLAUDE.md
- [ ] 实现代码库分析器（Python, JavaScript）
- [ ] 实现 API 文档提取
- [ ] 实现环境变量提取

### 中期（v1.1）
- [ ] 支持更多语言（Rust, Go, Java）
- [ ] 支持更多框架（Django, Spring, Gin）
- [ ] 集成 OpenAPI/Swagger 自动同步
- [ ] 添加文档质量评分

### 长期（v2.0）
- [ ] 自动生成架构图（基于模块依赖）
- [ ] AI 驱动的文档审查
- [ ] 文档变更自动检测和提醒

---

## 相关资源

- 命令文件: [wf_14_doc.md](../../wf_14_doc.md)
- 设计哲学: [PHILOSOPHY.md](../../PHILOSOPHY.md)
- 知识库: [KNOWLEDGE.md](../../KNOWLEDGE.md)

---

**决策日期**: 2025-11-07
**下次审查**: 2026-02-07 (3个月后)
