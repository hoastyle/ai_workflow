# 架构决策记录 (Architecture Decision Records)

**版本**: v1.0
**创建日期**: 2025-11-06
**目的**: 记录项目中重要的技术和设计决策的背景、选择和权衡

---

## 简介

本目录存储所有重要的**架构决策记录 (ADR)**。每个 ADR 记录：
- **决策是什么** - 我们决定了什么
- **为什么要做这个决策** - 背景和驱动因素
- **考虑过哪些选项** - 为什么不选别的
- **权衡了什么** - 收益、成本、风险
- **何时重新评估** - 什么情况下这个决策需要改变

## 为什么要记录 ADR？

### 对项目的价值
- 📖 **新成员的学习资料** - 快速理解项目的架构思路
- 🔮 **决策可追溯** - 知道为什么这样，而不仅仅是"这样工作"
- ⏳ **长期参考** - 后期重构或优化时，知道之前的权衡是什么
- 📚 **积累知识** - 形成项目的架构资产

### 对决策过程的价值
- 💡 **迫使深思** - 要写 ADR，就要想清楚理由
- ⚖️ **明确权衡** - 强制列出成本和收益
- 🎯 **清晰目标** - 记录决策时的目标和约束
- 🔄 **便于复审** - 下一次类似决策时，有参考

---

## 文件命名规范

```
YYYY-MM-DD-decision-name.md
```

**例子**:
- `2025-11-06-use-sqlite-instead-of-postgres.md`
- `2025-11-06-monolithic-api-design-for-initial-phase.md`
- `2025-11-06-adopt-ultrathink-design-philosophy.md`

**规则**:
- 使用 ISO 日期格式 (YYYY-MM-DD)
- 用短横线分隔单词 (kebab-case)
- 文件名要能自我说明

---

## ADR 模板

创建新的 ADR 时，使用以下模板：

```yaml
---
title: "简洁的决策标题"
date: 2025-11-06
status: "Proposed | Accepted | Superseded | Deprecated"
philosophy: ["Think Different", "Simplify Ruthlessly"]  # 相关的 ultrathink 原则 (可选)
impact: "high | medium | low"  # 对架构的影响程度
---

## 背景

为什么需要这个决策？

描述：
- 问题是什么？
- 当前的情况如何？
- 为什么现状无法接受？
- 约束条件有哪些？

## 选项分析

列举考虑过的选项，逐个分析。

### 选项 A: [名称]

**描述**: [详细说明]

**优势**:
- 优点 1
- 优点 2

**劣势**:
- 缺点 1
- 缺点 2

**成本估计**: [时间、资源]

### 选项 B: [名称]

[同上结构]

### 选项 C: [名称]

[同上结构]

## 决策

**我们选择了: [选项 X]**

**理由**:
1. 理由 1
2. 理由 2
3. 理由 3

**关键考量**:
- 考量 1
- 考量 2

## 权衡 (Tradeoffs)

### 收益
- 我们获得了什么？
- 优雅度提升了吗？
- 性能/可维护性/可扩展性怎样？

### 成本
- 开发工作量多少？
- 维护负担如何？
- 学习曲线如何？

### 风险
- 什么情况下这个决策会失效？
- 如何缓解风险？
- 监控指标是什么？

## 后续行动

- [ ] 实现
- [ ] 测试
- [ ] 文档更新
- [ ] 团队培训
- [ ] 监控部署

## 重新评估条件

什么情况下应该重新考虑这个决策？

**触发条件**:
- 条件 1 (例: 并发数 > 100)
- 条件 2 (例: 查询延迟 > 200ms)
- 条件 3 (例: 新增需求改变了约束)

**评估时间**: [例如 3 个月后、下一个季度]

## 参考资源

- [链接到相关文档]
- [链接到实现 PR]
- [链接到讨论或会议记录]

## 历史

| 日期 | 事件 |
|------|------|
| 2025-11-06 | 提议 |
| 2025-11-07 | 团队讨论 |
| 2025-11-10 | 已接受 |
```

---

## 如何使用 ADR

### 创建新的 ADR

1. **何时创建**:
   - 做重要的架构决策时 (不是所有决策都需要 ADR)
   - 需要团队讨论并达成共识的决策
   - 有多个选项，需要权衡的情况

2. **何时不需要**:
   - 日常的小改动 (bug 修复、小功能添加)
   - 按既有规范的实现 (只需跟随模式)
   - 明显的决策 (没有其他选择)

3. **创建步骤**:
   ```bash
   # 1. 复制模板
   cp docs/adr/TEMPLATE.md docs/adr/2025-11-06-your-decision.md

   # 2. 编辑文件，填入内容
   # 3. 提交到 git
   git add docs/adr/2025-11-06-your-decision.md
   git commit -m "[docs] Add ADR: your decision"
   ```

### 在工作中引用 ADR

当做相关决策时，查阅 ADR：

```bash
# 查看所有决策
ls -la docs/adr/

# 查看特定决策
cat docs/adr/2025-11-06-use-sqlite-instead-of-postgres.md

# 搜索相关决策
grep -r "performance" docs/adr/
grep -r "API design" docs/adr/
```

### 更新 ADR 的状态

决策的生命周期：

| 状态 | 说明 | 何时使用 |
|------|------|---------|
| **Proposed** | 已提议，待讨论 | 初稿完成，等待评审 |
| **Accepted** | 已接受，开始实施 | 团队同意，开始执行 |
| **Superseded** | 已被新决策取代 | 后来做了更好的决策，旧的无效 |
| **Deprecated** | 已废弃 | 实践证明不可行或不再适用 |

更新 ADR 的状态：

```yaml
---
status: "Accepted"  # 改为新状态
---
```

### 与工作流的整合

**在 /wf_04_ask (架构咨询) 中**:
- 做重要决策时，AI 会建议创建 ADR
- 格式: "要不要把这个决策记录到 docs/adr/？"

**在 /wf_09_refactor (代码重构) 中**:
- 重构涉及权衡时，建议记录 ADR
- 格式: "这个权衡清晰吗？建议记录到 ADR"

**在 /wf_10_optimize (性能优化) 中**:
- 优化涉及权衡时，记录 ADR
- 格式: "优化与可读性的权衡，值得记录"

---

## ADR 示例

### 例子 1: 数据库选择

**文件**: `2025-11-06-use-sqlite-for-initial-phase.md`

```markdown
---
title: "初期使用 SQLite 作为数据库"
date: 2025-11-06
status: "Accepted"
philosophy: ["Think Different", "Simplify Ruthlessly"]
impact: "high"
---

## 背景

新项目需要选择数据库方案。初期的数据结构和并发需求尚不确定。

## 选项分析

### 选项 A: SQLite
- 优: 简单、快速开发、零运维
- 缺: 无水平扩展能力

### 选项 B: PostgreSQL
- 优: 功能完全、生产级别
- 缺: 复杂度高、运维负担

### 选项 C: MongoDB
- 优: 灵活、易扩展
- 缺: 事务支持差、概念多

## 决策

选择 SQLite。理由：
1. 初期数据结构简单，关系数据库足矣
2. 快速迭代优于前期完美
3. 可快速开发 MVP

## 权衡

**收益**: 快速开发、低运维
**成本**: 后期可能需要迁移到 PostgreSQL
**风险**: 并发陡增时需要紧急迁移

## 重新评估条件

- 并发用户 > 50
- 单条查询 > 100ms
- 存储数据 > 1GB
```

### 例子 2: API 设计

**文件**: `2025-11-06-rest-api-v1-design.md`

```markdown
---
title: "REST API v1 设计原则"
date: 2025-11-06
status: "Accepted"
philosophy: ["Obsess Over Details", "Simplify Ruthlessly"]
impact: "high"
---

## 背景

需要设计 REST API，指导初期的所有端点实现。

## 设计原则

1. **资源优先** - 围绕业务资源设计端点
2. **最小参数** - 减少必需参数，复杂场景用查询字符串
3. **明确错误** - 错误码和信息要清晰有用
4. **版本管理** - 通过路径版本化 (v1, v2)

## 权衡

**简洁性** 胜于 **功能完整性**

- 减少灵活性，换取清晰性
- 初期 API 简单，后期易于扩展
```

---

## 统计和维护

### 查看所有 ADR

```bash
# 按状态分类
grep "status:" docs/adr/*.md

# 按日期排序
ls -lt docs/adr/*.md

# 按影响程度
grep "impact:" docs/adr/*.md
```

### 定期审查

建议每个季度末：
1. 检查是否有 ADR 需要状态更新
2. 是否有新的决策需要记录
3. 是否有需要 Superseded 的旧决策

---

## 与 PHILOSOPHY.md 的关系

PHILOSOPHY.md 定义了**设计思维方式**（6 个原则）。
docs/adr/ 是这些原则的**具体实践记录**。

**流程**:
1. 遇到架构决策 (通常在 /wf_04_ask)
2. 应用 PHILOSOPHY.md 的 6 个原则深思
3. 写清楚权衡和理由
4. 记录为 ADR 文件
5. 后续参考时，既能看到"决策是什么"，也能看到"为什么这样"

---

## 最佳实践

### 什么是好的 ADR？

✅ **好的特征**:
- 清晰的决策陈述 (一句话就能说清楚)
- 选项分析充分 (至少 2-3 个选项)
- 权衡明确 (知道得失)
- 重新评估条件清晰 (什么时候改变主意)

❌ **坏的特征**:
- "我们选了这个因为它很好"（没有具体理由）
- 只列选项，不分析权衡
- 太冗长，没有重点
- "这是最终决定，永远不会改变"（太绝对）

### 写 ADR 的技巧

1. **短小精悍** - 核心信息 ≤ 2 页
2. **具体数据** - "性能提升 30%" 胜于 "性能更好"
3. **明确权衡** - 没有完美方案，只有最好的平衡
4. **未来导向** - 考虑半年后会如何评价这个决策

---

## 模板文件

如果需要更快地创建 ADR，可以使用[这个模板](./TEMPLATE.md)。

```bash
cp docs/adr/TEMPLATE.md docs/adr/YYYY-MM-DD-your-decision.md
```

---

**最后更新**: 2025-11-06
**维护**: Architecture Decision Records System
**相关**: [PHILOSOPHY.md](../PHILOSOPHY.md), [CLAUDE.md](../../CLAUDE.md)
