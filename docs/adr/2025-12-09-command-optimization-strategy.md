# ADR 2025-12-09: 命令优化和上下文保护策略

**状态**: 提议中
**决策日期**: 2025-12-09
**决策者**: AI Workflow 开发团队
**影响范围**: 所有 wf_ 命令、文档架构、上下文管理

---

## 📋 背景 (Context)

经过 Phase 1-5 的优化，AI Workflow 系统在 token 效率上取得了显著进展（节省 79%）。然而，深度分析发现两个严重问题：

### 问题1: 命令文件膨胀
- **现状**: 平均 642 行/命令（最大 1905 行）
- **对比**: SuperClaude 平均 193 行/命令
- **差距**: **3.3 倍**
- **影响**: 每次命令执行消耗 450-1400 tokens（仅加载命令定义）

### 问题2: 大文档随机读取导致上下文爆炸
- **现状**: 17 个文档超过 500 行，最大 1147 行
- **风险**: 单次读取可消耗 3000-6000 tokens
- **影响**: 可能触发 context 爆炸（94% 使用率）

### 触发因素
用户提问："经过了上述一系列的优化来提升workflow的性能，降低token消耗。但是wf_系列命令的自身长度却越来越长。这种情况合理吗？"

### SuperClaude 参考分析
- **命令简洁性**: 大部分命令 80-100 行，核心定义清晰
- **配置分离**: 使用 JSON 配置而非全部内联
- **程序化描述**: 伪代码而非冗长自然语言
- **分层设计**: 元命令协调子命令

---

## 🎯 决策 (Decision)

采用**三阶段渐进式优化策略**，结合 SuperClaude 最佳实践：

### 阶段1: 立即防护（本周完成）- 最高优先级

#### 1.1 强制文档读取保护规则
在 CLAUDE.md 添加强制执行规则：
```markdown
### 📏 文档读取保护规则 (MANDATORY)

Step 1: 读取前强制检查
```bash
lines=$(wc -l < "$file_path")
```

Step 2: 大小分级处理
- 🟢 <200行: 直接读取
- 🟡 200-500行: 询问或读取前100行
- 🔴 >500行: 禁止直接读取，使用摘要/分段/搜索

Step 3: Token 监控
if tokens_used > 15000: 启用严格模式
```

**投入**: 2小时
**ROI**: 10x+（立即防止 3000-6000 tokens 爆炸）

#### 1.2 KNOWLEDGE.md 索引增强
添加大小、tokens、读取策略标注：
```markdown
| 主题 | 文档 | 大小 | Tokens | 读取策略 |
|------|------|------|--------|---------|
| MCP集成 | MCP_INTEGRATION_STRATEGY.md | 🔴 638行 | ~2,790 | 摘要优先 |
| 任务追踪 | TASK.md | 🔴 1,147行 | ~5,000 | **仅读活跃** |
```

**投入**: 1小时
**ROI**: 5x（提供可见性，避免误读）

### 阶段2: 结构优化（1-2周完成）

#### 2.1 管理文档拆分
```
TASK.md (1147行) → TASK_ACTIVE.md (150行) + 5个Phase历史文件
PLANNING.md (869行) → PLANNING_CORE.md (250行) + 详细模块文件
```

**投入**: 4小时
**ROI**: 6x（/wf_03_prime 节省 3000-4000 tokens）

#### 2.2 前3个命令瘦身（参考 SuperClaude）
- wf_08_review.md: 1905 → 300 行
- wf_03_prime.md: 1198 → 250 行
- wf_05_code.md: 1158 → 250 行

**策略**:
1. Frontmatter 简化（20+ → 8-10 字段）
2. 正文结构化（SuperClaude 6-section 模式）
3. 详细内容外置到 docs/guides/
4. 程序化描述（YAML 而非冗长自然语言）

**投入**: 1周（40小时）
**ROI**: 8x（每次会话节省 3300 tokens）

### 阶段3: 智能增强（2-4周完成）

#### 3.1 智能摘要系统
为所有 >500 行文档创建 50-100 行摘要：
```
docs/integration/MCP_INTEGRATION_STRATEGY.md (638行)
docs/integration/.summaries/MCP_INTEGRATION_STRATEGY.summary.md (80行)
```

摘要包含：核心观点、章节索引、关键决策、快速参考

**投入**: 1周（17个文档 × 30分钟 + 自动化脚本）
**ROI**: 4x（每次避免大文档读取节省 2000-5000 tokens）

#### 3.2 其余命令瘦身
- wf_14_doc, wf_11_commit, wf_04_ask, wf_06_debug
- 所有命令标准化为 SuperClaude 结构
- 目标：所有命令 <350 行，平均 <250 行

**投入**: 1周
**ROI**: 3x（每次会话节省 1800 tokens）

---

## 🔬 备选方案 (Alternatives Considered)

### 方案A: 维持现状（❌ 拒绝）
**优点**: 无需投入
**缺点**:
- 命令持续膨胀
- 上下文爆炸风险持续存在
- 维护成本持续上升
- 与 SuperClaude 最佳实践差距扩大

**决策**: 拒绝。问题会越来越严重。

### 方案B: 完全重构（JSON配置系统）（⏸️ 延后）
**优点**:
- 架构最清晰
- 完全符合 SuperClaude 模式
- 长期维护性最佳

**缺点**:
- 投入巨大（2-3周）
- ROI 相对较低（2x）
- 可能引入新bug

**决策**: 延后到阶段3之后，作为长期优化选项。

### 方案C: 仅实施文档保护（⚠️ 不足）
**优点**: 投入最小（3小时）
**缺点**:
- 不解决命令膨胀问题
- 只是被动防御

**决策**: 作为阶段1的一部分，但不够。需要结合命令瘦身。

---

## ✅ 决策理由 (Rationale)

### 为什么采用三阶段策略？

1. **风险管理**: 渐进式实施，每阶段可验证效果
2. **ROI 优先**: 先做高ROI低成本的立即措施
3. **灵活性**: 可根据阶段1-2效果决定是否继续阶段3
4. **学习借鉴**: 有时间深入研究 SuperClaude 实践

### 为什么不立即完全重构？

1. **当前系统可用**: Phase 1-5 已节省 79% tokens
2. **投入产出**: 完全重构需要 2-3周，ROI 仅 2x
3. **风险控制**: 渐进式改进风险更低
4. **验证优先**: 先验证简化策略是否足够

### SuperClaude 借鉴的核心价值

1. **命令简洁性**: 证明 200 行以内可以实现完整功能
2. **配置分离**: JSON 配置是长期方向，但非紧急
3. **程序化描述**: 立即可用，大幅减少冗长自然语言
4. **分层设计**: 元命令系统可选，但非必需

---

## 📊 预期影响 (Consequences)

### 正面影响 ✅

#### 立即效果（阶段1，1-2天）
- ✅ 防止上下文爆炸（每次可能节省 3000-6000 tokens）
- ✅ 文档大小可见性（避免误读）
- ✅ 强制保护机制（零成本防护）

#### 短期效果（阶段2，1-2周）
- ✅ 命令加载减少 50-70%（3300 tokens/会话）
- ✅ /wf_03_prime 加速（节省 3000-4000 tokens）
- ✅ 代码可维护性提升
- ✅ 用户学习曲线降低

#### 中期效果（阶段3，2-4周）
- ✅ 大文档智能读取（节省 2000-5000 tokens/次）
- ✅ 所有命令标准化（平均 <250 行）
- ✅ 架构健康度显著提升
- ✅ 总token节省 40-60%（每次会话）

### 负面影响 ⚠️

#### 实施成本
- ⚠️ 需要 1-4周持续投入
- ⚠️ 短期内可能引入bug（需充分测试）
- ⚠️ 需要更新所有引用和链接
- ⚠️ 用户需要适应新的文档结构

#### 迁移风险
- ⚠️ 旧版本命令可能不兼容（需保留备份）
- ⚠️ 外部引用可能失效（需检查）
- ⚠️ 测试覆盖需要更新

### 缓解措施

1. **渐进式迁移**: 每次只改一个命令，充分测试后再继续
2. **版本控制**: 每阶段完成后打tag，出问题可回滚
3. **文档更新**: 及时更新 README 和 KNOWLEDGE.md
4. **兼容性保留**: 保留旧结构的别名或重定向
5. **用户通知**: 在 CHANGELOG.md 明确说明变更

---

## 🚀 实施计划 (Implementation Plan)

### Week 1: 阶段1（立即防护）

**Day 1** (2小时):
- [ ] 更新 CLAUDE.md（添加文档读取保护规则）
- [ ] 创建 scripts/check_doc_size.sh
- [ ] 测试保护机制（尝试读取 TASK.md, PLANNING.md）

**Day 2** (1小时):
- [ ] 扫描所有文档大小
- [ ] 更新 KNOWLEDGE.md 索引（添加大小、tokens、策略列）
- [ ] 创建 scripts/update_knowledge_index.py 自动化脚本

**验收**:
- [ ] AI 读取任何 >500 行文档时触发保护
- [ ] KNOWLEDGE.md 所有文档有大小标注
- [ ] 通过测试：尝试读取 10 个不同大小的文档

### Week 1-2: 阶段2.1（管理文档拆分）

**Day 3-4** (4小时):
- [ ] TASK.md 拆分
  - [ ] 创建 docs/management/tasks/TASK_ACTIVE.md
  - [ ] 迁移 Phase 1-5 到独立文件
  - [ ] 更新主 TASK.md（仅概览+活跃任务）
- [ ] PLANNING.md 拆分
  - [ ] 创建 PLANNING_CORE.md
  - [ ] 外置详细模块到 planning/

**Day 5** (2小时):
- [ ] 更新所有引用链接（使用 grep 查找）
- [ ] 测试 /wf_03_prime（确保正常工作）
- [ ] 验证 CONTEXT.md 指针仍然有效

**验收**:
- [ ] TASK.md 主文件 <200 行
- [ ] PLANNING.md 主文件 <250 行
- [ ] /wf_03_prime 节省 3000+ tokens

### Week 2: 阶段2.2（前3命令瘦身）

**Day 6-7**: wf_08_review.md (1905 → 300 行)
- [ ] 分析当前内容（识别核心 vs 详细）
- [ ] 简化 Frontmatter（20+ → 10 字段）
- [ ] 重写正文（SuperClaude 6-section 结构）
- [ ] 外置详细内容到 docs/guides/wf_08_review_guide.md
- [ ] 测试功能完整性

**Day 8-9**: wf_03_prime.md (1198 → 250 行)
- [ ] 简化加载逻辑描述（程序化 YAML）
- [ ] 外置详细工作流导航到 guides/
- [ ] 外置使用示例到 examples/
- [ ] 测试 Quick Start, Task Focused, Full Context 模式

**Day 10-11**: wf_05_code.md (1158 → 250 行)
- [ ] 简化 MCP 说明（仅核心，详情外置）
- [ ] 程序化描述行为流程
- [ ] 外置 Explore-First, Parallel 模式详情
- [ ] 测试 Serena, Magic MCP 集成

**Day 12-14**: 测试和优化
- [ ] 运行所有 wf_ 命令测试套件
- [ ] 修复发现的bug
- [ ] 更新 docs_index.json
- [ ] 更新 CHANGELOG.md

**验收**:
- [ ] 3个命令都 <350 行
- [ ] 功能完全保留
- [ ] 每次会话节省 3000+ tokens

### Week 3-4: 阶段3（智能增强）- 可选

**Week 3**: 智能摘要系统
- [ ] 创建摘要模板
- [ ] 为17个超大文档生成摘要（每个30分钟）
- [ ] 实现自动生成脚本
- [ ] 更新 AI 读取逻辑（优先摘要）

**Week 4**: 其余命令瘦身
- [ ] wf_14_doc, wf_11_commit, wf_04_ask, wf_06_debug
- [ ] 标准化所有命令（SuperClaude 模式）
- [ ] 完整测试和文档更新

**验收**:
- [ ] 所有文档有摘要
- [ ] 所有命令 <350 行
- [ ] 总token节省 40-60%

---

## 📈 成功指标 (Success Metrics)

### 量化指标

| 指标 | 当前 | 阶段1 | 阶段2 | 阶段3 | 目标 |
|------|------|-------|-------|-------|------|
| 命令平均大小 | 642行 | 642行 | 350行 | 250行 | <250行 |
| 最大命令大小 | 1905行 | 1905行 | 800行 | 350行 | <350行 |
| 超大文档数 | 17个 | 17个 | 15个 | 0个 | 0个 |
| 文档读取保护 | 无 | 强制 | 强制 | 强制+摘要 | 强制+摘要 |
| Token/会话 | 基准 | -10% | -35% | -50% | -40~60% |
| 上下文爆炸风险 | 高 | 低 | 低 | 极低 | 极低 |

### 质量指标

- [ ] 所有命令通过功能测试
- [ ] 用户反馈：命令更易理解
- [ ] 维护时间减少 30%+
- [ ] 新手学习曲线降低
- [ ] 架构健康度评分 >90%

---

## 🔄 回顾与调整 (Review)

### 阶段1完成后（1-2天后）
- 评估文档保护效果（是否真的防止了爆炸？）
- 调查是否有误报（过度保护导致不便）
- 决定是否继续阶段2

### 阶段2完成后（2周后）
- 测量实际token节省（是否达到 35%？）
- 用户满意度调查
- 决定是否继续阶段3或直接进入长期优化

### 阶段3完成后（4周后）
- 完整效果评估
- 决定是否进入 JSON 配置重构
- 更新 PLANNING.md 和 KNOWLEDGE.md

---

## 📚 相关资源 (References)

### 内部文档
- [命令膨胀分析报告](docs/analysis/2025-12-09-command-bloat-analysis.md)
- [SuperClaude 对比分析](docs/adr/2025-12-03-superclaude-optimization-learnings.md)
- [KNOWLEDGE.md](KNOWLEDGE.md)
- [TASK.md](docs/management/TASK.md)

### 外部参考
- SuperClaude Framework: `/home/hao/Workspace/MM/utility/Reference/SuperClaude_Framework`
- SuperClaude 命令示例: `src/superclaude/commands/implement.md`, `pm.md`

### 工具脚本
- `scripts/check_doc_size.sh` (待创建)
- `scripts/update_knowledge_index.py` (待创建)
- `scripts/generate_summaries.py` (待创建)

---

**ADR 创建**: 2025-12-09
**下次审查**: 阶段1完成后（预计 2025-12-10）
**负责人**: AI Workflow 开发团队
