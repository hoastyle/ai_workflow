---
title: "文档生成决策树详解"
description: "代码改动后如何判断是否需要文档以及选择文档类型的详细指南"
type: "教程"
status: "完成"
priority: "高"
created_date: "2025-11-24"
last_updated: "2025-11-24"
related_documents:
  - "docs/examples/doc_generation_quick_guide.md"
  - "KNOWLEDGE.md"
related_code:
  - "wf_05_code.md"
tags: ["文档生成", "决策", "最佳实践"]
---

# 文档生成决策树详解

## 决策树概述

```
代码改动类型判断:

Q1: 改动了公开 API/函数/类？
├─ YES → Type C（API文档）或 Type B（如有架构决策）
│       例: 新增REST端点、公开方法、导出的类
└─ NO → Q2

Q2: 改变了现有功能的行为？
├─ YES → Type A（PLANNING.md）或 Type D（FAQ）
│       例: 修改错误处理、改变响应格式
└─ NO → Q3

Q3: 使用了新的库/框架/技术？
├─ YES → Type B（ADR）
│       例: 引入新数据库、认证库、Web框架
└─ NO → Q4

Q4: 改变了系统架构或设计？
├─ YES → Type A（PLANNING.md）
│       例: 重构模块结构、改变分层设计
└─ NO → Q5

Q5: 引入了新的配置或部署流程？
├─ YES → Type C（docs/deployment/）
│       例: 新环境变量、Docker配置变化
└─ NO → Type E（无需文档）
       例: 代码优化、变量改名
```

## 文档类型详解

### Type A：架构/规划更新（PLANNING.md）

**何时使用**:
- 系统整体架构有改变
- 分层设计或模块结构调整
- 引入新的设计模式
- 技术栈有重大升级

**更新方式**:
```yaml
# PLANNING.md 中新增或更新一个章节

## 2025-11-24 架构更新：模块重构

### 改动内容
- 原来: 单体架构，所有功能在一个 app/
- 现在: 微服务架构，按功能分为 services/auth/, services/user/

### 影响范围
- 影响所有新功能的集成方式
- 现有功能无需改动（向后兼容）

### 决策原因
- 当前单体已无法满足扩展需求
- 按功能分离提高并行开发效率
```

**约束**: < 50 行（只记录"为什么"和"影响"，不重复代码细节）

### Type B：架构决策记录（docs/adr/）

**何时使用**:
- 多个技术选项间的权衡
- 重大的技术选型决策
- 长期影响整个系统的选择
- 与公司标准有偏差需要记录原因

**文件示例**: `docs/adr/2025-11-24-xxx-decision.md`

**内容结构**:
```markdown
# 决策：选择 Redis 而非 Memcached

**日期**: 2025-11-24
**状态**: Accepted

## 背景
需要选择缓存解决方案...

## 考虑的选项
- 选项 A: Memcached
  优势: 简单轻量
  劣势: 无持久化，功能有限

- 选项 B: Redis ← 选择
  优势: 功能丰富，支持多种数据结构
  劣势: 相对复杂

## 决策
选择 Redis 因为...

## 影响
- 需要部署 Redis 服务
- 改变了缓存键设计
```

**约束**: < 200 行（控制篇幅，避免冗长）

### Type C：功能/API 文档（docs/）

**何时使用**:
- 新增或改动 API 端点
- 新的配置选项
- 部署流程变化
- 新的工具或脚本

**文件示例**:
- `docs/api/endpoints.md`
- `docs/deployment/configuration.md`
- `docs/tools/cli-reference.md`

**约束**: < 500 行（超过则拆分为多文件）

**拆分例子**：单个 API 文档 600 行
```
原文件: docs/api/users.md (600行)

改为:
  ├─ docs/api/users_overview.md (200行) - 概览和认证
  ├─ docs/api/users_endpoints.md (250行) - 所有端点
  └─ docs/api/users_errors.md (150行) - 错误码和处理
```

### Type D：FAQ/知识库（KNOWLEDGE.md）

**何时使用**:
- 常见问题和解决方案
- 陷阱和最佳实践
- 已知的局限和绕过方法

**添加方式**:
```markdown
## 文档生成常见问题

### Q: 如何判断是否需要文档？
**A**: 使用决策树...
```

**约束**: < 50 行/条目（简洁明了）

### Type E：无需文档

**场景**:
- 代码优化（性能改进）
- 内部重构（模块结构调整，功能不变）
- 变量改名（遵循现有规范）
- 代码风格改进
- 依赖版本更新（不影响 API）

**判断标准**: 用户是否需要了解这个改动？
- NO → Type E
- YES → 某种文档

## 决策树应用示例

### 示例 1：新增 REST API 端点

```
改动: 添加 POST /users/bulk-import

Q1: 改动了公开 API？
    答: YES（新的 REST 端点）
    → Type C（API 文档）

Q2-Q5: 跳过（已确定）

决定:
  文档类型: Type C
  位置: docs/api/endpoints.md
  约束: < 500行
  内容: 新端点说明、参数、示例、错误码
```

### 示例 2：从 MySQL 迁移到 PostgreSQL

```
改动: 完整的数据库迁移

Q1: 改动了公开 API？
    答: NO（数据库是内部实现细节）
    → Q2

Q2: 改变了现有功能行为？
    答: NO（向用户来说行为相同）
    → Q3

Q3: 使用了新的库/技术？
    答: YES（PostgreSQL 驱动）
    → Type B（ADR）

Q4: 改变了系统架构？
    答: YES（大量迁移脚本、新的连接配置）
    → Type A（PLANNING.md）

决定:
  主文档: Type B（ADR: 为什么选择 PostgreSQL）
  辅助: Type C（迁移指南、配置说明）
  另外: 更新 PLANNING.md 的"技术栈"章节
```

### 示例 3：优化数据库查询性能

```
改动: 添加索引、改进 SQL 查询

Q1: 改动了公开 API？
    答: NO（用户看不出区别）
    → Q2

Q2: 改变了现有功能行为？
    答: NO（只是性能改进）
    → Q3

Q3-Q5: 都 NO

决定:
  文档类型: Type E（无需文档）
  原因: 这是内部优化，用户无需了解

  但: 可在 KNOWLEDGE.md 记录性能改进的笔记
       (如果性能指标有明显变化，需要通知用户)
```

## 优先级判定

对于确定需要文档的改动，进一步判定优先级：

### 🔴 高优先级（立即生成）
- 改动了多人依赖的公开 API
- 改变了系统核心行为
- 新增了关键功能
- 用户需要立即了解的改动

**生成时机**: 代码完成后立即生成

### 🟠 中优先级（建议生成）
- 改动了内部组件
- 添加了新配置选项
- 改进了性能/安全性
- 影响小部分用户

**生成时机**: 本次 commit 或下次 commit

### 🟡 低优先级（可选生成）
- 边界功能的改动
- 代码重构（功能不变）
- 内部优化

**生成时机**: 有时间时，或月末集中补充

## 常见误区

### 误区 1：过度文档化
```
❌ 错误: 每个函数改动都要文档
  后果: 文档爆炸，维护困难

✅ 正确: 只文档化用户可见的改动
  原则: 下一个维护者需要知道"为什么"和"如何用"吗？
```

### 误区 2：重复文档
```
❌ 错误: 在 PLANNING、KNOWLEDGE、API 文档中都记录同一信息
  后果: 更新时不一致

✅ 正确: 只在一个地方记录，其他地方通过 Frontmatter 关联
  使用 related_documents 指向主文档
```

### 误区 3：遗漏文档
```
❌ 错误: 改动了 API 但没有更新文档
  后果: 用户困惑，维护者混乱

✅ 正确: 使用决策树检查每个改动
  工具: 决策树提示 + 约束检查
```

## 快速参考表

| 改动类型 | 例子 | 文档类型 | 位置 | 约束 |
|---------|------|---------|------|------|
| 新 API | REST 端点 | C | docs/api/ | <500行 |
| API 改变 | 返回格式变化 | A/D | PLANNING/FAQ | <50行 |
| 新库/框架 | 引入 Redis | B | docs/adr/ | <200行 |
| 架构改变 | 模块重构 | A | PLANNING | <50行 |
| 新配置 | 环境变量 | C | docs/deploy/ | <500行 |
| 性能优化 | 查询优化 | E | - | - |
| 代码优化 | 变量改名 | E | - | - |

---

## 实施建议

1. **定期检查**: 每个 commit 前问自己"需要文档吗？"
2. **及早生成**: 代码完成立即生成，避免遗漏
3. **遵守约束**: 宁可拆分也不要超限
4. **团队统一**: 整个团队使用同样的决策树

---

**版本**: v1.0 | **更新**: 2025-11-24
