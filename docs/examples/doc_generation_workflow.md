# 约束驱动的文档生成工作流

**核心理念**: 在生成文档时就内置成本检查和约束验证，而非事后清理

## 整体流程

```
代码实现（已完成）
    ↓
[Phase 1 from /wf_05_code Step 8]
文档同步决策树（确定需要生成哪些文档）
    ↓
[Phase 2 from /wf_14_doc 开始]
→ 成本估计和分层建议（自动）
→ 交互式用户确认（用户选择）
→ 生成 + 约束检查（自动）
→ 最后验证和提示（确认）
    ↓
[Phase 3 from /wf_08_review Dimension 6]
文档架构合规性检查（审查时再次验证）
    ↓
提交和保存（/wf_11_commit）
```

## 详细步骤

### 步骤 1: 代码库分析和成本估计（约束驱动）

本步骤在生成前估计文档成本，确保符合约束条件。

```
1.1 扫描项目结构
    - 识别目录组织
    - 统计文件类型和规模

1.2 识别技术栈
    - 解析依赖文件 (package.json, pyproject.toml, etc.)
    - 检测框架和库

1.3 分析架构
    - 构建模块依赖图
    - 识别分层结构

1.4 提取 API 和配置
    - 扫描路由定义
    - 提取端点、参数、返回类型
    - 解析环境变量
    - 提取部署配置

1.5 估计文档成本（强制执行）
    - 分析当前 KNOWLEDGE.md 大小 (行数)
    - 分析当前 docs/ 目小 (总行数)
    - 预估每个可能文档的大小
      * Type A (PLANNING.md): ~20-50 行
      * Type B (ADR): ~100-200 行
      * Type C (docs/ 文档): ~150-500 行
      * Type D (FAQ): ~20-50 行
    - 计算生成后的预期大小
    - 计算百分比增长（KNOWLEDGE.md + docs/）
    - 判断是否会超过约束阈值（见下表）

约束检查表:
┌─────────────────────────────────────────────────┐
│ 约束项 | 现有值 | 预估增加 | 生成后 | 限制 | 通过 │
├─────────────────────────────────────────────────┤
│ KNOWLEDGE.md 行数 | ? | ? | ? | <200 | ✅/❌ │
│ docs/ 总行数 | ? | ? | ? | N/A | ✅ │
│ docs/ 增长率 | ? | ? | ?% | <30% | ✅/❌ │
│ KNOWLEDGE.md 增长率 | ? | ? | ?% | <20% | ✅/❌ │
│ 新文档单个大小 | N/A | ? | ? | <500 | ✅/❌ │
└─────────────────────────────────────────────────┘

🔴 若超限: 返回错误，提示用户修改范围或分多个 commit
✅ 若符合: 继续进行步骤 2
```

### 步骤 2: 文档缺口检测和分层建议（约束驱动）

```
2.1 读取现有文档
    - README.md (如果存在)
    - docs/ 目录下的所有文档
    - KNOWLEDGE.md 已有索引

2.2 对比分析
    - API 文档 vs 实际端点
    - README 技术栈 vs 实际依赖
    - 环境变量文档 vs 实际配置
    - 开发指南 vs 当前工具链

2.3 自动分层建议（使用 Step 8.2 的决策树）
    对于每个检测到的缺口，自动确定：
    ├─ Type A: 项目级架构改动 → PLANNING.md (< 50行)
    ├─ Type B: 架构决策 → docs/adr/ (< 200行)
    ├─ Type C: API/功能文档 → docs/ (< 500行)
    ├─ Type D: 常见问题 → KNOWLEDGE.md FAQ (< 50行)
    └─ Type E: 无需文档

2.4 生成缺口报告（含成本信息）
    - 按严重程度分类
    - 显示建议的文档位置
    - 预估每个文档的大小
    - 显示总体成本影响
```

### 步骤 3: 交互式用户确认（门控）

```
3.1 展示分析结果和成本估计
    - 代码库概览
    - 文档缺口列表
    - 建议的文档和预估大小
    - 总体成本影响（百分比增长）

3.2 用户选择
    └─ 交互式确认
       ├─ 同意全部生成
       ├─ 选择部分生成（取消某些高成本项）
       └─ 取消生成（返回）

3.3 最终确认
    - 显示将要生成的最终文档列表
    - 最终的成本估计
    - 用户确认后继续，否则返回
```

### 步骤 4: 智能提取和生成（约束驱动）

```
4.1 根据选择的文档类型，提取相应信息
    - API 文档 → 从路由定义提取
    - 环境变量 → 从 .env.example 和代码提取
    - 开发指南 → 从依赖文件和脚本提取
    - 架构文档 → 从模块分析提取

4.2 学习项目风格
    - 分析现有文档的写作风格
    - 提取术语表
    - 识别常用模式

4.3 文档生成
    - 选择合适的模板
    - 填充提取的信息
    - 应用项目风格
    - 生成文档文件

4.4 自动添加 Frontmatter
    ✅ **必须调用**：~/.claude/commands/scripts/frontmatter_utils.py

    对每个生成的文档:
    python ~/.claude/commands/scripts/frontmatter_utils.py generate <doc_path>
```

### 步骤 5: 约束检查和验证（强制门控）

```
5.1 验证 Frontmatter 完整性
    python ~/.claude/commands/scripts/frontmatter_utils.py validate docs/

    必须全部通过:
    - ✅ 7 个必需字段完整
    - ✅ 枚举值有效
    - ✅ 日期格式正确
    - ✅ 关联路径存在

    ❌ 如果验证失败 → 返回错误，要求修复

5.2 重新计算成本影响
    - 统计实际生成的文档大小
    - 重新计算 KNOWLEDGE.md 增长率
    - 重新计算 docs/ 增长率

    🔴 若超过约束 → 请求用户:
        ① 减少文档范围
        ② 拆分成多个 commit
        ③ 先清理旧文档再提交

    ✅ 若符合约束 → 继续

5.3 更新 KNOWLEDGE.md 索引
    python ~/.claude/commands/scripts/frontmatter_utils.py update-index KNOWLEDGE.md

    必须通过:
    - ✅ 索引表已更新
    - ✅ 无重复条目
    - ✅ 链接有效
```

### 步骤 6: 最终确认和报告

```
6.1 生成最终报告
    - 总结生成的文档列表
    - 显示最终的成本影响
    - 列出更新的文件

6.2 提供后续建议
    - "文档已生成！"
    - "下一步：运行 /wf_08_review 进行代码审查"
    - "审查包括 Dimension 6 文档架构合规性检查"
    - "如果审查通过，运行 /wf_11_commit 保存进度"

6.3 记录到 KNOWLEDGE.md 文档决策
    - 类型和位置
    - 成本影响
    - 决策时间戳
```
