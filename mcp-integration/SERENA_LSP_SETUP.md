---
title: "Serena LSP åˆå§‹åŒ–å®Œæ•´æŒ‡å—"
description: "æ·±å…¥ç†è§£ Serena çš„è¯­è¨€æœåŠ¡å™¨ï¼ˆLSPï¼‰æ¶æ„ã€åˆå§‹åŒ–æµç¨‹ã€é…ç½®é€‰é¡¹å’Œæ€§èƒ½ä¼˜åŒ–"
type: "æŠ€æœ¯è®¾è®¡"
status: "å®Œæˆ"
priority: "é«˜"
created_date: "2025-11-22"
last_updated: "2025-11-22"
related_documents:
  - docs/integration/MCP_USER_GUIDE.md
  - docs/integration/MCP_ARCHITECTURE.md
related_code:
  - ~/.serena/serena_config.yml
  - scripts/install_mcp.py
tags:
  - serena
  - lsp
  - language-server
  - initialization
  - performance
authors:
  - Claude Code
version: "1.0"
---

# Serena LSP åˆå§‹åŒ–å®Œæ•´æŒ‡å—

## ğŸ“‹ ç›®å½•

1. [ä»€ä¹ˆæ˜¯ LSP](#ä»€ä¹ˆæ˜¯-lsp)
2. [Serena çš„ LSP æ¶æ„](#serena-çš„-lsp-æ¶æ„)
3. [LSP åˆå§‹åŒ–æµç¨‹](#lsp-åˆå§‹åŒ–æµç¨‹)
4. [æ”¯æŒçš„è¯­è¨€å’Œ LSP å®ç°](#æ”¯æŒçš„è¯­è¨€å’Œ-lsp-å®ç°)
5. [é…ç½®æŒ‡å—](#é…ç½®æŒ‡å—)
6. [æ€§èƒ½åŸºå‡†å’Œä¼˜åŒ–](#æ€§èƒ½åŸºå‡†å’Œä¼˜åŒ–)
7. [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥)
8. [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## ä»€ä¹ˆæ˜¯ LSP

### åŸºæœ¬æ¦‚å¿µ

**LSP** (Language Server Protocol) æ˜¯ä¸€ä¸ªå¼€æ”¾åè®®ï¼Œå®šä¹‰äº†ç¼–è¾‘å™¨ä¸è¯­è¨€æœåŠ¡å™¨ä¹‹é—´çš„é€šä¿¡æ–¹å¼ã€‚

**è¯­è¨€æœåŠ¡å™¨** æ˜¯ä¸€ä¸ªç‹¬ç«‹è¿›ç¨‹ï¼Œæä¾›ï¼š
- ğŸ” **ä»£ç ç†è§£** - ç¬¦å·ç´¢å¼•ã€ç±»å‹æ¨æ–­ã€å£°æ˜æŸ¥æ‰¾
- ğŸ“ **ä»£ç å®Œæˆ** - è‡ªåŠ¨è¡¥å…¨ã€ç¬¦å·å»ºè®®
- ğŸ”— **ä»£ç å¯¼èˆª** - å®šä¹‰æŸ¥æ‰¾ã€å¼•ç”¨æŸ¥æ‰¾ã€è°ƒç”¨å±‚æ¬¡
- ğŸ› **è¯Šæ–­** - ç¼–è¯‘é”™è¯¯ã€è­¦å‘Šã€ä»£ç åˆ†æ

### Serena ä¸ºä»€ä¹ˆéœ€è¦ LSPï¼Ÿ

Serena æ˜¯ä¸€ä¸ª **AI ç¼–ç¨‹åŠ©æ‰‹**ï¼Œéœ€è¦æ·±åº¦çš„ä»£ç ç†è§£æ¥ï¼š
- âœ… ç²¾ç¡®å®šä½ä»£ç ä¸­çš„ç¬¦å·ï¼ˆå‡½æ•°ã€ç±»ã€å˜é‡ï¼‰
- âœ… å»ºç«‹ä»£ç -æ–‡æ¡£çš„æ˜ å°„å…³ç³»
- âœ… ç†è§£ä»£ç ç»“æ„å’Œä¾èµ–å…³ç³»
- âœ… æ”¯æŒç¬¦å·çº§åˆ«çš„ä»£ç ä¿®æ”¹ï¼ˆé‡å‘½åã€ç§»åŠ¨ã€æ›¿æ¢ï¼‰

**LSP çš„æ ¸å¿ƒä»·å€¼**ï¼š
```
åŸå§‹å·¥å…·: grep æœç´¢ â†’ æ‰¾åˆ°åŒ¹é…è¡Œï¼Œä½†ä¸ç†è§£è¯­ä¹‰
LSP å·¥å…·: ç¬¦å·æŸ¥è¯¢  â†’ æ‰¾åˆ°ç¡®åˆ‡çš„ç¬¦å·å®šä¹‰ï¼Œç†è§£ä¸Šä¸‹æ–‡
```

---

## Serena çš„ LSP æ¶æ„

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Serena MCP Server (Claude Desktop)                      â”‚
â”‚  â”œâ”€ Project Management                                  â”‚
â”‚  â”‚  â”œâ”€ activate_project()                               â”‚
â”‚  â”‚  â””â”€ project.yml é…ç½®                                 â”‚
â”‚  â”‚                                                       â”‚
â”‚  â”œâ”€ Language Server Manager                             â”‚
â”‚  â”‚  â”œâ”€ Language Detection (æ£€æµ‹é¡¹ç›®è¯­è¨€)                â”‚
â”‚  â”‚  â””â”€ LSP Process Pool                                 â”‚
â”‚  â”‚     â”œâ”€ Pyright (Python LSP)                          â”‚
â”‚  â”‚     â”œâ”€ TypeScript Language Server (JS/TS LSP)        â”‚
â”‚  â”‚     â”œâ”€ Gopls (Go LSP)                                â”‚
â”‚  â”‚     â”œâ”€ Rust Analyzer (Rust LSP)                      â”‚
â”‚  â”‚     â””â”€ ...å…¶ä»– LSP å®ç°                              â”‚
â”‚  â”‚                                                       â”‚
â”‚  â”œâ”€ Symbol Index Manager                                â”‚
â”‚  â”‚  â”œâ”€ AST ç”Ÿæˆ (Abstract Syntax Tree)                  â”‚
â”‚  â”‚  â”œâ”€ Symbol Table (ç¬¦å·è¡¨)                            â”‚
â”‚  â”‚  â”œâ”€ Reference Graph (å¼•ç”¨å…³ç³»å›¾)                     â”‚
â”‚  â”‚  â””â”€ Cache Management (ç¼“å­˜ç®¡ç†)                      â”‚
â”‚  â”‚                                                       â”‚
â”‚  â””â”€ Tool Exposures (23 ä¸ªå·¥å…·)                          â”‚
â”‚     â”œâ”€ Symbol Tools (find_symbol, get_symbols_overview) â”‚
â”‚     â”œâ”€ Reference Tools (find_referencing_symbols)       â”‚
â”‚     â”œâ”€ Edit Tools (replace_symbol_body, rename_symbol)  â”‚
â”‚     â””â”€ ...å…¶ä»–å·¥å…·                                      â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€ Reads: Project files, source code
         â”œâ”€ Writes: Symbol index (å†…å­˜ä¸­)
         â””â”€ Maintains: LSP connections
```

### LSP åˆå§‹åŒ–é˜¶æ®µçš„æ•°æ®æµ

```
æ—¶é—´åºåˆ—                    æ•°æ®æµåŠ¨
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

[1] /wf_03_prime å‘½ä»¤è°ƒç”¨
      â”‚
      â”œâ”€ "Activate project: /path/to/project"
      â”‚
      â–¼
[2] Serena é¡¹ç›®æ¿€æ´»
      â”‚
      â”œâ”€ è¯»å– project.yml é…ç½®
      â”œâ”€ æ£€æµ‹é¡¹ç›®ç¼–ç¨‹è¯­è¨€ (Python/JS/Go/Rust/etc)
      â”‚
      â–¼
[3] è¯­è¨€æœåŠ¡å™¨å¯åŠ¨ ğŸ”´ (LSP åˆå§‹åŒ–å¼€å§‹)
      â”‚
      â”œâ”€ æ ¹æ®æ£€æµ‹çš„è¯­è¨€å¯åŠ¨å¯¹åº” LSP
      â”‚  â”œâ”€ Python â†’ å¯åŠ¨ Pyright
      â”‚  â”œâ”€ JavaScript â†’ å¯åŠ¨ TypeScript Language Server
      â”‚  â”œâ”€ Go â†’ å¯åŠ¨ Gopls
      â”‚  â””â”€ ...
      â”‚
      â”œâ”€ LSP è¿›ç¨‹å¯åŠ¨ (è€—æ—¶ ~2-5 ç§’)
      â”‚
      â–¼
[4] LSP é¡¹ç›®åˆå§‹åŒ–
      â”‚
      â”œâ”€ LSP åŠ è½½é¡¹ç›®é…ç½® (tsconfig.json, pyproject.toml ç­‰)
      â”œâ”€ LSP è®¾ç½®æ–‡ä»¶ç›‘è§† (file watching)
      â”‚
      â–¼
[5] ä»£ç æ‰«æå’Œç´¢å¼•ç”Ÿæˆ ğŸ“š (è€—æ—¶ ~5-25 ç§’)
      â”‚
      â”œâ”€ LSP æ‰«æé¡¹ç›®ä¸­çš„æ‰€æœ‰æºæ–‡ä»¶
      â”œâ”€ å¯¹æ¯ä¸ªæ–‡ä»¶ç”Ÿæˆ AST (Abstract Syntax Tree)
      â”œâ”€ æå–ç¬¦å·å®šä¹‰ (functions, classes, variables)
      â”œâ”€ å»ºç«‹ç¬¦å·è¡¨ (Symbol Table)
      â”œâ”€ ç”Ÿæˆå¼•ç”¨å…³ç³»å›¾
      â”‚
      â–¼
[6] Serena ç¼“å­˜ç¬¦å·ç´¢å¼•
      â”‚
      â”œâ”€ å°† LSP çš„ç¬¦å·è¡¨ç¼“å­˜åˆ°å†…å­˜
      â”œâ”€ å»ºç«‹ä»£ç -æ–‡æ¡£æ˜ å°„
      â”‚
      â–¼
[7] åˆå§‹åŒ–å®Œæˆ âœ…
      â”‚
      â”œâ”€ æ‰€æœ‰ 23 ä¸ªå·¥å…·å·²å‡†å¤‡
      â”œâ”€ ç¬¦å·æŸ¥è¯¢å¯ç”¨
      â”œâ”€ ä»£ç ä¿®æ”¹æ“ä½œå¯ç”¨
      â”‚
      â–¼
    ç”¨æˆ·å¯ä»¥å¼€å§‹å·¥ä½œ
```

### å…³é”®æ¦‚å¿µ

| æ¦‚å¿µ | è¯´æ˜ | ç”¨é€” |
|------|------|------|
| **AST** | Abstract Syntax Treeï¼Œä»£ç çš„æ ‘å½¢è¡¨ç¤º | LSP çš„åŸºç¡€ï¼Œç”¨äºç†è§£ä»£ç ç»“æ„ |
| **ç¬¦å·è¡¨** | Symbol Tableï¼Œæ‰€æœ‰å®šä¹‰çš„åç§°å’Œä½ç½® | `find_symbol()` çš„æ•°æ®æ¥æº |
| **å¼•ç”¨å…³ç³»å›¾** | Reference Graphï¼Œè°å¼•ç”¨äº†è° | `find_referencing_symbols()` çš„æ•°æ® |
| **LSP ä¼šè¯** | Language Server è¿›ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ | Serena çš„é¡¹ç›®æ¿€æ´»æœŸé—´ä¿æŒæ´»è·ƒ |
| **ç¼“å­˜** | Symbol Index Cacheï¼Œå†…å­˜ä¸­çš„ç´¢å¼• | åŠ å¿«åç»­æŸ¥è¯¢é€Ÿåº¦ |

---

## LSP åˆå§‹åŒ–æµç¨‹

### å®Œæ•´çš„åˆå§‹åŒ–æ—¶é—´è¡¨

```
æ—¶é—´ç‚¹        äº‹ä»¶                        è€—æ—¶        ç´¯è®¡æ—¶é—´
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
T+0s         ç”¨æˆ·æ‰§è¡Œ /wf_03_prime
T+0s         Serena é¡¹ç›®æ¿€æ´»             <100ms     ~0.1s
T+0.1s       æ£€æµ‹é¡¹ç›®è¯­è¨€                <50ms      ~0.15s
T+0.15s      å¯åŠ¨è¯­è¨€æœåŠ¡å™¨              2-5s       ~2-5s
T+2-5s       LSP åŠ è½½é¡¹ç›®é…ç½®            1-2s       ~3-7s
T+3-7s       ä»£ç æ‰«æå’Œç´¢å¼•ç”Ÿæˆ ğŸ“š       5-25s      ~8-30s
T+8-30s      ç¼“å­˜å®Œæˆï¼Œé¡¹ç›®å‡†å¤‡å°±ç»ª âœ…   <100ms     ~8-30s

â±ï¸ æ€»è€—æ—¶èŒƒå›´: 8-30 ç§’ï¼ˆé¦–æ¬¡æ¿€æ´»ï¼‰
ğŸ’¾ ç¼“å­˜åŠ è½½: < 1 ç§’ï¼ˆåç»­æ¿€æ´»ï¼‰
```

### æ€§èƒ½å› ç´ åˆ†æ

| å› ç´  | å½±å“ | ä¼˜åŒ–æ–¹æ³• |
|------|------|--------|
| **é¡¹ç›®å¤§å°** | æ–‡ä»¶æ•°è¶Šå¤šï¼Œç´¢å¼•è¶Šæ…¢ | é…ç½® .gitignoreï¼Œæ’é™¤ node_modules ç­‰ |
| **ç¼–ç¨‹è¯­è¨€** | ä¸åŒ LSP çš„å¯åŠ¨é€Ÿåº¦ä¸åŒ | Pyright (å¿«), TypeScript LS (å¿«), Gopls (ä¸­ç­‰) |
| **ç¡¬ä»¶æ€§èƒ½** | CPU/å†…å­˜å½±å“æ‰«æé€Ÿåº¦ | ä½¿ç”¨ SSDï¼Œè¶³å¤Ÿçš„ RAM |
| **LSP ç‰ˆæœ¬** | æ–°ç‰ˆæœ¬é€šå¸¸æ›´å¿« | å®šæœŸæ›´æ–°è¯­è¨€æœåŠ¡å™¨ |
| **ç¼“å­˜ç­–ç•¥** | é¦–æ¬¡ vs åç»­æ¿€æ´» | Serena ä½¿ç”¨å†…å­˜ç¼“å­˜ï¼Œé‡å¯åéœ€è¦é‡å»º |

---

## æ”¯æŒçš„è¯­è¨€å’Œ LSP å®ç°

### å®˜æ–¹æ”¯æŒçš„è¯­è¨€

| è¯­è¨€ | LSP å®ç° | å¯åŠ¨æ—¶é—´ | ç¬¦å·ç´¢å¼•æ—¶é—´ | å¤‡æ³¨ |
|------|---------|--------|-----------|------|
| **Python** | Pyright | 2-3s | 5-10s | æ¨èï¼Œå¿«é€Ÿä¸”å‡†ç¡® |
| **JavaScript** | TypeScript LSP | 2-4s | 5-15s | Node.js é¡¹ç›®ä¼˜åŒ–å¥½ |
| **TypeScript** | TypeScript LSP | 2-4s | 5-15s | åŒ JavaScript |
| **Go** | Gopls | 3-5s | 10-20s | å¤§é¡¹ç›®å¯èƒ½è¾ƒæ…¢ |
| **Rust** | Rust Analyzer | 3-5s | 10-25s | åŠŸèƒ½å®Œæ•´ï¼Œé€Ÿåº¦ä¸­ç­‰ |
| **Java** | Eclipse JDT LS | 4-8s | 15-30s | ä¼ä¸šçº§ï¼ŒåŠŸèƒ½å®Œæ•´ |
| **C/C++** | Clangd | 2-4s | 5-20s | ä¾èµ– compile_commands.json |

### LSP é€‰æ‹©æŒ‡å—

```
é€‰æ‹©æ­£ç¡®çš„ LSP å¾ˆé‡è¦ï¼

Python é¡¹ç›®?
â”œâ”€ YES â†’ Pyright (æœ€ä½³é€‰æ‹©ï¼Œå¿«é€Ÿå‡†ç¡®)
â””â”€ NO â†’ ä¸‹ä¸€ä¸ª

JavaScript/TypeScript é¡¹ç›®?
â”œâ”€ YES â†’ TypeScript Language Server (å®˜æ–¹ï¼ŒåŠŸèƒ½å®Œæ•´)
â””â”€ NO â†’ ä¸‹ä¸€ä¸ª

Go é¡¹ç›®?
â”œâ”€ YES â†’ Gopls (Go å®˜æ–¹ï¼ŒåŠŸèƒ½å®Œæ•´)
â””â”€ NO â†’ ä¸‹ä¸€ä¸ª

å…¶ä»–è¯­è¨€ï¼Ÿ
â””â”€ æŸ¥çœ‹ https://microsoft.github.io/language-server-protocol/implementors/tools/
```

---

## é…ç½®æŒ‡å—

### Serena å…¨å±€é…ç½®

Serena çš„ä¸»é…ç½®æ–‡ä»¶ä½äº `~/.serena/serena_config.yml`ã€‚

#### LSP ç›¸å…³é…ç½®é€‰é¡¹

```yaml
# ~/.serena/serena_config.yml ä¸­çš„ LSP ç›¸å…³è®¾ç½®

# 1ï¸âƒ£ LSP é€šä¿¡è¿½è¸ªï¼ˆè°ƒè¯•ç”¨ï¼‰
trace_lsp_communication: false
# è®¾ç½®ä¸º true å¯ä»¥çœ‹åˆ° Serena â†” LSP çš„æ‰€æœ‰é€šä¿¡
# ç”¨äºè°ƒè¯• LSP é—®é¢˜ï¼Œä½†ä¼šäº§ç”Ÿå¤§é‡æ—¥å¿—

# 2ï¸âƒ£ è¯­è¨€æœåŠ¡å™¨ç‰¹å®šè®¾ç½®
ls_specific_settings:
  cpp:
    # C++ é¡¹ç›®çš„ clangd é…ç½®
    clangd_path: /path/to/clangd
    clangd_args:
      - --compile-commands-dir=/path/to/project

  # å…¶ä»–è¯­è¨€çš„é…ç½®å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ 
  # python:
  #   ... (Pyright ä¸éœ€è¦ç‰¹æ®Šé…ç½®)
  # javascript:
  #   ... (TypeScript LSP ä¸éœ€è¦ç‰¹æ®Šé…ç½®)

# 3ï¸âƒ£ å·¥å…·æ‰§è¡Œè¶…æ—¶
tool_timeout: 240
# å•ä¸ªå·¥å…·æ‰§è¡Œçš„æœ€é•¿æ—¶é—´ï¼ˆç§’ï¼‰
# LSP æ“ä½œé€šå¸¸ < 1 ç§’ï¼Œä½†å¤§é¡¹ç›®å¯èƒ½éœ€è¦æ›´é•¿æ—¶é—´
# å»ºè®®: 240 ç§’ (4 åˆ†é’Ÿ) æ˜¯åˆç†çš„é»˜è®¤å€¼

# 4ï¸âƒ£ æœ€å¤§ç­”å¤å­—ç¬¦æ•°ï¼ˆå½±å“ LSP è¿”å›æ•°æ®é‡ï¼‰
default_max_tool_answer_chars: 150000
# LSP çš„ find_referencing_symbols ç­‰å·¥å…·å¯èƒ½è¿”å›å¤§é‡æ•°æ®
# è¿™ä¸ªè®¾ç½®é™åˆ¶å•æ¬¡å·¥å…·è°ƒç”¨çš„è¿”å›å¤§å°
# å»ºè®®: 150000 å­—ç¬¦ (çº¦ 30KB) çš„ä¿¡æ¯é‡

# 5ï¸âƒ£ Token è®¡æ•°ä¼°è®¡æ–¹æ³•
token_count_estimator: CHAR_COUNT
# ç”¨äºä¼°è®¡ API è°ƒç”¨çš„ token æ•°é‡
# é€‰é¡¹:
#   - CHAR_COUNT: ç®€å•å­—ç¬¦è®¡æ•°ï¼ˆå¿«é€Ÿï¼Œé»˜è®¤ï¼‰
#   - TIKTOKEN_GPT4: åŸºäº GPT-4 tokenizerï¼ˆç²¾ç¡®ï¼‰
#   - ANTHROPIC_CLAUDE_SONNET_4: åŸºäº Claude tokenizerï¼ˆæœ€ç²¾ç¡®ï¼‰
```

### é¡¹ç›®çº§é…ç½®

æ¯ä¸ªé¡¹ç›®éƒ½æœ‰è‡ªå·±çš„ Serena é…ç½®æ–‡ä»¶ï¼š`<project>/.serena/project.yml`

#### é¡¹ç›®é…ç½®ç¤ºä¾‹

```yaml
# /path/to/your/project/.serena/project.yml

# é¡¹ç›®åŸºæœ¬ä¿¡æ¯
name: "my-project"
description: "My awesome project"
language: "python"
# å¯é€‰çš„è¯­è¨€: python, javascript, go, rust, java, cpp, csharp, php, etc.

# æºä»£ç è·¯å¾„
src_dir: "src"
# å¯ä»¥æ˜¯ç›¸å¯¹è·¯å¾„ï¼ŒSerena ä¼šç›¸å¯¹äº project.yml çš„ä½ç½®

# æ„å»ºé…ç½®ï¼ˆå¦‚æœéœ€è¦ï¼‰
build_config:
  build_dir: "build"
  config_file: "tsconfig.json"  # å¯¹äº TS/JS é¡¹ç›®

# LSP åˆå§‹åŒ–é€‰é¡¹
lsp_init_options:
  # å¯é€‰: è°ƒæ•´ LSP çš„åˆå§‹åŒ–è¡Œä¸º
  # è¿™å–å†³äºå…·ä½“çš„ LSP å®ç°
  initializationOptions: {}

# å¿½ç•¥çš„æ–‡ä»¶å¤¹ï¼ˆåŠ å¿«æ‰«æé€Ÿåº¦ï¼‰
ignore_dirs:
  - "node_modules"
  - "venv"
  - ".git"
  - "dist"
  - "build"
  - "__pycache__"
```

### æœ€å°åŒ–é…ç½®

å¦‚æœé¡¹ç›®æ²¡æœ‰ç‰¹æ®Šéœ€æ±‚ï¼ŒSerena ä¼šä½¿ç”¨é»˜è®¤é…ç½®ï¼š

```yaml
# æœ€å°å¯è¡Œé…ç½®
name: "my-project"
language: "python"
src_dir: "."
```

---

## æ€§èƒ½åŸºå‡†å’Œä¼˜åŒ–

### å®˜æ–¹æ€§èƒ½åŸºå‡†

åŸºäºåœ¨ä¸­ç­‰è§„æ¨¡é¡¹ç›®ä¸Šçš„æµ‹è¯•ï¼ˆ~5000 ä¸ªæ–‡ä»¶ï¼‰ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ€§èƒ½åŸºå‡† (Python é¡¹ç›® + Pyright)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                       â”‚
â”‚ LSP å¯åŠ¨æ—¶é—´:        ~2-3 ç§’                        â”‚
â”‚ ä»£ç æ‰«ææ—¶é—´:        ~8-12 ç§’                       â”‚
â”‚ é¦–æ¬¡æ¿€æ´»æ€»è€—æ—¶:      ~10-15 ç§’                      â”‚
â”‚                                                       â”‚
â”‚ åç»­æ¿€æ´» (ç¼“å­˜):     < 1 ç§’                          â”‚
â”‚                                                       â”‚
â”‚ find_symbol():       ~100-300 æ¯«ç§’                  â”‚
â”‚ get_symbols_overview():  ~200-500 æ¯«ç§’              â”‚
â”‚ find_referencing_symbols(): ~300-1000 æ¯«ç§’          â”‚
â”‚                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¼˜åŒ–å»ºè®®

#### ä¼˜åŒ– 1: é…ç½® .gitignoreï¼ˆæœ€æœ‰æ•ˆï¼‰

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•çš„ .gitignore ä¸­æ·»åŠ 
node_modules/
venv/
.venv/
env/
__pycache__/
*.pyc
.pytest_cache/
dist/
build/
.egg-info/
*.egg
.tox/
htmlcov/
.coverage
.idea/
.vscode/
*.swp
*.swo
*~
.DS_Store
```

**æ•ˆæœ**: ç´¢å¼•é€Ÿåº¦æå‡ 50-70%ï¼ˆå–å†³äºé¡¹ç›®ç»“æ„ï¼‰

#### ä¼˜åŒ– 2: é…ç½®é¡¹ç›® LSP åˆå§‹åŒ–é€‰é¡¹

```yaml
# project.yml ä¸­çš„ LSP ä¼˜åŒ–
lsp_init_options:
  # å¯¹äº TypeScript é¡¹ç›®
  tsserver:
    plugins: []  # ç¦ç”¨ä¸å¿…è¦çš„æ’ä»¶ï¼ŒåŠ å¿«é€Ÿåº¦

  # å¯¹äº Python é¡¹ç›®
  python:
    analysis:
      stubPackages: ["stubs"]  # æŒ‡å®š stub åŒ…ä½ç½®
```

**æ•ˆæœ**: å¯åŠ¨é€Ÿåº¦æå‡ 10-20%

#### ä¼˜åŒ– 3: é¡¹ç›®ç‰¹å®šçš„ LSP ç¼“å­˜ç­–ç•¥

Serena ä½¿ç”¨**ä¸¤å±‚ç¼“å­˜**ï¼š
1. **å†…å­˜ç¼“å­˜** (å¿«é€Ÿï¼Œper-session)
2. **ç£ç›˜ç¼“å­˜** (æŒä¹…ï¼Œè·¨-session) - å¦‚æœå¯ç”¨

```bash
# æ‰‹åŠ¨é¢„çƒ­ç¼“å­˜ï¼ˆå¯é€‰ï¼‰
cd /your/project
# è¿è¡Œä¸€æ¬¡ /wf_03_prime æ¥é¢„çƒ­ LSP ç´¢å¼•
```

**æ•ˆæœ**: åç»­ä¼šè¯çš„é¦–æ¬¡æ¿€æ´»é€Ÿåº¦ 50-80% æ›´å¿«

#### ä¼˜åŒ– 4: å¢åŠ è¶…æ—¶æ—¶é—´ï¼ˆå¤§é¡¹ç›®ï¼‰

å¯¹äºå¤§å‹é¡¹ç›®ï¼ˆ> 10,000 ä¸ªæ–‡ä»¶ï¼‰ï¼Œå¯èƒ½éœ€è¦å¢åŠ è¶…æ—¶ï¼š

```yaml
# ~/.serena/serena_config.yml
tool_timeout: 480  # ä» 240 ç§’å¢åŠ åˆ° 480 ç§’ (8 åˆ†é’Ÿ)
```

### æ€§èƒ½ç›‘æ§

#### åœ¨ Serena æ—¥å¿—ä¸­æ£€æŸ¥æ€§èƒ½

```bash
# æŸ¥çœ‹æœ€è¿‘çš„æ—¥å¿—
tail -f ~/.serena/logs/2025-11-22/mcp_*.txt

# æŸ¥æ‰¾æ€§èƒ½ç›¸å…³çš„æ—¥å¿—
grep "initialized\|completed\|time" ~/.serena/logs/2025-11-22/mcp_*.txt
```

#### é¢„æœŸçš„æ—¥å¿—è¾“å‡º

```
INFO  2025-11-22 20:54:58,923 serena.agent:__init__:222 - Starting Serena server
INFO  2025-11-22 20:54:59,100 serena.lsp:startup:156 - Starting language server for: python
INFO  2025-11-22 20:55:01,234 serena.lsp:startup:178 - Language server started (2.1s)
INFO  2025-11-22 20:55:01,240 serena.indexer:scan:201 - Scanning project files...
INFO  2025-11-22 20:55:12,567 serena.indexer:build_index:312 - Index built successfully (11.3s)
INFO  2025-11-22 20:55:12,789 serena.agent:ready:445 - Serena ready for tool calls
```

---

## æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

#### é—®é¢˜ 1: LSP å¯åŠ¨å¤±è´¥

**ç—‡çŠ¶**: æ—¥å¿—ä¸­å‡ºç° "Failed to start language server"

**è¯Šæ–­æ­¥éª¤**:
```bash
# 1. æ£€æŸ¥æ—¥å¿—
tail -100 ~/.serena/logs/2025-11-22/mcp_*.txt | grep -i "error\|fail"

# 2. æ£€æŸ¥è¯­è¨€æ£€æµ‹
grep "language:" /your/project/.serena/project.yml

# 3. æ£€æŸ¥æ‰€éœ€çš„ LSP å·¥å…·
which pyright      # å¯¹äº Python
which node         # å¯¹äº JavaScript/TypeScript
which gopls        # å¯¹äº Go
```

**å¸¸è§åŸå› å’Œè§£å†³**:
- âŒ LSP æœªå®‰è£…
  - âœ… è§£å†³: å®‰è£…å¯¹åº”çš„è¯­è¨€å·¥å…·
  ```bash
  pip install pyright              # Python
  npm install -g typescript        # JavaScript/TypeScript
  go install github.com/golang/tools/gopls@latest  # Go
  ```

- âŒ è¯­è¨€æ£€æµ‹é”™è¯¯
  - âœ… è§£å†³: åœ¨ project.yml ä¸­æ˜ç¡®æŒ‡å®šè¯­è¨€
  ```yaml
  language: "python"  # æ‰‹åŠ¨æŒ‡å®š
  ```

- âŒ é¡¹ç›®è·¯å¾„é”™è¯¯
  - âœ… è§£å†³: æ£€æŸ¥ project.yml çš„ src_dir è®¾ç½®
  ```bash
  cd /your/project
  ls -la .serena/project.yml  # ç¡®è®¤æ–‡ä»¶å­˜åœ¨
  ```

#### é—®é¢˜ 2: ç¬¦å·ç´¢å¼•ç¼“æ…¢

**ç—‡çŠ¶**: é¦–æ¬¡æ¿€æ´»éœ€è¦ > 30 ç§’

**è¯Šæ–­**:
```bash
# æŸ¥çœ‹é¡¹ç›®å¤§å°
find . -name "*.py" | wc -l      # Python æ–‡ä»¶æ•°

# æŸ¥çœ‹æœ‰æ²¡æœ‰è¢«å¿½ç•¥çš„å¤§ç›®å½•
du -sh node_modules/ venv/ .git/  # å„ç›®å½•å¤§å°
```

**è§£å†³æ–¹æ¡ˆ**:
1. é…ç½® .gitignoreï¼ˆè§ä¼˜åŒ–å»ºè®®éƒ¨åˆ†ï¼‰
2. å¢åŠ è¶…æ—¶æ—¶é—´
3. æ£€æŸ¥ç¡¬ä»¶ï¼ˆSSD vs HDDï¼‰

#### é—®é¢˜ 3: find_symbol() æ‰¾ä¸åˆ°ç¬¦å·

**ç—‡çŠ¶**: "Symbol not found" é”™è¯¯

**è¯Šæ–­**:
```bash
# æ£€æŸ¥é¡¹ç›®æ˜¯å¦æˆåŠŸæ¿€æ´»
grep "activated\|ready" ~/.serena/logs/2025-11-22/mcp_*.txt

# æ£€æŸ¥ç¬¦å·æ˜¯å¦å­˜åœ¨
grep -r "def my_function\|class MyClass" your/project/src/
```

**è§£å†³æ–¹æ¡ˆ**:
1. ç¡®ä¿ LSP åˆå§‹åŒ–å®Œæˆï¼ˆæŸ¥çœ‹æ—¥å¿—ï¼‰
2. æ£€æŸ¥ç¬¦å·åç§°æ‹¼å†™
3. ç¡®ä¿æºæ–‡ä»¶åœ¨ src_dir æŒ‡å®šçš„è·¯å¾„å†…
4. é‡æ–°æ¿€æ´»é¡¹ç›®
   ```bash
   # åœ¨ Claude ä¸­æ‰§è¡Œ
   /wf_03_prime  # é‡æ–°æ¿€æ´»é¡¹ç›®
   ```

#### é—®é¢˜ 4: LSP è¿›ç¨‹å ç”¨ CPU/å†…å­˜è¿‡é«˜

**ç—‡çŠ¶**: è®¡ç®—æœºå˜æ…¢ï¼Œé£æ‰‡å£°éŸ³å¤§

**è¯Šæ–­**:
```bash
# æŸ¥çœ‹ Serena è¿›ç¨‹
ps aux | grep serena

# æŸ¥çœ‹å†…å­˜ä½¿ç”¨
top -p <PID>
```

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥æ˜¯å¦æœ‰ç‰¹åˆ«å¤§çš„é¡¹ç›®åœ¨ç´¢å¼•ä¸­
   ```bash
   du -sh /your/project
   ```

2. ç¦ç”¨ä¸å¿…è¦çš„æ—¥å¿—è·Ÿè¸ª
   ```yaml
   # ~/.serena/serena_config.yml
   trace_lsp_communication: false  # ç¡®ä¿ä¸º false
   log_level: 30  # INFO (20) â†’ WARNING (30)
   ```

3. å‡å°‘æ‰«æèŒƒå›´
   ```yaml
   # project.yml
   ignore_dirs:
     - "node_modules"
     - "venv"
     - ".git"
   ```

### å¯ç”¨è°ƒè¯•æ¨¡å¼

å½“éœ€è¦æ·±åº¦è¯Šæ–­æ—¶ï¼Œå¯ä»¥å¯ç”¨è°ƒè¯•æ—¥å¿—ï¼š

```yaml
# ~/.serena/serena_config.yml

log_level: 10  # DEBUG (10) - æœ€è¯¦ç»†

trace_lsp_communication: true  # è¿½è¸ª LSP é€šä¿¡

# å¯ç”¨ web dashboard ç›‘æ§
web_dashboard: true
web_dashboard_open_on_launch: true
# è®¿é—® http://localhost:24282/dashboard/ æŸ¥çœ‹å®æ—¶æ—¥å¿—
```

---

## æœ€ä½³å®è·µ

### âœ… æ¨èåšæ³•

1. **ç¬¬ä¸€æ¬¡æ¿€æ´»é¡¹ç›®æ—¶è¦æœ‰è€å¿ƒ**
   ```bash
   # é¦–æ¬¡ /wf_03_prime å¯èƒ½éœ€è¦ 10-30 ç§’
   # è¿™æ˜¯æ­£å¸¸çš„ï¼æ—¥å¿—ä¼šæ˜¾ç¤ºåˆå§‹åŒ–è¿›åº¦
   ```

2. **é…ç½®å¥½ .gitignore**
   ```bash
   # è¿™æ˜¯åŠ å¿«ç´¢å¼•çš„æœ€æœ‰æ•ˆæ–¹æ³•
   # é€šå¸¸èƒ½å°†æ—¶é—´å‡å°‘ 50-70%
   ```

3. **ä½¿ç”¨æ­£ç¡®çš„å·¥å…·è¿›è¡Œä»£ç æ“ä½œ**
   ```bash
   # âŒ ä¸å¥½: ç”¨ grep æ‰¾ç¬¦å·
   grep -r "def my_function" .

   # âœ… å¥½: ç”¨ Serena çš„ç¬¦å·å·¥å…·
   # ä½¿ç”¨ /wf_06_debug --deep è¿›è¡Œç²¾ç¡®å®šä½
   ```

4. **ç›‘æ§æ—¥å¿—**
   ```bash
   # å®šæœŸæŸ¥çœ‹ Serena æ—¥å¿—ï¼Œäº†è§£æ€§èƒ½è¡¨ç°
   tail ~/.serena/logs/2025-11-22/mcp_*.txt
   ```

### âŒ é¿å…åšæ³•

1. **ä¸è¦é¢‘ç¹é‡å¯ Serena**
   - æ¯æ¬¡é‡å¯éƒ½éœ€è¦é‡æ–°ç´¢å¼•
   - é™¤éæœ‰ bug æˆ–å´©æºƒï¼Œå¦åˆ™è®©å®ƒä¿æŒè¿è¡Œ

2. **ä¸è¦åœ¨å¤§å‹ node_modules ä¸Šè¿è¡Œ find_symbol()**
   - è¿™ä¼šå¯¼è‡´ç´¢å¼•çˆ†ç‚¸æ€§å¢é•¿
   - ç¡®ä¿åœ¨ .gitignore ä¸­æ’é™¤å®ƒ

3. **ä¸è¦åœ¨æ²¡æœ‰ LSP å‡†å¤‡å¥½çš„æƒ…å†µä¸‹ä½¿ç”¨ç¬¦å·å·¥å…·**
   - æ—¥å¿—ä¸­åº”è¯¥çœ‹åˆ° "ready for tool calls"
   - å¦åˆ™å·¥å…·ä¼šè¶…æ—¶

4. **ä¸è¦æ‰‹åŠ¨ç¼–è¾‘ serena_config.yml çš„æ³¨é‡Šå’Œæ ¼å¼**
   - Serena ä¼šè‡ªåŠ¨ç®¡ç†è¿™ä¸ªæ–‡ä»¶
   - åªç¼–è¾‘é…ç½®å€¼ï¼Œä¸è¦æ”¹å˜ç»“æ„

---

## å‚è€ƒèµ„æº

### å®˜æ–¹æ–‡æ¡£
- [Serena GitHub](https://github.com/oraios/serena)
- [Language Server Protocol](https://microsoft.github.io/language-server-protocol/)

### LSP å®ç°
- [Pyright (Python)](https://github.com/microsoft/pyright)
- [TypeScript Language Server](https://github.com/typescript-eslint/typescript-eslint)
- [Gopls (Go)](https://github.com/golang/tools/wiki/gopls)
- [Rust Analyzer](https://rust-analyzer.github.io/)
- [Clangd (C/C++)](https://clangd.llvm.org/)

### ç›¸å…³æ–‡æ¡£
- [MCP ç”¨æˆ·æŒ‡å—](MCP_USER_GUIDE.md)
- [MCP æ¶æ„è®¾è®¡](MCP_ARCHITECTURE.md)
- [Serena æ·±åº¦å®šä½æŒ‡å—](SERENA_DEBUG_GUIDE.md) (å¾…åˆ›å»º)

---

## FAQ - å¸¸è§é—®é¢˜

**Q: æˆ‘èƒ½çœ‹åˆ° LSP çš„ç´¢å¼•è¿›åº¦å—ï¼Ÿ**

A: æ˜¯çš„ï¼Œæ£€æŸ¥ Serena çš„ web dashboard æˆ–æ—¥å¿—æ–‡ä»¶ã€‚å¦‚æœå¯ç”¨äº† web_dashboardï¼Œå¯ä»¥è®¿é—® `http://localhost:24282/dashboard/` æŸ¥çœ‹å®æ—¶è¿›åº¦ã€‚

**Q: ä¸åŒè¯­è¨€çš„ LSP æ€§èƒ½ç›¸å·®å¤§å—ï¼Ÿ**

A: æ˜¯çš„ã€‚Pyright (Python) é€šå¸¸æ˜¯æœ€å¿«çš„ï¼Œè€Œå¤§å‹ Go/Java é¡¹ç›®å¯èƒ½éœ€è¦æ›´é•¿æ—¶é—´ã€‚è¿™ä¸»è¦å–å†³äºè¯­è¨€çš„å¤æ‚æ€§å’Œ LSP çš„ä¼˜åŒ–ã€‚

**Q: èƒ½å¦ç¦ç”¨ LSP åªä½¿ç”¨ grepï¼Ÿ**

A: æŠ€æœ¯ä¸Šå¯ä»¥ï¼Œä½†ä¸æ¨èã€‚Serena çš„ç¬¦å·å·¥å…·ä¾èµ– LSP çš„è¯­ä¹‰ç†è§£ã€‚æ²¡æœ‰ LSPï¼Œä½ åªèƒ½ä½¿ç”¨ find_file å’Œ search_for_patternï¼ŒåŠŸèƒ½ä¼šå¤§å¤§å—é™ã€‚

**Q: å¤šä¸ªé¡¹ç›®ä¼šå…±ç”¨ä¸€ä¸ª LSP å—ï¼Ÿ**

A: ä¸ä¼šã€‚æ¯ä¸ªé¡¹ç›®æ¿€æ´»æ—¶éƒ½ä¼šå¯åŠ¨è‡ªå·±çš„ LSP è¿›ç¨‹ï¼Œäº’ä¸å¹²æ‰°ã€‚åˆ‡æ¢é¡¹ç›®æ—¶ï¼Œå‰ä¸€ä¸ªé¡¹ç›®çš„ LSP ä»ä¿æŒè¿è¡Œã€‚

**Q: èƒ½å¦åŠ å¿« LSP åˆå§‹åŒ–ï¼Ÿ**

A: æ˜¯çš„ï¼Œè§"æ€§èƒ½ä¼˜åŒ–"éƒ¨åˆ†ã€‚ä¸»è¦æ–¹æ³•æ˜¯é…ç½® .gitignore å’Œé¡¹ç›®ç‰¹å®šçš„ LSP é€‰é¡¹ã€‚

**Q: LSP ä¼šä¸€ç›´è¿è¡Œå—ï¼Ÿ**

A: åªè¦ Serena MCP æœåŠ¡å™¨ä¿æŒè¿è¡Œï¼ŒLSP å°±ä¼šæŒç»­æ´»è·ƒã€‚å…³é—­ Claude Desktop æˆ–åœæ­¢ Serena ä¼šå…³é—­ LSPã€‚

---

**æœ€åæ›´æ–°**: 2025-11-22
**ç»´æŠ¤è€…**: Claude Code
**ç‰ˆæœ¬**: 1.0
