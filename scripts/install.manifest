#!/bin/bash

###############################################################################
# Installation Manifest - Single Source of Truth for File Lists
#
# This file is sourced by both install.sh and uninstall.sh to ensure
# consistent file lists across installation and uninstallation.
#
# âš ï¸  IMPORTANT: Keep all arrays synchronized!
#     When adding new files, update ALL relevant arrays below.
#
# Usage:
#   source "${SCRIPT_DIR}/scripts/install.manifest"
###############################################################################

# ============================================================================
# File Manifests - Define all files to be installed/uninstalled
# ============================================================================

# Workflow command files - glob pattern for all wf_*.md files
declare -ga COMMAND_FILES=(
    "wf_*.md"  # Glob pattern - expands to all matching files
)

# Global configuration files
declare -ga CONFIG_FILES=(
    "CLAUDE.md"
)

# Utility scripts to install to ~/.claude/scripts/
# âš ï¸  SYNC NOTE: This is the source of truth for script files
#     If you add a new script:
#     1. Place it in scripts/ directory
#     2. Add its name to this array
#     3. Both install.sh and uninstall.sh will automatically use it
declare -ga SCRIPT_FILES=(
    "install_utils.sh"
    "frontmatter_utils.py"
    "doc_graph_builder.py"
)

# Optional documentation files (installed with --include-docs)
declare -ga DOC_FILES=(
    "COMMANDS.md"
    "WORKFLOWS.md"
    "TROUBLESHOOTING.md"
    "PHILOSOPHY.md"
)

# Guide documents - extracted from Tier 1 optimization (always installed)
# âš ï¸  CRITICAL: These guides are referenced by main command files
#     Must be installed for commands to function correctly
declare -ga GUIDE_FILES=(
    "docs/guides/doc_maintenance_process.md"
    "docs/guides/doc_maintenance_workflows.md"
    "docs/guides/parallel_execution_pattern.md"
    "docs/guides/wf_03_prime_mcp_serena.md"
    "docs/guides/wf_03_prime_smart_loading.md"
    "docs/guides/wf_03_prime_workflows.md"
    "docs/guides/wf_04_research_mcp_guide.md"
    "docs/guides/wf_04_research_output_formats.md"
    "docs/guides/wf_04_research_workflows.md"
    "docs/guides/wf_05_code_doc_sync_guide.md"
    "docs/guides/wf_05_code_serena_guide.md"
    "docs/guides/wf_05_code_workflows.md"
    "docs/guides/wf_08_review_doc_compliance.md"
    "docs/guides/wf_08_review_parallel.md"
    "docs/guides/wf_08_review_process.md"
    "docs/guides/wf_08_review_self_check.md"
)

# Example documents - required by wf_14_doc.md (always installed)
# âš ï¸  CRITICAL: These examples are referenced by wf_14_doc command
#     Must be installed for document generation functionality
declare -ga EXAMPLE_FILES=(
    # Core examples
    "docs/examples/wf_14_doc_examples.md"
    "docs/examples/doc_generation_workflow.md"
    "docs/examples/doc_generation_outputs.md"
    "docs/examples/doc_generation_best_practices.md"
    "docs/examples/doc_generation_next_steps.md"
    "docs/examples/doc_generation_troubleshooting.md"
    "docs/examples/doc_generation_decision_tree.md"
    "docs/examples/doc_generation_quick_guide.md"
    "docs/examples/frontmatter_quick_reference.md"

    # Document templates
    "docs/examples/doc_templates/README_template.md"
    "docs/examples/doc_templates/API_template.md"
    "docs/examples/doc_templates/ARCHITECTURE_template.md"
    "docs/examples/doc_templates/DEV_GUIDE_template.md"
    "docs/examples/doc_templates/DEPLOYMENT_template.md"

    # UI-enhanced templates
    "docs/examples/doc_templates/ui_enhanced/API_explorer_template.md"
    "docs/examples/doc_templates/ui_enhanced/ARCHITECTURE_diagram_template.md"
    "docs/examples/doc_templates/ui_enhanced/DEV_wizard_template.md"
    "docs/examples/doc_templates/ui_enhanced/UI_COST_ANALYSIS.md"
)

# Reference documents - required by multiple commands (always installed)
# âš ï¸  CRITICAL: These references are cited by command files
#     Must be installed for proper command functionality
declare -ga REFERENCE_FILES=(
    "docs/reference/FRONTMATTER.md"
    "docs/reference/AI_ROLES_LIBRARY.md"
    "docs/reference/MARKDOWN_STYLE.md"
)

# ============================================================================
# Installation Directories - Paths for installation targets
# ============================================================================

# These are derived from environment variables for flexibility
INSTALL_DIR="${HOME}/.claude"
COMMANDS_DIR="${INSTALL_DIR}/commands"
SCRIPTS_DIR="${COMMANDS_DIR}/scripts"
DOCS_DIR="${INSTALL_DIR}/docs"
BACKUP_DIR="${INSTALL_DIR}/backup"

# ============================================================================
# Validation Functions
# ============================================================================

# Verify manifest consistency
validate_manifest() {
    local errors=0

    echo "ğŸ“‹ Validating installation manifest..."

    # Check if arrays are defined
    if [[ -z "${COMMAND_FILES[*]}" ]]; then
        echo "âŒ COMMAND_FILES is empty"
        ((errors++))
    fi

    if [[ -z "${CONFIG_FILES[*]}" ]]; then
        echo "âŒ CONFIG_FILES is empty"
        ((errors++))
    fi

    if [[ -z "${SCRIPT_FILES[*]}" ]]; then
        echo "âŒ SCRIPT_FILES is empty"
        ((errors++))
    fi

    if [[ -z "${GUIDE_FILES[*]}" ]]; then
        echo "âŒ GUIDE_FILES is empty"
        ((errors++))
    fi

    if [[ -z "${EXAMPLE_FILES[*]}" ]]; then
        echo "âŒ EXAMPLE_FILES is empty"
        ((errors++))
    fi

    if [[ -z "${REFERENCE_FILES[*]}" ]]; then
        echo "âŒ REFERENCE_FILES is empty"
        ((errors++))
    fi

    if [[ $errors -eq 0 ]]; then
        echo "âœ… Manifest validation passed"
        return 0
    else
        echo "âŒ Manifest validation failed ($errors errors)"
        return 1
    fi
}

# Print manifest summary
print_manifest_summary() {
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "Installation Manifest Summary"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "ğŸ“‹ Files to be installed:"
    echo "  Commands:       ${COMMAND_FILES[*]}"
    echo "  Config files:   ${CONFIG_FILES[*]}"
    echo "  Scripts:        ${SCRIPT_FILES[*]}"
    echo "  Guides:         ${#GUIDE_FILES[@]} files (docs/guides/)"
    echo "  Examples:       ${#EXAMPLE_FILES[@]} files (docs/examples/)"
    echo "  References:     ${#REFERENCE_FILES[@]} files (docs/reference/)"
    if [[ -n "${DOC_FILES[*]}" ]]; then
        echo "  Documentation:  ${DOC_FILES[*]}"
    fi
    echo ""
    echo "ğŸ“ Target directories:"
    echo "  Commands:  $COMMANDS_DIR"
    echo "  Scripts:   $SCRIPTS_DIR"
    echo "  Guides:    $COMMANDS_DIR/docs/guides/"
    echo "  Examples:  $COMMANDS_DIR/docs/examples/"
    echo "  References: $COMMANDS_DIR/docs/reference/"
    echo "  Docs:      $DOCS_DIR"
    echo "  Backup:    $BACKUP_DIR"
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
}

# ============================================================================
# Export declarations for use in sourced scripts
# ============================================================================

export INSTALL_DIR COMMANDS_DIR SCRIPTS_DIR DOCS_DIR BACKUP_DIR
export COMMAND_FILES CONFIG_FILES SCRIPT_FILES DOC_FILES GUIDE_FILES EXAMPLE_FILES REFERENCE_FILES

# Export functions
export -f validate_manifest print_manifest_summary
