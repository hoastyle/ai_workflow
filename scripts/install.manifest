#!/bin/bash

###############################################################################
# Installation Manifest - Single Source of Truth for File Lists
#
# This file is sourced by both install.sh and uninstall.sh to ensure
# consistent file lists across installation and uninstallation.
#
# ‚ö†Ô∏è  IMPORTANT: Keep all arrays synchronized!
#     When adding new files, update ALL relevant arrays below.
#
# Usage:
#   source "${SCRIPT_DIR}/scripts/install.manifest"
###############################################################################

# ============================================================================
# File Manifests - Define all files to be installed/uninstalled
# ============================================================================

# Workflow command files - glob pattern for all wf_*.md files
declare -ga COMMAND_FILES=(
    "wf_*.md"  # Glob pattern - expands to all matching files
)

# Global configuration files
declare -ga CONFIG_FILES=(
    "CLAUDE.md"
)

# Utility scripts to install to ~/.claude/scripts/
# ‚ö†Ô∏è  SYNC NOTE: This is the source of truth for script files
#     If you add a new script:
#     1. Place it in scripts/ directory
#     2. Add its name to this array
#     3. Both install.sh and uninstall.sh will automatically use it
declare -ga SCRIPT_FILES=(
    "install_utils.sh"
    "frontmatter_utils.py"
    "doc_graph_builder.py"
    "doc_guard.py"
    "diagnose_mcp.sh"
    "wf_03_prime_launcher.py"
)

# Optional documentation files (installed with --include-docs)
declare -ga DOC_FILES=(
    "COMMANDS.md"
    "WORKFLOWS.md"
    "TROUBLESHOOTING.md"
    "PHILOSOPHY.md"
    "SERENA_MCP_SOLUTION.md"
    "docs/QUICK_START_MCP.md"
    "docs/SERENA_MCP_TROUBLESHOOTING.md"
)

# Guide documents - extracted from Tier 1 optimization (always installed)
# ‚ö†Ô∏è  CRITICAL: These guides are referenced by main command files
#     Must be installed for commands to function correctly
declare -ga GUIDE_FILES=(
    "docs/guides/_TEMPLATE_workflows.md"
    "docs/guides/command_consistency_strategy.md"
    "docs/guides/deployment_compatibility_guide.md"
    "docs/guides/doc_maintenance_process.md"
    "docs/guides/doc_maintenance_workflows.md"
    "docs/guides/OPTIMIZATION_GUIDE.md"
    "docs/guides/parallel_execution_pattern.md"
    "docs/guides/wf_03_prime_mcp_serena.md"
    "docs/guides/wf_03_prime_smart_loading.md"
    "docs/guides/wf_03_prime_workflows.md"
    "docs/guides/wf_04_ask_workflows.md"
    "docs/guides/wf_04_research_mcp_guide.md"
    "docs/guides/wf_04_research_output_formats.md"
    "docs/guides/wf_04_research_workflows.md"
    "docs/guides/wf_05_code_doc_sync_guide.md"
    "docs/guides/wf_05_code_serena_guide.md"
    "docs/guides/wf_05_code_workflows.md"
    "docs/guides/wf_06_debug_workflows.md"
    "docs/guides/wf_07_test_workflows.md"
    "docs/guides/wf_08_review_doc_compliance.md"
    "docs/guides/wf_08_review_parallel.md"
    "docs/guides/wf_08_review_process.md"
    "docs/guides/wf_08_review_self_check.md"
    "docs/guides/wf_08_review_serena_guide.md"
    "docs/guides/wf_08_review_workflows.md"
    "docs/guides/wf_11_commit_workflows.md"
)

# Example documents - required by wf_14_doc.md (always installed)
# ‚ö†Ô∏è  CRITICAL: These examples are referenced by wf_14_doc command
#     Must be installed for document generation functionality
declare -ga EXAMPLE_FILES=(
    # Core examples (wf_14_doc)
    "docs/examples/wf_14_doc_examples.md"
    "docs/examples/doc_generation_workflow.md"
    "docs/examples/doc_generation_outputs.md"
    "docs/examples/doc_generation_best_practices.md"
    "docs/examples/doc_generation_next_steps.md"
    "docs/examples/doc_generation_troubleshooting.md"
    "docs/examples/doc_generation_decision_tree.md"
    "docs/examples/doc_generation_quick_guide.md"
    "docs/examples/frontmatter_quick_reference.md"

    # Agent coordination examples (Phase 4)
    "docs/examples/agent_coordination_examples.md"
    "docs/examples/agent_coordinator_usage.md"

    # Doc loader examples (ÊñáÊ°£ËØªÂèñ‰ºòÂåñ)
    "docs/examples/doc_loader_quick_ref.md"
    "docs/examples/doc_loader_usage.md"

    # Multi-Agent Review examples (wf_08_review Âπ∂Ë°åÂÆ°Êü•)
    "docs/examples/multi_agent_review_overview.md"
    "docs/examples/multi_agent_review_tips.md"
    "docs/examples/multi_agent_review_case1_api_refactor.md"
    "docs/examples/multi_agent_review_case2_database_migration.md"
    "docs/examples/multi_agent_review_case3_security.md"
    "docs/examples/multi_agent_review_case4_performance.md"

    # Parallel Execution examples (Âπ∂Ë°åÊâßË°åÊ®°Âºè)
    "docs/examples/parallel_execution_overview.md"
    "docs/examples/parallel_execution_tips.md"
    "docs/examples/parallel_execution_case1_logging.md"
    "docs/examples/parallel_execution_case2_component_refactor.md"
    "docs/examples/parallel_execution_case3_api_batch.md"
    "docs/examples/parallel_execution_case4_test_update.md"

    # Parallel Review examples (Âπ∂Ë°å‰ª£Á†ÅÂÆ°Êü•)
    "docs/examples/parallel_review_overview.md"
    "docs/examples/parallel_review_tips.md"
    "docs/examples/parallel_review_case1_multifile.md"
    "docs/examples/parallel_review_case2_refactoring.md"
    "docs/examples/parallel_review_case3_test_coverage.md"
    "docs/examples/parallel_review_case4_doc_sync.md"

    # Workflow integration
    "docs/examples/wf_integration_example.md"

    # Document templates
    "docs/examples/doc_templates/README_template.md"
    "docs/examples/doc_templates/API_template.md"
    "docs/examples/doc_templates/ARCHITECTURE_template.md"
    "docs/examples/doc_templates/DEV_GUIDE_template.md"
    "docs/examples/doc_templates/DEPLOYMENT_template.md"

    # UI-enhanced templates
    "docs/examples/doc_templates/ui_enhanced/API_explorer_template.md"
    "docs/examples/doc_templates/ui_enhanced/ARCHITECTURE_diagram_template.md"
    "docs/examples/doc_templates/ui_enhanced/DEV_wizard_template.md"
    "docs/examples/doc_templates/ui_enhanced/UI_COST_ANALYSIS.md"
)

# Reference documents - required by multiple commands (always installed)
# ‚ö†Ô∏è  CRITICAL: These references are cited by command files
#     Must be installed for proper command functionality
declare -ga REFERENCE_FILES=(
    "docs/reference/FRONTMATTER.md"
    "docs/reference/AI_ROLES_LIBRARY.md"
    "docs/reference/MARKDOWN_STYLE.md"
)

# Commands library files - required by coordination engine (always installed)
# ‚ö†Ô∏è  CRITICAL: These Python libraries are used by commands for advanced features
#     Must be installed for agent coordination and DocLoader functionality
declare -ga COMMANDS_LIB_FILES=(
    "commands/lib/agent_coordinator.py"
    "commands/lib/agent_registry.py"
    "commands/lib/agent_router.py"
    "commands/lib/auto_activation_demo.py"
    "commands/lib/coordination_engine.py"
    "commands/lib/doc_loader.py"
    "commands/lib/mcp_optimizer.py"
    "commands/lib/mcp_selector.py"
    "commands/lib/task_analyzer.py"
)

# Commands agent definition files - agent personas (always installed)
# ‚ö†Ô∏è  CRITICAL: These define agent behaviors for multi-agent coordination
#     Must be installed for agent-based workflows
declare -ga COMMANDS_AGENTS_FILES=(
    "commands/agents/architect_agent.md"
    "commands/agents/code_agent.md"
    "commands/agents/context_agent.md"
    "commands/agents/debug_agent.md"
    "commands/agents/doc_agent.md"
    "commands/agents/pm_agent.md"
    "commands/agents/refactor_agent.md"
    "commands/agents/research_agent.md"
    "commands/agents/review_agent.md"
    "commands/agents/test_agent.md"
)

# Source MCP module - MCP Gateway implementation (always installed)
# ‚ö†Ô∏è  CRITICAL: All wf_*.md commands use "from src.mcp.gateway import get_mcp_gateway"
#     Must be installed for MCP functionality to work
declare -ga SRC_MCP_FILES=(
    "src/mcp/__init__.py"
    "src/mcp/gateway.py"
    "src/mcp/serena_manager.py"
    "src/mcp/example_usage.py"
)

# ============================================================================
# Installation Directories - Paths for installation targets
# ============================================================================

# These are derived from environment variables for flexibility
INSTALL_DIR="${HOME}/.claude"
COMMANDS_DIR="${INSTALL_DIR}/commands"
SCRIPTS_DIR="${COMMANDS_DIR}/scripts"
DOCS_DIR="${INSTALL_DIR}/docs"
BACKUP_DIR="${INSTALL_DIR}/backup"

# ============================================================================
# Validation Functions
# ============================================================================

# Verify manifest consistency
validate_manifest() {
    local errors=0

    echo "üìã Validating installation manifest..."

    # Check if arrays are defined
    if [[ -z "${COMMAND_FILES[*]}" ]]; then
        echo "‚ùå COMMAND_FILES is empty"
        ((errors++))
    fi

    if [[ -z "${CONFIG_FILES[*]}" ]]; then
        echo "‚ùå CONFIG_FILES is empty"
        ((errors++))
    fi

    if [[ -z "${SCRIPT_FILES[*]}" ]]; then
        echo "‚ùå SCRIPT_FILES is empty"
        ((errors++))
    fi

    if [[ -z "${GUIDE_FILES[*]}" ]]; then
        echo "‚ùå GUIDE_FILES is empty"
        ((errors++))
    fi

    if [[ -z "${EXAMPLE_FILES[*]}" ]]; then
        echo "‚ùå EXAMPLE_FILES is empty"
        ((errors++))
    fi

    if [[ -z "${REFERENCE_FILES[*]}" ]]; then
        echo "‚ùå REFERENCE_FILES is empty"
        ((errors++))
    fi

    if [[ -z "${COMMANDS_LIB_FILES[*]}" ]]; then
        echo "‚ùå COMMANDS_LIB_FILES is empty"
        ((errors++))
    fi

    if [[ -z "${COMMANDS_AGENTS_FILES[*]}" ]]; then
        echo "‚ùå COMMANDS_AGENTS_FILES is empty"
        ((errors++))
    fi

    if [[ -z "${SRC_MCP_FILES[*]}" ]]; then
        echo "‚ùå SRC_MCP_FILES is empty"
        ((errors++))
    fi

    if [[ $errors -eq 0 ]]; then
        echo "‚úÖ Manifest validation passed"
        return 0
    else
        echo "‚ùå Manifest validation failed ($errors errors)"
        return 1
    fi
}

# Print manifest summary
print_manifest_summary() {
    echo ""
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
    echo "Installation Manifest Summary"
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
    echo ""
    echo "üìã Files to be installed:"
    echo "  Commands:       ${COMMAND_FILES[*]}"
    echo "  Config files:   ${CONFIG_FILES[*]}"
    echo "  Scripts:        ${SCRIPT_FILES[*]}"
    echo "  Guides:         ${#GUIDE_FILES[@]} files (docs/guides/)"
    echo "  Examples:       ${#EXAMPLE_FILES[@]} files (docs/examples/)"
    echo "  References:     ${#REFERENCE_FILES[@]} files (docs/reference/)"
    echo "  Commands lib:   ${#COMMANDS_LIB_FILES[@]} files (commands/lib/)"
    echo "  Commands agents: ${#COMMANDS_AGENTS_FILES[@]} files (commands/agents/)"
    echo "  MCP source:     ${#SRC_MCP_FILES[@]} files (src/mcp/)"
    if [[ -n "${DOC_FILES[*]}" ]]; then
        echo "  Documentation:  ${DOC_FILES[*]}"
    fi
    echo ""
    echo "üìÅ Target directories:"
    echo "  Commands:  $COMMANDS_DIR"
    echo "  Scripts:   $SCRIPTS_DIR"
    echo "  Guides:    $COMMANDS_DIR/docs/guides/"
    echo "  Examples:  $COMMANDS_DIR/docs/examples/"
    echo "  References: $COMMANDS_DIR/docs/reference/"
    echo "  Docs:      $DOCS_DIR"
    echo "  Backup:    $BACKUP_DIR"
    echo ""
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
    echo ""
}

# ============================================================================
# Export declarations for use in sourced scripts
# ============================================================================

export INSTALL_DIR COMMANDS_DIR SCRIPTS_DIR DOCS_DIR BACKUP_DIR
export COMMAND_FILES CONFIG_FILES SCRIPT_FILES DOC_FILES GUIDE_FILES EXAMPLE_FILES REFERENCE_FILES
export COMMANDS_LIB_FILES COMMANDS_AGENTS_FILES SRC_MCP_FILES

# Export functions
export -f validate_manifest print_manifest_summary
